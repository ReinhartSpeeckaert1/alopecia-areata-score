<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Alopecia Areata Calculator</title>
<style>
    body {
      font-family: "Segoe UI", "Helvetica Neue", sans-serif;
      padding: 20px;
      background: linear-gradient(to bottom, #f0f0f0, #dcdcdc);
      margin: 0;
    }

    .area-container, .density-container {
      justify-content: center;
      display: flex;
      gap: 4px;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .area-box:hover {
      transform: scale(1.05);
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
    }

    .area-box {
  will-change: transform, box-shadow;
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
      width: 60px;
      height: 60px;
      border: 2px solid #ccc;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      background-color: white;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    .area-box.selected {
      transform: scale(1.12);
      box-shadow: 0 0 20px rgba(0, 119, 204, 0.5);
      background-color: rgba(179, 217, 255, 0.8);
      border-color: #0077cc;
    }

    .plus:hover, .minus:hover {
      transform: scale(2.0);
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);
    }

    .plus, .minus {
      transition: transform 0.2s;
      border: 1px solid #888;
      position: absolute;
      font-weight: bold;
      cursor: pointer;
      background-color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      text-align: center;
      line-height: 18px;
      font-size: 14px;
    }

    .plus {
      top: 2px;
      right: 2px;
    }

    .minus {
      top: 2px;
      left: 2px;
    }

    .density-container button {
      padding: 5px 10px;
      border: 2px solid #ccc;
      background-color: white;
      cursor: pointer;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      min-width: 40px;
      min-height: 30px;
    }

    .density-container button.selected {
      background-color: rgba(179, 255, 179, 0.8);
      border-color: #00aa00;
      box-shadow: 0 0 20px rgba(0, 170, 0, 0.7);
    }

    #result {
      font-size: 18px;
      font-weight: bold;
    }
  
    .tooltip {
      position: absolute;
      top: -25px;
      background-color: transparent;
      color: black;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 18px;
      white-space: nowrap;
      z-index: 10;
      pointer-events: none;
    }

    /* Custom row heights for different sections */
    
    /* Scalp sections */
    #backside-areas .area-box {
  will-change: transform, box-shadow; height: 340px; width: 100px; }
    #topside-areas .area-box {
  will-change: transform, box-shadow; height: 340px; width: 100px; }
    #leftside-areas .area-box {
  will-change: transform, box-shadow; height: 340px; width: 100px; }
    #rightside-areas .area-box {
  will-change: transform, box-shadow; height: 340px; width: 100px; }
    
    /* Eyebrow sections */
    #right-eyebrow-areas .area-box {
  will-change: transform, box-shadow; height: 48px; width: 160px; }
    #left-eyebrow-areas .area-box {
  will-change: transform, box-shadow; height: 48px; width: 160px; }
    
    /* Eyelash sections */
    #right-eyelash-areas .area-box {
  will-change: transform, box-shadow; height: 84px; width: 160px; }
    #left-eyelash-areas .area-box {
  will-change: transform, box-shadow; height: 84px; width: 160px; }
    
    /* Beard sections */
    #right-beard-areas .area-box {
  will-change: transform, box-shadow; height: 138px; width: 120px; }
    #left-beard-areas .area-box {
  will-change: transform, box-shadow; height: 138px; width: 120px; }
    #central-beard-areas .area-box {
  will-change: transform, box-shadow; height: 136.8px; width: 120px; }
    
    /* Density button customization */
    #backside-density button { width: 50px; height: 35px; }
    #topside-density button { width: 50px; height: 35px; }
    #leftside-density button { width: 50px; height: 35px; }
    #rightside-density button { width: 50px; height: 35px; }
    #right-beard-density button { width: 45px; height: 40px; }
    #left-beard-density button { width: 45px; height: 40px; }
    #central-beard-density button { width: 45px; height: 40px; }

    /* Individual box identification for background Images */
    
    /* Backside scalp boxes */
    #backside-areas .area-box:nth-child(1) { background-Image: url('Images/backside-0.jpg'); }
    #backside-areas .area-box:nth-child(2) { background-Image: url('Images/backside-05.jpg'); }
    #backside-areas .area-box:nth-child(3) { background-Image: url('Images/backside-1.jpg'); }
    #backside-areas .area-box:nth-child(4) { background-Image: url('Images/backside-4.jpg'); }
    #backside-areas .area-box:nth-child(5) { background-Image: url('Images/backside-7.jpg'); }
    #backside-areas .area-box:nth-child(6) { background-Image: url('Images/backside-10.jpg'); }
    #backside-areas .area-box:nth-child(7) { background-Image: url('Images/backside-13.jpg'); }
    #backside-areas .area-box:nth-child(8) { background-Image: url('Images/backside-16.jpg'); }
    #backside-areas .area-box:nth-child(9) { background-Image: url('Images/backside-19.jpg'); }
    #backside-areas .area-box:nth-child(10) { background-Image: url('Images/backside-22.jpg'); }
    #backside-areas .area-box:nth-child(11) { background-Image: url('Images/backside-24.jpg'); }
    
    /* Topside scalp boxes */
    #topside-areas .area-box:nth-child(1) { background-Image: url('Images/topside-0.jpg'); }
    #topside-areas .area-box:nth-child(2) { background-Image: url('Images/topside-05.jpg'); }
    #topside-areas .area-box:nth-child(3) { background-Image: url('Images/topside-1.jpg'); }
    #topside-areas .area-box:nth-child(4) { background-Image: url('Images/topside-4.jpg'); }
    #topside-areas .area-box:nth-child(5) { background-Image: url('Images/topside-7.jpg'); }
    #topside-areas .area-box:nth-child(6) { background-Image: url('Images/topside-10.jpg'); }
    #topside-areas .area-box:nth-child(7) { background-Image: url('Images/topside-13.jpg'); }
    #topside-areas .area-box:nth-child(8) { background-Image: url('Images/topside-16.jpg'); }
    #topside-areas .area-box:nth-child(9) { background-Image: url('Images/topside-19.jpg'); }
    #topside-areas .area-box:nth-child(10) { background-Image: url('Images/topside-22.jpg'); }
    #topside-areas .area-box:nth-child(11) { background-Image: url('Images/topside-25.jpg'); }
    #topside-areas .area-box:nth-child(12) { background-Image: url('Images/topside-28.jpg'); }
    #topside-areas .area-box:nth-child(13) { background-Image: url('Images/topside-31.jpg'); }
    #topside-areas .area-box:nth-child(14) { background-Image: url('Images/topside-34.jpg'); }
    #topside-areas .area-box:nth-child(15) { background-Image: url('Images/topside-37.jpg'); }
    #topside-areas .area-box:nth-child(16) { background-Image: url('Images/topside-39.jpg'); }
    
    /* Leftside scalp boxes */
    #leftside-areas .area-box:nth-child(1) { background-Image: url('Images/leftside-0.jpg'); }
    #leftside-areas .area-box:nth-child(2) { background-Image: url('Images/leftside-05.jpg'); }
    #leftside-areas .area-box:nth-child(3) { background-Image: url('Images/leftside-1.jpg'); }
    #leftside-areas .area-box:nth-child(4) { background-Image: url('Images/leftside-2.jpg'); }
    #leftside-areas .area-box:nth-child(5) { background-Image: url('Images/leftside-5.jpg'); }
    #leftside-areas .area-box:nth-child(6) { background-Image: url('Images/leftside-8.jpg'); }
    #leftside-areas .area-box:nth-child(7) { background-Image: url('Images/leftside-11.jpg'); }
    #leftside-areas .area-box:nth-child(8) { background-Image: url('Images/leftside-14.jpg'); }
    #leftside-areas .area-box:nth-child(9) { background-Image: url('Images/leftside-17.jpg'); }
    
    /* Rightside scalp boxes */
    #rightside-areas .area-box:nth-child(1) { background-Image: url('Images/rightside-0.jpg'); }
    #rightside-areas .area-box:nth-child(2) { background-Image: url('Images/rightside-05.jpg'); }
    #rightside-areas .area-box:nth-child(3) { background-Image: url('Images/rightside-1.jpg'); }
    #rightside-areas .area-box:nth-child(4) { background-Image: url('Images/rightside-2.jpg'); }
    #rightside-areas .area-box:nth-child(5) { background-Image: url('Images/rightside-5.jpg'); }
    #rightside-areas .area-box:nth-child(6) { background-Image: url('Images/rightside-8.jpg'); }
    #rightside-areas .area-box:nth-child(7) { background-Image: url('Images/rightside-11.jpg'); }
    #rightside-areas .area-box:nth-child(8) { background-Image: url('Images/rightside-14.jpg'); }
    #rightside-areas .area-box:nth-child(9) { background-Image: url('Images/rightside-17.jpg'); }
    
    /* Eyebrow boxes */
    #right-eyebrow-areas .area-box:nth-child(1) { background-Image: url('Images/right-eyebrow-0.jpg'); }
    #right-eyebrow-areas .area-box:nth-child(2) { background-Image: url('Images/right-eyebrow-025.jpg'); }
    #right-eyebrow-areas .area-box:nth-child(3) { background-Image: url('Images/right-eyebrow-5.jpg'); }
    #right-eyebrow-areas .area-box:nth-child(4) { background-Image: url('Images/right-eyebrow-15.jpg'); }
    #right-eyebrow-areas .area-box:nth-child(5) { background-Image: url('Images/right-eyebrow-25.jpg'); }
    #right-eyebrow-areas .area-box:nth-child(6) { background-Image: url('Images/right-eyebrow-35.jpg'); }
    #right-eyebrow-areas .area-box:nth-child(7) { background-Image: url('Images/right-eyebrow-45.jpg'); }
    
    #left-eyebrow-areas .area-box:nth-child(1) { background-Image: url('Images/left-eyebrow-0.jpg'); }
    #left-eyebrow-areas .area-box:nth-child(2) { background-Image: url('Images/left-eyebrow-025.jpg'); }
    #left-eyebrow-areas .area-box:nth-child(3) { background-Image: url('Images/left-eyebrow-5.jpg'); }
    #left-eyebrow-areas .area-box:nth-child(4) { background-Image: url('Images/left-eyebrow-15.jpg'); }
    #left-eyebrow-areas .area-box:nth-child(5) { background-Image: url('Images/left-eyebrow-25.jpg'); }
    #left-eyebrow-areas .area-box:nth-child(6) { background-Image: url('Images/left-eyebrow-35.jpg'); }
    #left-eyebrow-areas .area-box:nth-child(7) { background-Image: url('Images/left-eyebrow-45.jpg'); }
    
    /* Eyelash boxes */
    #right-eyelash-areas .area-box:nth-child(1) { background-Image: url('Images/right-eyelash-0.jpg'); }
    #right-eyelash-areas .area-box:nth-child(2) { background-Image: url('Images/right-eyelash-025.jpg'); }
    #right-eyelash-areas .area-box:nth-child(3) { background-Image: url('Images/right-eyelash-5.jpg'); }
    #right-eyelash-areas .area-box:nth-child(4) { background-Image: url('Images/right-eyelash-15.jpg'); }
    #right-eyelash-areas .area-box:nth-child(5) { background-Image: url('Images/right-eyelash-25.jpg'); }
    #right-eyelash-areas .area-box:nth-child(6) { background-Image: url('Images/right-eyelash-35.jpg'); }
    #right-eyelash-areas .area-box:nth-child(7) { background-Image: url('Images/right-eyelash-45.jpg'); }
    
    #left-eyelash-areas .area-box:nth-child(1) { background-Image: url('Images/left-eyelash-0.jpg'); }
    #left-eyelash-areas .area-box:nth-child(2) { background-Image: url('Images/left-eyelash-025.jpg'); }
    #left-eyelash-areas .area-box:nth-child(3) { background-Image: url('Images/left-eyelash-5.jpg'); }
    #left-eyelash-areas .area-box:nth-child(4) { background-Image: url('Images/left-eyelash-15.jpg'); }
    #left-eyelash-areas .area-box:nth-child(5) { background-Image: url('Images/left-eyelash-25.jpg'); }
    #left-eyelash-areas .area-box:nth-child(6) { background-Image: url('Images/left-eyelash-35.jpg'); }
    #left-eyelash-areas .area-box:nth-child(7) { background-Image: url('Images/left-eyelash-45.jpg'); }
    
    /* Beard boxes */
    #right-beard-areas .area-box:nth-child(1) { background-Image: url('Images/right-beard-0.jpg'); }
    #right-beard-areas .area-box:nth-child(2) { background-Image: url('Images/right-beard-1.jpg'); }
    #right-beard-areas .area-box:nth-child(3) { background-Image: url('Images/right-beard-4.jpg'); }
    #right-beard-areas .area-box:nth-child(4) { background-Image: url('Images/right-beard-10.jpg'); }
    #right-beard-areas .area-box:nth-child(5) { background-Image: url('Images/right-beard-16.jpg'); }
    #right-beard-areas .area-box:nth-child(6) { background-Image: url('Images/right-beard-224.jpg'); }
    #right-beard-areas .area-box:nth-child(7) { background-Image: url('Images/right-beard-28.jpg'); }
    #right-beard-areas .area-box:nth-child(8) { background-Image: url('Images/right-beard-344.jpg'); }
    #right-beard-areas .area-box:nth-child(9) { background-Image: url('Images/right-beard-40.jpg'); }
    
    #left-beard-areas .area-box:nth-child(1) { background-Image: url('Images/left-beard-0.jpg'); }
    #left-beard-areas .area-box:nth-child(2) { background-Image: url('Images/left-beard-1.jpg'); }
    #left-beard-areas .area-box:nth-child(3) { background-Image: url('Images/left-beard-4.jpg'); }
    #left-beard-areas .area-box:nth-child(4) { background-Image: url('Images/left-beard-10.jpg'); }
    #left-beard-areas .area-box:nth-child(5) { background-Image: url('Images/left-beard-16.jpg'); }
    #left-beard-areas .area-box:nth-child(6) { background-Image: url('Images/left-beard-224.jpg'); }
    #left-beard-areas .area-box:nth-child(7) { background-Image: url('Images/left-beard-28.jpg'); }
    #left-beard-areas .area-box:nth-child(8) { background-Image: url('Images/left-beard-344.jpg'); }
    #left-beard-areas .area-box:nth-child(9) { background-Image: url('Images/left-beard-40.jpg'); }
    
    #central-beard-areas .area-box:nth-child(1) { background-Image: url('Images/central-beard-0.jpg'); }
    #central-beard-areas .area-box:nth-child(2) { background-Image: url('Images/central-beard-05.jpg'); }
    #central-beard-areas .area-box:nth-child(3) { background-Image: url('Images/central-beard-2.jpg'); }
    #central-beard-areas .area-box:nth-child(4) { background-Image: url('Images/central-beard-5.jpg'); }
    #central-beard-areas .area-box:nth-child(5) { background-Image: url('Images/central-beard-8.jpg'); }
    #central-beard-areas .area-box:nth-child(6) { background-Image: url('Images/central-beard-112.jpg'); }
    #central-beard-areas .area-box:nth-child(7) { background-Image: url('Images/central-beard-14.jpg'); }
    #central-beard-areas .area-box:nth-child(8) { background-Image: url('Images/central-beard-172.jpg'); }
    #central-beard-areas .area-box:nth-child(9) { background-Image: url('Images/central-beard-20.jpg'); }
    
    /* Density button background Images */
    #backside-density button:nth-child(2) { background-Image: url('Images/density-0.jpg'); }
    #backside-density button:nth-child(3) { background-Image: url('Images/density-10.jpg'); }
    #backside-density button:nth-child(4) { background-Image: url('Images/density-25.jpg'); }
    #backside-density button:nth-child(5) { background-Image: url('Images/density-50.jpg'); }
    #backside-density button:nth-child(6) { background-Image: url('Images/density-75.jpg'); }
    #backside-density button:nth-child(7) { background-Image: url('Images/density-90.jpg'); }
    
    /* Apply same density Images to all sections */
    #topside-density button:nth-child(2) { background-Image: url('Images/density-0.jpg'); }
    #topside-density button:nth-child(3) { background-Image: url('Images/density-10.jpg'); }
    #topside-density button:nth-child(4) { background-Image: url('Images/density-25.jpg'); }
    #topside-density button:nth-child(5) { background-Image: url('Images/density-50.jpg'); }
    #topside-density button:nth-child(6) { background-Image: url('Images/density-75.jpg'); }
    #topside-density button:nth-child(7) { background-Image: url('Images/density-90.jpg'); }
    
    #leftside-density button:nth-child(2) { background-Image: url('Images/density-0.jpg'); }
    #leftside-density button:nth-child(3) { background-Image: url('Images/density-10.jpg'); }
    #leftside-density button:nth-child(4) { background-Image: url('Images/density-25.jpg'); }
    #leftside-density button:nth-child(5) { background-Image: url('Images/density-50.jpg'); }
    #leftside-density button:nth-child(6) { background-Image: url('Images/density-75.jpg'); }
    #leftside-density button:nth-child(7) { background-Image: url('Images/density-90.jpg'); }
    
    #rightside-density button:nth-child(2) { background-Image: url('Images/density-0.jpg'); }
    #rightside-density button:nth-child(3) { background-Image: url('Images/density-10.jpg'); }
    #rightside-density button:nth-child(4) { background-Image: url('Images/density-25.jpg'); }
    #rightside-density button:nth-child(5) { background-Image: url('Images/density-50.jpg'); }
    #rightside-density button:nth-child(6) { background-Image: url('Images/density-75.jpg'); }
    #rightside-density button:nth-child(7) { background-Image: url('Images/density-90.jpg'); }
    
    #right-beard-density button:nth-child(2) { background-Image: url('Images/density-0.jpg'); }
    #right-beard-density button:nth-child(3) { background-Image: url('Images/density-10.jpg'); }
    #right-beard-density button:nth-child(4) { background-Image: url('Images/density-25.jpg'); }
    #right-beard-density button:nth-child(5) { background-Image: url('Images/density-50.jpg'); }
    #right-beard-density button:nth-child(6) { background-Image: url('Images/density-75.jpg'); }
    #right-beard-density button:nth-child(7) { background-Image: url('Images/density-90.jpg'); }
    
    #left-beard-density button:nth-child(2) { background-Image: url('Images/density-0.jpg'); }
    #left-beard-density button:nth-child(3) { background-Image: url('Images/density-10.jpg'); }
    #left-beard-density button:nth-child(4) { background-Image: url('Images/density-25.jpg'); }
    #left-beard-density button:nth-child(5) { background-Image: url('Images/density-50.jpg'); }
    #left-beard-density button:nth-child(6) { background-Image: url('Images/density-75.jpg'); }
    #left-beard-density button:nth-child(7) { background-Image: url('Images/density-90.jpg'); }
    
    #central-beard-density button:nth-child(2) { background-Image: url('Images/density-0.jpg'); }
    #central-beard-density button:nth-child(3) { background-Image: url('Images/density-10.jpg'); }
    #central-beard-density button:nth-child(4) { background-Image: url('Images/density-25.jpg'); }
    #central-beard-density button:nth-child(5) { background-Image: url('Images/density-50.jpg'); }
    #central-beard-density button:nth-child(6) { background-Image: url('Images/density-75.jpg'); }
    #central-beard-density button:nth-child(7) { background-Image: url('Images/density-90.jpg'); }
    
    
.density-container button:nth-child(2) { background-Image: url('Images/density-0.jpg'); }
.density-container button:nth-child(3) { background-Image: url('Images/density-10.jpg'); }
.density-container button:nth-child(4) { background-Image: url('Images/density-25.jpg'); }
.density-container button:nth-child(5) { background-Image: url('Images/density-50.jpg'); }
.density-container button:nth-child(6) { background-Image: url('Images/density-75.jpg'); }
.density-container button:nth-child(7) { background-Image: url('Images/density-90.jpg'); }

.plus.glow {
  box-shadow: 0 0 6px 3px #00ff00; /* Green glow */
}

.minus.glow {
  box-shadow: 0 0 6px 3px #ff0000; /* Red glow */
}


.area-box.selected {
  z-index: 10;
}


.title-banner {
  background-color: #0077cc;
  color: white;
  padding: 15px;
  text-align: center;
  margin-bottom: 20px;
  border-radius: 8px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.title-banner h2 {
  margin: 0;
  font-size: 24px;
  font-weight: normal;
}


.help-icon {
  display: inline-block;
  background-color: white;
  color: black;
  border-radius: 50%;
  border: 1px solid #999;
  width: 18px;
  height: 18px;
  font-size: 14px;
  font-weight: bold;
  text-align: center;
  line-height: 18px;
  cursor: pointer;
  position: relative;
  margin-left: 5px;
}

.help-tooltip {
  position: absolute;
  top: 22px;
  left: 0;
  background-color: white;
  border: 1px solid #ccc;
  padding: 6px 10px;
  font-size: 14px;
  border-radius: 6px;
  white-space: nowrap;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  display: none;
  z-index: 1000;
}


  .help-box {
    width: 220px;
    height: 140px;
    background-size: cover;
    background-position: center;
    border: 2px solid #aaa;
    border-radius: 8px;
    padding: 10px;
    font-size: 14px;
    color: #000;
    position: absolute;
    top: 22px;
    left: 0;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    display: none;
  }


#results-summary {
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
    margin: 10px 0 20px 0;
}

.result-box {
    font-size: 14px;
    padding: 6px 10px;
    border-radius: 6px;
    font-weight: bold;
    min-width: 100px;
    text-align: center;
    color: black;
}

#floating-preview {
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;

  position: fixed;
  top: 20px;
  right: 20px;
  width: 200px;
  max-height: 300px;
  overflow-y: auto;
  background-color: rgba(255, 255, 255, 0.95);
  border: 2px solid #0077cc;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  padding: 8px;
  display: none;
  z-index: 9999;
}


/* --- Added: Ring meters + enhanced banner + total gauge --- */
.title-banner {
  background: linear-gradient(135deg, #0ea5e9, #2563eb);
  position: relative;
  overflow: visible;
}
.title-banner::after{
  content: "";
  position: absolute;
  inset: -40% -20%;
  background: radial-gradient(circle at 20% 20%, rgba(255,255,255,.2), transparent 50%),
              radial-gradient(circle at 80% 0%, rgba(255,255,255,.15), transparent 50%);
  pointer-events: none;
}
.title-sub {
  font-size: 13px;
  opacity: .9;
  margin-top: 4px;
}
#score-rings {
  display:flex;
  gap:14px;
  justify-content:center;
  flex-wrap:wrap;
  margin: 6px 0 16px 0;
}
.ring {
  width: 90px;
  height: 90px;
  border-radius: 50%;
  background: conic-gradient(#22c55e 0% 0%, #e5e7eb 0%);
  display:grid;
  place-items:center;
  position: relative;
  box-shadow: 0 4px 10px rgba(0,0,0,.08);
}
.ring::before {
  content:"";
  position:absolute;
  width: 68px;
  height: 68px;
  background: white;
  border-radius: 50%;
}
.ring-label, .ring-val {
  position: absolute;
  text-align:center;
  pointer-events:none;
}
.ring-val { font-weight: 700; font-size: 16px; }
.ring-label { bottom: -20px; font-size: 12px; color:#374151; width: 100%; }
#result {
  background: white;
  border-radius: 10px;
  padding: 10px 14px;
  display:inline-block;
  margin: 12px auto;
  border: 1px solid #e5e7eb;
  box-shadow: 0 6px 16px rgba(2,132,199,.1);
}
#scalp-progress {
  height: 8px;
  width: 280px;
  max-width: 90vw;
  background: #eef2ff;
  border-radius: 999px;
  overflow: hidden;
  margin: 8px auto 0 auto;
  border: 1px solid #e5e7eb;
}
#scalp-progress > div {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, #22c55e, #ef4444);
  transition: width .25s ease;
}
/* --- End Added CSS --- */


/* Scalp progress scale */
#scalp-scale { width: 280px; max-width: 90vw; margin: 6px auto 0 auto; }
#scalp-scale .ticks {
  height: 8px;
  background:
    linear-gradient(to right, transparent, transparent),
    repeating-linear-gradient(
      to right,
      #bdbdbd,
      #bdbdbd 1px,
      transparent 1px,
      transparent 10%
    );
  border-radius: 3px;
}
#scalp-scale .labels {
  display: flex;
  justify-content: space-between;
  font-size: 10px;
  color: #666;
  margin-top: 2px;
  line-height: 1;
}
#scalp-scale .labels span { white-space: nowrap; }
.pdf-top-right { position:absolute; top:6px; right:8px; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<!-- Preload all beard Images -->
<link as="Image" fetchpriority="high" href="Images/left-beard-0.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/left-beard-1.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/left-beard-4.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/left-beard-10.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/left-beard-16.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/left-beard-224.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/left-beard-28.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/left-beard-344.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/left-beard-40.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/right-beard-0.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/right-beard-1.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/right-beard-4.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/right-beard-10.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/right-beard-16.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/right-beard-224.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/right-beard-28.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/right-beard-344.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/right-beard-40.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/central-beard-0.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/central-beard-05.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/central-beard-2.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/central-beard-5.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/central-beard-8.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/central-beard-112.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/central-beard-14.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/central-beard-172.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/central-beard-20.jpg" rel="preload"/>
<!-- Preload key eyebrow Images -->
<link as="Image" fetchpriority="high" href="Images/left-eyebrow-0.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/left-eyebrow-15.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/right-eyebrow-0.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/right-eyebrow-15.jpg" rel="preload"/>
<!-- Preload key eyelash Images -->
<link as="Image" fetchpriority="high" href="Images/left-eyelash-0.jpg" rel="preload"/>
<link as="Image" fetchpriority="high" href="Images/right-eyelash-0.jpg" rel="preload"/>
<style>
  /* Keep #results-summary for layout/preview, hide only its original inner text background */
  #results-summary {
    background: none !important;
    box-shadow: none !important;
    padding: 0 !important;
    font-size: 0 !important;
  }
  #results-summary > * { display: none !important; }
.pdf-top-right { position:absolute; top:6px; right:8px; }
</style>
<style>
  /* Visually collapse banner but keep contents in DOM (for scripts that depend on them) */
  #results-summary {
    background: none !important;
    box-shadow: none !important;
    padding: 0 !important;
    margin: 0 !important;
    border: none !important;
    max-height: 0 !important;
    overflow: hidden !important;
  }
.pdf-top-right { position:absolute; top:6px; right:8px; }
</style>
<style>
/* --- Fancy ring animations --- */
.ring { will-change: background, transform, box-shadow; }

/* Pulse on update */
@keyframes ring-pop {
  0%   { transform: scale(0.96); box-shadow: 0 4px 10px rgba(0,0,0,.08); }
  50%  { transform: scale(1.04); box-shadow: 0 6px 18px rgba(2,132,199,.20); }
  100% { transform: scale(1);    box-shadow: 0 4px 10px rgba(0,0,0,.08); }
}
.ring.flash { animation: ring-pop 480ms cubic-bezier(.2,.8,.2,1); }

/* Tiny particles that shoot outward from the ring center */
.ring .particle {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: currentColor;
  transform: translate(-50%, -50%);
  opacity: .95;
  pointer-events: none;
  filter: drop-shadow(0 0 4px rgba(0,0,0,.15));
  animation: particle-shoot var(--time, 420ms) ease-out forwards;
}
@keyframes particle-shoot {
  to {
    transform: translate(-50%, -50%) rotate(var(--theta, 0deg)) translate(44px);
    opacity: 0;
  }
}

/* Accessibility */
@media (prefers-reduced-motion: reduce) {
  .ring, .ring.flash, .ring .particle { animation: none !important; transition: none !important; }
}
.pdf-top-right { position:absolute; top:6px; right:8px; }
</style>
<style>
/* --- Floating 'peek' for offscreen ring updates --- */
#ring-peek {
  position: fixed;
  left: 16px;
  top: 16px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 9999;
  pointer-events: none;
}
.peek-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  backdrop-filter: blur(8px);
  background: rgba(255,255,255,0.85);
  border-radius: 14px;
  box-shadow: 0 6px 22px rgba(0,0,0,.12);
  transform: translateY(8px);
  opacity: 0;
  animation: peek-in 240ms cubic-bezier(.2,.8,.2,1) forwards;
  pointer-events: auto;
}
@keyframes peek-in { to { opacity: 1; transform: translateY(0); } }
.peek-item.hide { animation: peek-out 240ms ease forwards; }
@keyframes peek-out { to { opacity: 0; transform: translateY(8px); } }
.peek-title { font: 600 13px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color: #0f172a; }
.peek-value { font: 600 13px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color: #0ea5e9; }
.peek-ring {
  position: relative;
  width: 40px; height: 40px; border-radius: 50%;
  background: conic-gradient(#e5e7eb 0%, #e5e7eb 100%);
  flex: none;
}
.peek-ring::after {
  content: "";
  position: absolute; inset: 6px;
  border-radius: 50%;
  background: white;
}
/* Dark mode friendly-ish */
@media (prefers-color-scheme: dark) {
  .peek-item { background: rgba(15,15,18,0.75); box-shadow: 0 8px 24px rgba(0,0,0,.35); }
  .peek-title { color: #e5e7eb; }
  .peek-ring::after { background: #111827; }
}
@media (prefers-reduced-motion: reduce) {
  #ring-peek, .peek-item { animation: none !important; }
}
.pdf-top-right { position:absolute; top:6px; right:8px; }
</style>
<style>.title-banner { overflow: visible !important; }.pdf-top-right { position:absolute; top:6px; right:8px; }
</style>
<style>
    .btn-primary {
      appearance: none;
      border: none;
      padding: 10px 16px;
      border-radius: 9999px;
      font-size: 15px;
      line-height: 1;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      transition: transform 0.08s ease, box-shadow 0.2s ease, background-color 0.2s ease;
      background: linear-gradient(to bottom right, #4f46e5, #06b6d4);
      color: #fff;
    }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 10px 22px rgba(0,0,0,0.16); }
    .btn-primary:active { transform: translateY(0); box-shadow: 0 2px 8px rgba(0,0,0,0.18); }
    #codeInput {
      padding: 10px 12px;
      min-width: 320px;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      font-size: 14px;
    }
    .pdf-top-right { position:absolute; top:6px; right:8px; }
</style><style>
    .btn-blue {
      appearance: none;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 15px;
      cursor: pointer;
      background-color: #bfdbfe;
      color: #1e3a8a;
      transition: background-color 0.2s ease, transform 0.08s ease;
    }
    .btn-blue:hover {
      background-color: #93c5fd;
      transform: translateY(-1px);
    }
    .btn-blue:active {
      background-color: #60a5fa;
      transform: translateY(0);
    }
    .pdf-top-right { position:absolute; top:6px; right:8px; }
</style>






<style id="aga-selected-style">
/* Strong visual marker for selected AGA option */
#androgenetic-areas .area-box.selected {
  border-color: #0077cc !important;
  border-width: 4px !important;
  box-shadow: 0 0 14px rgba(0, 119, 204, 0.6) !important;
  background-color: rgba(179, 217, 255, 0.85) !important;
}
.pdf-top-right { position:absolute; top:6px; right:8px; }
</style>



<style>
/* Override size for androgenetic alopecia boxes only */
#androgenetic-areas .area-box {
  width: 110px !important;
  height: 260px !important;
}
.pdf-top-right { position:absolute; top:6px; right:8px; }
</style>

<style>
  .aga-help-wrap:hover #aga-help-float { display: block !important; }
.pdf-top-right { position:absolute; top:6px; right:8px; }
</style>


<style>
#androgenetic-areas .plus.glow {
  outline: 3px solid #28a745; /* green */
  box-shadow: 0 0 0 3px rgba(40,167,69,0.35);
  border-radius: 6px;
}
#androgenetic-areas .minus.glow {
  outline: 3px solid #dc3545; /* red */
  box-shadow: 0 0 0 3px rgba(220,53,69,0.35);
  border-radius: 6px;
}
.pdf-top-right { position:absolute; top:6px; right:8px; }
</style>

</head>
<body>
<style>
@media (max-width: 1200px) {
  #floating-preview, #floating-close-btn {
    display: none !important;
  }
}
.pdf-top-right { position:absolute; top:6px; right:8px; }
</style>
<div class="title-banner" style="position: relative;"><div style="position: absolute; top: 5px; left: 10px;">
<span class="help-icon" onmouseenter="showTooltip(this, 'Click on the Images, + or - to indicate the Images that best fit with the EXTENT of the alopecia areata.')" onmouseleave="hideTooltip(this)">?</span>
</div>
<div style="position: absolute; bottom: 5px; right: 10px; font-size: 12px; color: white; opacity: 0.8;">
    © Reinhart Speeckaert, Nanja van Geel
  </div>
<h2 id="main-title">Alopecia areata calculator</h2>
<div class="title-sub">Select the options that best fit with the extent of alopecia areata</div>
</div>
<div id="pdf-icon-container" style="display: none; text-align: right; margin-bottom: 8px;">
<button id="generate-pdf" style="color: red; font-weight: bold;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 18px;
        color: red;
    " title="Download PDF">
        📄 PDF
    </button>
</div><div id="selected-preview" style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 20px;"></div>
<div id="results-summary" style="padding: 10px; font-size: 18px; background: #e0f0ff; border-radius: 8px; box-shadow: 0 0 5px #ccc;">
<!-- Results will be populated here -->
</div>
<div id="score-rings">
<div class="ring" id="ring-scalp"><span class="ring-val" id="ring-val-scalp">0%</span><span class="ring-label">Scalp</span></div>
<div class="ring" id="ring-eyebrows"><span class="ring-val" id="ring-val-eyebrows">0%</span><span class="ring-label">Eyebrows</span></div>
<div class="ring" id="ring-eyelashes"><span class="ring-val" id="ring-val-eyelashes">0%</span><span class="ring-label">Eyelashes</span></div>
<div class="ring" id="ring-beard" ><span class="ring-val" id="ring-val-beard">0%</span><span class="ring-label">Beard</span></div>
</div>
<div style="text-align: right; margin-top: -10px; margin-bottom: 10px;">
<button id="reset-button" style="background: none; border: none; cursor: pointer; font-size: 20px; color: #0077cc;" title="Reset Page">🔄 Reset</button></div>
<div style="display: flex; justify-content: space-between; align-items: center;">
</div>
<div class="area-container" id="areaContainer"></div>

<!-- Androgenetic toggle -->
<div id="aga-toggle-container" style="display: none;"></div>
<div id="aga-ui-wrapper" style="display: none; flex-direction: column; gap: 6px;">
  
  <h3 style="display:flex; align-items:center; gap:8px; margin-bottom: 6px; position: relative;">
    <span>Androgenetic alopecia</span>
    <span class="aga-help-wrap" style="position: relative; display: inline-block;">
      <span id="aga-help" 
            style="cursor: pointer; font-weight: bold; border: 1px solid #ccc; border-radius: 50%; 
                   width: 18px; height: 18px; display: inline-flex; align-items: center; 
                   justify-content: center; background-color: white;" 
            title="Help">?</span>
      <div id="aga-help-float" 
           style="display:none; position: absolute; left: 26px; top: 0; 
                  background: white; border: 1px solid #999; 
                  box-shadow: 0 4px 16px rgba(0,0,0,0.2); padding: 8px; z-index: 100;">
        <img src="Androgenetichelp.jpg" alt="Androgenetic alopecia help" style="max-width: 360px; height: auto;">
      </div>
    </span>
  </h3>

  
<div style="display: flex; justify-content: space-between; align-items: center;">
<div></div>
<div class="density-container" id="androgenetic-density"><label>Hair Density:<span class="help-icon" onmouseenter="showTooltip(this, 'Mark the density of hairs in the androgenetic area')" onmouseleave="hideTooltip(this)">?</span></label><button data-density="0" class="selected"></button><button data-density="10"></button><button data-density="25"></button><button data-density="50"></button><button data-density="75"></button><button data-density="90"></button></div>
</div>
<div class="area-container" id="androgenetic-areas" style="margin-top: 6px;"></div>
  <div id="androgenetic-score" style="font-weight: 600; text-align: right; margin-top: 4px;">Androgenetic alopecia score: 0%</div>
</div>
<div id="result" style="text-align: center; margin: 10px 0; font-size: 20px; font-weight: bold;">Total Scalp Alopecia Areata: 0%</div><div id="scalp-progress"><div></div></div>
<div aria-hidden="true" id="scalp-scale">
<div class="ticks"></div>
<div class="labels">
<span>0%</span>
<span>10%</span>
<span>20%</span>
<span>30%</span>
<span>40%</span>
<span>50%</span>
<span>60%</span>
<span>70%</span>
<span>80%</span>
<span>90%</span>
<span>100%</span>
</div>
</div>
<script>

function getColorForPercentage(pct) {
  pct = Math.min(100, Math.max(0, pct));
  const r = pct < 50 ? Math.floor(255 * (pct / 50)) : 255;
  const g = pct < 50 ? 255 : Math.floor(255 * (1 - (pct - 50) / 50));
  const a = 0.8; // alpha = 100% opacity
  return `rgba(${r},${g},0,${a})`;
}

</script>
<script>
const topsideTooltips = ["0%", "1.25%", "2.5%", "10%", "17%", "25%", "32.5%", "40%", "47.5%", "55%", "62.5%", "70%", "77.5%", "85%", "92.5%", "97.5%"];
const topsideMinusTooltips = ["0.5%", "2%", "7.5%", "15%", "22.5%", "30%", "37.5%", "45%", "52.5%", "60%", "67.5%", "75", "82.5%", "90", "96%"];
const topsidePlusTooltips = ["1.7%", "5%", "12.5%", "20%", "27.5%", "35%", "42.5%", "50%", "57.5%", "65%", "72.5%", "80%", "87.5%","95%", "100%"];

const leftsideTooltips = ["0%", "3%", "5%", "10%", "25%", "45%", "60%", "75%", "95%"];
const leftsideMinusTooltips = ["1%", "4.5%", "9%", "20%", "40%", "55%", "70%", "90%"];
const leftsidePlusTooltips = ["4%", "7.5%", "15%", "30%", "50%", "65%", "85%", "100%"];

const rightsideTooltips = [...leftsideTooltips];
const rightsideMinusTooltips = [...leftsideMinusTooltips];
const rightsidePlusTooltips = [...leftsidePlusTooltips];


const scalpSections = {
  backside: {
    id: "backside",
    areas: [
      { label: "", value: 0 },
      { label: "", value: 0.5, minus: 0.25, plus: 0.67 },
      { label: "", value: 1, minus: 0.83, plus: 2 },
      { label: "", value: 4, minus: 3, plus: 5 },
      { label: "", value: 7, minus: 6, plus: 8 },
      { label: "", value: 10, minus: 9, plus: 11 },
      { label: "", value: 13, minus: 12, plus: 14 },
      { label: "", value: 16, minus: 15, plus: 17 },
      { label: "", value: 19, minus: 18, plus: 20 },
      { label: "", value: 22, minus: 21, plus: 23 },
      { label: "", value: 24 }
    ]
  },
  leftside: {
    id: "leftside",
    areas: [
      { label: "", value: 0 },
      { label: "", value: 0.5, minus: 0.25, plus: 0.67 },
      { label: "", value: 1, minus: 0.83, plus: 1.33 },
      { label: "", value: 2, minus: 1.67, plus: 3 },
      { label: "", value: 5, minus: 4, plus: 6 },
      { label: "", value: 8, minus: 7, plus: 9 },
      { label: "", value: 11, minus: 10, plus: 12 },
      { label: "", value: 14, minus: 13, plus: 15 },
      { label: "", value: 17, minus: 16, plus: 18 }
    ]
  },
  rightside: {
    id: "rightside",
    areas: [
      { label: "", value: 0 },
      { label: "", value: 0.5, minus: 0.25, plus: 0.67 },
      { label: "", value: 1, minus: 0.83, plus: 1.33 },
      { label: "", value: 2, minus: 1.67, plus: 3 },
      { label: "", value: 5, minus: 4, plus: 6 },
      { label: "", value: 8, minus: 7, plus: 9 },
      { label: "", value: 11, minus: 10, plus: 12 },
      { label: "", value: 14, minus: 13, plus: 15 },
      { label: "", value: 17, minus: 16, plus: 18 }
    ]
  },
  topside: {
    id: "topside",
    areas: [
      { label: "", value: 0 },
      { label: "", value: 0.5, minus: 0.25, plus: 0.7 },
      { label: "", value: 1, minus: 0.8, plus: 2 },
      { label: "", value: 4, minus: 3, plus: 5 },
      { label: "", value: 7, minus: 6, plus: 8 },
      { label: "", value: 10, minus: 9, plus: 11 },
      { label: "", value: 13, minus: 12, plus: 14 },
      { label: "", value: 16, minus: 15, plus: 17 },
      { label: "", value: 19, minus: 18, plus: 20 },
      { label: "", value: 22, minus: 21, plus: 23 },
      { label: "", value: 25, minus: 24, plus: 26 },
      { label: "", value: 28, minus: 27, plus: 29 },
      { label: "", value: 31, minus: 30, plus: 32 },
      { label: "", value: 34, minus: 33, plus: 35 },
      { label: "", value: 37, minus: 36, plus: 37.3 },
      { label: "", value: 39, minus: 38.3, plus: 40 }
    ]
  }
};

const totalResultDiv = document.getElementById("result");
let globalSelections = {};

function renderScalpSection(section) {
  const container = document.createElement('div');
  container.innerHTML = `
    <h3>${
  section.id === "backside" ? "Back of the scalp" :
  section.id === "leftside" ? "Left side of the scalp" :
  section.id === "rightside" ? "Right side of the scalp" :
  section.id === "topside" ? "Top of the scalp" :
  section.id
}</h3>
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div></div>
      <div class="density-container" id="${section.id}-density">
        <label>Hair Density:<span class="help-icon" onmouseenter="showTooltip(this, 'Mark the density of hairs in the alopecia areata patches')" onmouseleave="hideTooltip(this)">?</span></label>
        <button data-density="0" class="selected"></button>
        <button data-density="10"></button>
        <button data-density="25"></button>
        <button data-density="50"></button>
        <button data-density="75"></button>
        <button data-density="90"></button>
      </div>
    </div>
    <div class="area-container" id="${section.id}-areas"></div>
  `;
  
  if (section.id === "backside") {
    const previewDiv = document.getElementById("selected-preview");
    document.body.insertBefore(previewDiv, totalResultDiv);
  }
  document.body.insertBefore(container, totalResultDiv);


  const areaBox = container.querySelector(`#${section.id}-areas`);
  globalSelections[section.id] = { selected: new Set(), density: 0 };

  section.areas.forEach(area => {
    const box = document.createElement("div");
    box.className = "area-box";
    box.innerText = area.label;
    box.dataset.value = area.value;

    if (area.minus !== undefined) {
      const minus = document.createElement("div");
      minus.className = "minus";
      minus.innerText = "−";
      minus.title = `${area.minus}%`;
      minus.onclick = (e) => {
        e.stopPropagation();
        toggleScalpSelection(section.id, area.minus);
      };
      box.appendChild(minus);
    }

    if (area.plus !== undefined) {
      const plus = document.createElement("div");
      plus.className = "plus";
      plus.innerText = "+";
      plus.title = `${area.plus}%`;
      plus.onclick = (e) => {
        e.stopPropagation();
        toggleScalpSelection(section.id, area.plus);
      };
      box.appendChild(plus);
    }

    box.onclick = () => {
      toggleScalpSelection(section.id, area.value);
    };

    areaBox.appendChild(box);
  });

  container.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", () => {
      globalSelections[section.id].density = parseInt(btn.dataset.density);
      container.querySelectorAll("button").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      updateScalpUI();
    });
  });
}


function toggleScalpSelection(sectionId, value) {
  const selection = globalSelections[sectionId];
  const valueStr = value.toString();
  const alreadySelected = Array.from(selection.selected).some(v => v.toString() === valueStr);
  if (alreadySelected) {
    selection.selected.forEach(v => {
      if (v.toString() === valueStr) selection.selected.delete(v);
    });
  } else {
    selection.selected.clear();
    selection.selected.add(value);
  }
  updateScalpUI();
}
function updateScalpUI() {
  // Keep preview update as before
  setTimeout(updateSelectedPreview, 0);

  // 1) Restore per-section box highlighting and +/- glow (non-AGA sections)
  if (typeof globalSelections === 'object' && globalSelections) {
    for (const [sectionId, data] of Object.entries(globalSelections)) {
      const boxEls = document.querySelectorAll(`#${sectionId}-areas .area-box`);
      boxEls.forEach(box => {
        const val = parseFloat(box.dataset.value);
        const isSelected = data.selected && data.selected.has(val);

        const plusEl = box.querySelector(".plus");
        const minusEl = box.querySelector(".minus");
        const plusVal = plusEl ? parseFloat(plusEl.title) : null;
        const minusVal = minusEl ? parseFloat(minusEl.title) : null;
        const isPlusSelected = plusVal !== null && data.selected && data.selected.has(plusVal);
        const isMinusSelected = minusVal !== null && data.selected && data.selected.has(minusVal);

        // Visual state
        box.classList.toggle("selected", !!(isSelected || isPlusSelected || isMinusSelected));

        if (plusEl) {
          const on = !!isPlusSelected;
          plusEl.style.backgroundColor = on ? "#ccffcc" : "white";
          plusEl.style.transform = on ? "scale(1.3)" : "scale(1)";
          plusEl.classList.toggle("glow", on);
        }
        if (minusEl) {
          const on = !!isMinusSelected;
          minusEl.style.backgroundColor = on ? "#ffcccc" : "white";
          minusEl.style.transform = on ? "scale(1.3)" : "scale(1)";
          minusEl.classList.toggle("glow", on);
        }
      });
    }
  }

  // 2) Unified scalp total to match ring, with clamping
  let scalpPct = 0;
  try {
    const totals = (typeof calculateSectionTotals === 'function') ? calculateSectionTotals() : null;
    scalpPct = totals && totals.Scalp != null ? Number(totals.Scalp) : 0;
  } catch (e) { scalpPct = 0; }
  if (!Number.isFinite(scalpPct)) scalpPct = 0;
  scalpPct = Math.max(0, Math.min(100, scalpPct));

  const titleElement = document.getElementById("main-title");
  const totalResultDiv = document.getElementById("result");
  if (totalResultDiv) totalResultDiv.innerText = `Total Scalp Alopecia Areata: ${scalpPct.toFixed(1)}%`;
  if (titleElement) titleElement.textContent = `Alopecia areata calculator: Scalp (=${scalpPct.toFixed(1)}%)`;

  // 3) Maintain AGA tooltip persistence after UI refresh
  try { if (typeof refreshAgaTooltip === 'function') refreshAgaTooltip(); } catch(e){}
}

Object.values(scalpSections).forEach(renderScalpSection);
// Insert co-occuring AGA toggle just under Top of the scalp and above total result
(function setupAgaToggle(){
  // Find the Top of the scalp header container
  const topsideHeader = [...document.querySelectorAll('h3')].find(h => h.textContent.trim().toLowerCase() === 'top of the scalp');
  const toggle = document.createElement('div');
  toggle.id = 'aga-toggle';
  toggle.style = 'display:flex; align-items:center; gap:8px; margin: 6px 0;';
  toggle.innerHTML = `
    <label style="display:flex; align-items:center; gap:6px; font-weight:600;">
      <input type="checkbox" id="aga-checkbox" />
      <span>Co-occuring androgenetic alopecia?</span>
    </label>
  `;
  const resultEl = document.getElementById('result');
  if (resultEl) {
    resultEl.parentNode.insertBefore(toggle, resultEl);
  }
  // Wire the floating help
  const helpBtn = document.getElementById('aga-help');
  const helpFloat = document.getElementById('aga-help-float');
  if (helpBtn && helpFloat) {
    helpBtn.addEventListener('mouseenter', () => helpFloat.style.display = 'block');
    helpBtn.addEventListener('mouseleave', () => helpFloat.style.display = 'none');
    helpFloat.addEventListener('mouseenter', () => helpFloat.style.display = 'block');
    helpFloat.addEventListener('mouseleave', () => helpFloat.style.display = 'none');
  }
  const agaUI = document.getElementById('aga-ui-wrapper');
  toggle.addEventListener('change', (e) => {
    const checked = document.getElementById('aga-checkbox').checked;
    agaUI.style.display = checked ? 'flex' : 'none';
    updateScalpUI();
  });
  // Move the ui wrapper to sit just above the result
  const uiWrapper = document.getElementById('aga-ui-wrapper');
  if (resultEl && uiWrapper) {
    resultEl.parentNode.insertBefore(uiWrapper, resultEl);
  }
})();

// Define androgenetic section
const androgeneticSection = {
  id: 'androgenetic',
  areas: [
    { label: '', value: 0 },
    { label: '', value: 5, minus: 2.5, plus: 6.7 },
    { label: '', value: 10, minus: 8.3, plus: 15 },
    { label: '', value: 25, minus: 20, plus: 30 },
    { label: '', value: 40, minus: 35, plus: 45 },
    { label: '', value: 55, minus: 50, plus: 60 },
    { label: '', value: 70, minus: 65, plus: 75 },
    { label: '', value: 85, minus: 80, plus: 94 },
    { label: '', value: 100, minus: 97 }
  ],
  images: [
    'Images/Androgenetisch0.jpg',
    'Images/Androgenetisch5.jpg',
    'Images/Androgenetisch10.jpg',
    'Images/Androgenetisch25.jpg',
    'Images/Androgenetisch40.jpg',
    'Images/Androgenetisch55.jpg',
    'Images/Androgenetisch70.jpg',
    'Images/Androgenetisch85.jpg',
    'Images/Androgenetisch100.jpg'
  ],
  tooltips: ['0%', '5%', '10%', '25%', '40%', '55%', '70%', '85%', '100%'],
  minusTips: [null, '2.5%', '8.3%', '20%', '35%', '50%', '65%', '80%', '97%'],
  plusTips:  [null, '6.7%', '15%', '30%', '45%', '60%', '75%', '94%', null]
};

// Render androgenetic boxes inside dedicated container
(function renderAndrogenetic(){
  const container = document.getElementById('androgenetic-areas');
  if (!container) return;
  globalSelections['androgenetic'] = { selected: new Set(), density: 0 };
  androgeneticSection.areas.forEach((area, i) => {
    const box = document.createElement('div');
    box.className = 'area-box';
    box.dataset.value = area.value;
    box.style.backgroundImage = `url(${androgeneticSection.images[i]})`;
    // optional plus/minus for middle boxes
    if (area.plus !== undefined) {
      const plus = document.createElement('div');
      plus.className = 'plus';
      plus.innerText = '+';
      plus.title = `${area.plus}%`;
      plus.onclick = (e) => { e.stopPropagation(); setAndrogeneticSelection(i, area.plus); };
      box.appendChild(plus);
    }
    if (area.minus !== undefined) {
      const minus = document.createElement('div');
      minus.className = 'minus';
      minus.innerText = '−';
      minus.title = `${area.minus}%`;
      minus.onclick = (e) => { e.stopPropagation(); setAndrogeneticSelection(i, area.minus); };
      box.appendChild(minus);
    }
    // clicking the main box selects its main value
    box.onclick = () => setAndrogeneticSelection(i, area.value);
    container.appendChild(box);
  });

  // Wire density buttons for androgenetic section
  (function(){
    const droot = document.getElementById('androgenetic-density');
    if (droot) {
      droot.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          if (!globalSelections['androgenetic']) globalSelections['androgenetic'] = { selected: new Set(), density: 0 };
          globalSelections['androgenetic'].density = parseInt(btn.dataset.density||'0', 10);
          droot.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          
          // Also refresh the AGA score text to reflect density immediately
          try {
            const scoreEl = document.getElementById('androgenetic-score');
            const A = typeof window.androgeneticScore === 'number' ? window.androgeneticScore : 0;
            const densNow = (globalSelections['androgenetic'] && globalSelections['androgenetic'].density) ? globalSelections['androgenetic'].density : 0;
            const AEffNow = Math.max(0, Math.min(100, A * (1 - densNow/100)));
            if (scoreEl) scoreEl.textContent = `Androgenetic alopecia score: ${AEffNow.toFixed(1)}%`;
          } catch(e) {}
    if (typeof updateScalpUI === 'function') updateScalpUI();
        });
      });
    }
  })();

  // Apply visual tooltips consistent with other sections
  const tips = androgeneticSection.tooltips;
  const minusTips = androgeneticSection.minusTips;
  const plusTips = androgeneticSection.plusTips;
  const boxes = container.querySelectorAll('.area-box');
  boxes.forEach((box, i) => {
    // main tip
    const tip = createTooltip(tips[i]);
    box.appendChild(tip);
    tip.dataset.role = 'main';
    tip.style.display = 'none';
    function showTip(){ if (!box.querySelector('.plus.glow') && !box.querySelector('.minus.glow')) tip.style.display='block'; }
    function hideTip() { if (!box.classList.contains('selected')) tip.style.display = 'none'; }
    box.addEventListener('mouseenter', showTip);
    box.addEventListener('mouseleave', hideTip);
    box.addEventListener('click', () => {
      container.querySelectorAll('.tooltip').forEach(t => t.style.display = 'none');
      tip.style.display = 'block';
    });
    // minus tip
    const minus = box.querySelector('.minus');
    if (minus && minusTips[i]) {
      const mtip = createTooltip(minusTips[i]);
      box.appendChild(mtip);
      mtip.dataset.role = 'minus';
      mtip.style.display = 'none';
      minus.addEventListener('mouseenter', () => { mtip.style.display = 'block'; });
      minus.addEventListener('mouseleave', () => { mtip.style.display = minus.classList.contains('glow') ? 'block' : 'none'; if (window.refreshAgaTooltip) window.refreshAgaTooltip(); });
      minus.addEventListener('click', () => {
        container.querySelectorAll('.tooltip').forEach(t => t.style.display = 'none');
        // highlight minus and the box
        container.querySelectorAll('.plus, .minus').forEach(el => el.classList.remove('glow'));
        minus.classList.add('glow');
        box.classList.add('selected');
        mtip.style.display = 'block';
        if (window.refreshAgaTooltip) window.refreshAgaTooltip();
      });
    }
    // plus tip
    const plus = box.querySelector('.plus');
    if (plus && plusTips[i]) {
      const ptip = createTooltip(plusTips[i]);
      box.appendChild(ptip);
      ptip.dataset.role = 'plus';
      ptip.style.display = 'none';
      plus.addEventListener('mouseenter', () => { ptip.style.display = 'block'; });
      plus.addEventListener('mouseleave', () => { ptip.style.display = plus.classList.contains('glow') ? 'block' : 'none'; if (window.refreshAgaTooltip) window.refreshAgaTooltip(); });
      plus.addEventListener('click', () => {
        container.querySelectorAll('.tooltip').forEach(t => t.style.display = 'none');
        // highlight plus and the box
        container.querySelectorAll('.plus, .minus').forEach(el => el.classList.remove('glow'));
        plus.classList.add('glow');
        box.classList.add('selected');
        ptip.style.display = 'block';
        if (window.refreshAgaTooltip) window.refreshAgaTooltip();
      });
    }
  });
})();


function setAndrogeneticSelection(idx, val) {
  const container = document.getElementById('androgenetic-areas');
  if (!container) return;
  const boxes = container.querySelectorAll('.area-box');

  // clear previous selection visuals
  boxes.forEach(b => {
    b.classList.remove('selected');
    b.querySelectorAll('.tooltip').forEach(t => t.style.display = 'none');
  });

  // mark the clicked box and add persistent label
  const target = boxes[idx];
  if (target) {
    // remove glow on all +/- in all boxes
    boxes.forEach(b => { b.querySelectorAll('.plus, .minus').forEach(el => el.classList.remove('glow')); });
    // decide which role this value represents
    const v = parseFloat(val);
    const p = target.querySelector('.plus');
    const m = target.querySelector('.minus');
    let role = 'main';
    if (p && !isNaN(v) && parseFloat(p.title) === v) { role = 'plus'; p.classList.add('glow'); }
    else if (m && !isNaN(v) && parseFloat(m.title) === v) { role = 'minus'; m.classList.add('glow'); }

    target.classList.add('selected');// reveal that box's main tooltip (first tooltip child, if any)
    let show = target.querySelector('.tooltip[data-role="'+role+'"]');
    if (!show) show = target.querySelector('.tooltip');
    if (show) show.style.display = 'block';
  }


  // sync with globalSelections so updateScalpUI keeps the highlight
  if (typeof globalSelections !== 'undefined') {
    if (!globalSelections['androgenetic']) {
      globalSelections['androgenetic'] = { selected: new Set(), density: 0 };
    }
    // best-effort: find the currently targeted box from idx
    (function(){
      const container = document.getElementById('androgenetic-areas');
      if (!container) return;
      const boxes = container.querySelectorAll('.area-box');
      const target = boxes[idx];
      const baseVal = target ? parseFloat(target.dataset.value) : 0;
      if (parseFloat(val) > 0) {
        globalSelections['androgenetic'].selected = new Set([baseVal]);
      } else {
        globalSelections['androgenetic'].selected = new Set();
      }
    })();
  }

  // store numeric score and reflect in UI

  window.androgeneticScore = parseFloat(val) || 0;
  const scoreEl = document.getElementById('androgenetic-score');
  const dens = (globalSelections['androgenetic'] && globalSelections['androgenetic'].density) ? globalSelections['androgenetic'].density : 0;
  const AEffDisp = Math.max(0, Math.min(100, window.androgeneticScore * (1 - dens/100)));
  if (scoreEl) scoreEl.textContent = `Androgenetic alopecia score: ${AEffDisp.toFixed(1)}%`;

  updateScalpUI();
}

// Keep old name as wrapper for any existing calls
function setAndrogeneticScore(val) {
  // Do not select the 0-picture when A==0 from Load score
  if (val <= 0) {
    try {
      if (!globalSelections['androgenetic']) globalSelections['androgenetic'] = { selected: new Set(), density: 0 };
      globalSelections['androgenetic'].selected = new Set();
      window.androgeneticScore = 0;
      const scoreEl = document.getElementById('androgenetic-score');
      const dens = (globalSelections['androgenetic'] && globalSelections['androgenetic'].density) ? globalSelections['androgenetic'].density : 0;
      const AEff = Math.max(0, Math.min(100, window.androgeneticScore * (1 - dens/100)));
      if (scoreEl) scoreEl.textContent = `Androgenetic alopecia score: ${AEff.toFixed(1)}%`;
      // remove highlight from any previously selected androgenetic box
      const boxes = document.querySelectorAll('#androgenetic-areas .area-box');
      boxes.forEach(b => b.classList.remove('selected'));
      if (typeof updateScalpUI === 'function') updateScalpUI();
    } catch(e) {}
    return;
  }

  const baseValues = [0,5,10,25,40,55,70,85,100];
  let idx = 0, best = Infinity;
  baseValues.forEach((v, i) => {
    const d = Math.abs(v - val);
    if (d < best) { best = d; idx = i; }
  });
  setAndrogeneticSelection(idx, val);
}

// removed legacy patch


// Add tooltips to backside section elements
const backsideValues = [0, 0.5, 1, 4, 7, 10, 13, 16, 19, 22, 24];
const backsideTooltips = ["0%", "2%", "5%", "15%", "30%", "40%", "55%", "65%", "80%", "90%", "100%"];
const minusTooltips = ["1%", "3.5%", "12.5%", "25%", "37.5%", "50%", "62.5%", "75%", "87.5%"];
const plusTooltips = ["2.5%", "10%", "20%", "35%", "45%", "60%", "70%", "85%", "95%"];


function createTooltip(text) {
  const tip = document.createElement("div");
  tip.className = "tooltip";
  tip.innerText = text;
  const match = text.match(/(\d+(\.\d+)?)/);
  if (match) {
    const value = parseFloat(match[1]);
    tip.style.backgroundColor = getColorForPercentage(value);
  }
  return tip;
}

function applyTooltips() {
  const boxes = document.querySelectorAll("#backside-areas .area-box");
  boxes.forEach((box, i) => {
    const percent = backsideTooltips[i];
    const tip = createTooltip(percent);
    box.appendChild(tip);
    tip.style.display = "none";

    function showTip() {
      tip.style.display = "block";
    }

    function hideTip() {
      if (!box.classList.contains("selected")) {
        tip.style.display = "none";
      }
    }

    box.addEventListener("mouseenter", showTip);
    box.addEventListener("mouseleave", hideTip);
    box.addEventListener("click", () => {
      document.querySelectorAll("#backside-areas .tooltip").forEach(t => t.style.display = "none");
      tip.style.display = "block";
    });

    const minus = box.querySelector(".minus");
    if (minus && minusTooltips[i - 1]) {
      const minusTip = createTooltip(minusTooltips[i - 1]);
      box.appendChild(minusTip);
      minusTip.style.display = "none";

      minus.addEventListener("mouseenter", () => {
        if (!globalSelections['backside'].selected.has(parseFloat(minus.title))) {
          minusTip.style.display = "block";
        }
      });
      minus.addEventListener("mouseleave", () => {
        if (!globalSelections['backside'].selected.has(parseFloat(minus.title))) {
          minusTip.style.display = "none";
        }
      });
      minus.addEventListener("click", () => {
        document.querySelectorAll("#backside-areas .tooltip").forEach(t => t.style.display = "none");
        minusTip.style.display = "block";
      });
    }

    const plus = box.querySelector(".plus");
    if (plus && plusTooltips[i - 1]) {
      const plusTip = createTooltip(plusTooltips[i - 1]);
      box.appendChild(plusTip);
      plusTip.style.display = "none";

      plus.addEventListener("mouseenter", () => {
        if (!globalSelections['backside'].selected.has(parseFloat(plus.title))) {
          plusTip.style.display = "block";
        }
      });
      plus.addEventListener("mouseleave", () => {
        if (!globalSelections['backside'].selected.has(parseFloat(plus.title))) {
          plusTip.style.display = "none";
        }
      });
      plus.addEventListener("click", () => {
        document.querySelectorAll("#backside-areas .tooltip").forEach(t => t.style.display = "none");
        plusTip.style.display = "block";
      });
    }
  });
}


function applyTooltipsToSection(sectionId, areaTooltips, minusTooltips, plusTooltips) {
  const boxes = document.querySelectorAll(`#${sectionId}-areas .area-box`);
  boxes.forEach((box, i) => {
    const percent = areaTooltips[i];
    const tip = createTooltip(percent);
    box.appendChild(tip);
    tip.style.display = "none";

    function showTip() {
      tip.style.display = "block";
    }

    function hideTip() {
      if (!box.classList.contains("selected")) {
        tip.style.display = "none";
      }
    }

    box.addEventListener("mouseenter", showTip);
    box.addEventListener("mouseleave", hideTip);
    box.addEventListener("click", () => {
      document.querySelectorAll(`#${sectionId}-areas .tooltip`).forEach(t => t.style.display = "none");
      tip.style.display = "block";
    });

    const minus = box.querySelector(".minus");
    if (minus && minusTooltips[i - 1]) {
      const minusTip = createTooltip(minusTooltips[i - 1]);
      box.appendChild(minusTip);
      minusTip.style.display = "none";

      minus.addEventListener("mouseenter", () => {
        if (!globalSelections[sectionId].selected.has(parseFloat(minus.title))) {
          minusTip.style.display = "block";
        }
      });
      minus.addEventListener("mouseleave", () => {
        if (!globalSelections[sectionId].selected.has(parseFloat(minus.title))) {
          minusTip.style.display = "none";
        }
      });
      minus.addEventListener("click", () => {
        document.querySelectorAll(`#${sectionId}-areas .tooltip`).forEach(t => t.style.display = "none");
        minusTip.style.display = "block";
      });
    }

    const plus = box.querySelector(".plus");
    if (plus && plusTooltips[i - 1]) {
      const plusTip = createTooltip(plusTooltips[i - 1]);
      box.appendChild(plusTip);
      plusTip.style.display = "none";

      plus.addEventListener("mouseenter", () => {
        if (!globalSelections[sectionId].selected.has(parseFloat(plus.title))) {
          plusTip.style.display = "block";
        }
      });
      plus.addEventListener("mouseleave", () => {
        if (!globalSelections[sectionId].selected.has(parseFloat(plus.title))) {
          plusTip.style.display = "none";
        }
      });
      plus.addEventListener("click", () => {
        document.querySelectorAll(`#${sectionId}-areas .tooltip`).forEach(t => t.style.display = "none");
        plusTip.style.display = "block";
      });
    }
  });
}

window.addEventListener("DOMContentLoaded", function() {
  applyTooltips();
  applyTooltipsToSection("topside", topsideTooltips, topsideMinusTooltips, topsidePlusTooltips);
  applyTooltipsToSection("leftside", leftsideTooltips, leftsideMinusTooltips, leftsidePlusTooltips);
  applyTooltipsToSection("rightside", rightsideTooltips, rightsideMinusTooltips, rightsidePlusTooltips);
});
</script>
<!-- Eyebrow Section -->
<h3 id="eyebrow-title" style="margin-bottom: 5px;">Eyebrows (0.00%)</h3>
<div style="display: flex; flex-direction: column; align-items: center; gap: 0px;">
<div>
<h4 style="text-align: center; margin-bottom: 0px;">Right Eyebrow</h4>
<div class="area-container" id="right-eyebrow-areas"></div>
</div>
<div>
<h4 style="text-align: center; margin-bottom: 0px;">Left Eyebrow</h4>
<div class="area-container" id="left-eyebrow-areas"></div>
</div>
</div>
<script>
const eyebrowAreas = [
  { label: "", value: 0 },
  { label: "", value: 2.5, minus: 1.25, plus: 3.8 },
  { label: "", value: 5, plus: 10 },
  { label: "", value: 15, plus: 20 },
  { label: "", value: 25, plus: 30 },
  { label: "", value: 35, plus: 40 },
  { label: "", value: 45, plus: 50 }
];

let eyebrowSelections = {
  left: new Set(),
  right: new Set()
};

function renderEyebrow(side) {
  const container = document.getElementById(`${side}-eyebrow-areas`);
  eyebrowAreas.forEach(area => {
    const box = document.createElement("div");
    box.className = "area-box";
    box.innerText = area.label;
    box.dataset.value = area.value;

    if (area.minus !== undefined) {
      const minus = document.createElement("div");
      minus.className = "minus";
      minus.innerText = "−";
      minus.title = `${area.minus}%`;
      minus.onclick = (e) => {
        e.stopPropagation();
        toggleEyebrowSelection(side, area.minus);
      };
      box.appendChild(minus);
    }

    if (area.plus !== undefined) {
      const plus = document.createElement("div");
      plus.className = "plus";
      plus.innerText = "+";
      plus.title = `${area.plus}%`;
      plus.onclick = (e) => {
        e.stopPropagation();
        toggleEyebrowSelection(side, area.plus);
      };
      box.appendChild(plus);
    }

    box.onclick = () => {
      toggleEyebrowSelection(side, area.value);
    };

    container.appendChild(box);
  });
}

function toggleEyebrowSelection(side, value) {
  const val = parseFloat(value);
  const alreadySelected = Array.from(eyebrowSelections[side]).some(v => v === val);
  if (alreadySelected) {
    eyebrowSelections[side].delete(val);
  } else {
    eyebrowSelections[side].clear();
    eyebrowSelections[side].add(val);
  }
  updateEyebrowUI();
}

function updateEyebrowUI() {
  setTimeout(updateSelectedPreview, 0);
  ["left", "right"].forEach(side => {
    const boxEls = document.querySelectorAll(`#${side}-eyebrow-areas .area-box`);
    boxEls.forEach(box => {
      const val = parseFloat(box.dataset.value);
      const isSelected = eyebrowSelections[side].has(val);
      
      const plusEl = box.querySelector(".plus");
      const minusEl = box.querySelector(".minus");
      const plusVal = plusEl ? parseFloat(plusEl.title) : null;
      const minusVal = minusEl ? parseFloat(minusEl.title) : null;
      const isPlusSelected = plusVal !== null && eyebrowSelections[side].has(plusVal);
      const isMinusSelected = minusVal !== null && eyebrowSelections[side].has(minusVal);
      box.classList.toggle("selected", isSelected || isPlusSelected || isMinusSelected);

      if (box.querySelector(".plus")) {
        const plusVal = parseFloat(box.querySelector(".plus").title);
        const isPlusSelected = eyebrowSelections[side].has(plusVal);
        box.querySelector(".plus").style.backgroundColor = isPlusSelected ? "#ccffcc" : "white";
        box.querySelector(".plus").style.transform = isPlusSelected ? "scale(1.3)" : "scale(1)";
        box.querySelector(".plus").classList.toggle("glow", isPlusSelected);
      }
      if (box.querySelector(".minus")) {
        const minusVal = parseFloat(box.querySelector(".minus").title);
        const isMinusSelected = eyebrowSelections[side].has(minusVal);
        box.querySelector(".minus").style.backgroundColor = isMinusSelected ? "#ffcccc" : "white";
        box.querySelector(".minus").style.transform = isMinusSelected ? "scale(1.3)" : "scale(1)";
        box.querySelector(".minus").classList.toggle("glow", isMinusSelected);
      }
    });
  });

  const total = [...eyebrowSelections.left, ...eyebrowSelections.right].reduce((sum, val) => sum + val, 0);
  document.getElementById("eyebrow-title").innerText = `Eyebrows (${total.toFixed(2)}%)`;
}



function updateSelectedPreview() {
  const container = document.getElementById("selected-preview");
  if (!container) return;
  container.innerHTML = "";

  const previews = [];

  document.querySelectorAll(".area-box").forEach(box => {
    const value = parseFloat(box.dataset.value);
    const style = window.getComputedStyle(box);
    const bgImage = style.backgroundImage;
    const match = bgImage.match(/url\(["']?(.*?)["']?\)/);
    if (!match) return;

    const section = box.closest(".area-container");
    if (!section) return;

    const width = box.offsetWidth;
    const height = box.offsetHeight;

    let isMain = box.classList.contains("selected");
    let isPlus = false;
    let isMinus = false;

    const plus = box.querySelector(".plus");
    const minus = box.querySelector(".minus");

    if (plus) {
      if (!isMain && plus.classList.contains("glow")) {
        isPlus = true;
      }
    }

    if (minus) {
      if (!isMain && minus.classList.contains("glow")) {
        isMinus = true;
      }
    }

    if (!(isMain || isPlus || isMinus)) return;

    const previewBox = document.createElement("div");
    previewBox.style.width = width + "px";
    previewBox.style.height = height + "px";
    previewBox.style.backgroundImage = `url('${match[1]}')`;
    previewBox.style.backgroundSize = "cover";
    previewBox.style.backgroundPosition = "center";
    previewBox.style.border = "2px solid #0077cc";
    previewBox.style.borderRadius = "6px";
    previewBox.style.position = "relative";
    previewBox.style.transform = "scale(1)";
    previewBox.style.transformOrigin = "top left";
    previewBox.style.flex = "0 0 auto";

    if (plus && plus.classList.contains("glow")) {
      const plusEl = document.createElement("div");
      plusEl.className = "plus glow";
      plusEl.innerText = "+";
      plusEl.style.position = "absolute";
      plusEl.style.top = "-10px";
      plusEl.style.right = "5px";
      previewBox.appendChild(plusEl);
    }

    if (minus && minus.classList.contains("glow")) {
      const minusEl = document.createElement("div");
      minusEl.className = "minus glow";
      minusEl.innerText = "−";
      minusEl.style.position = "absolute";
      minusEl.style.top = "-10px";
      minusEl.style.left = "5px";
      previewBox.appendChild(minusEl);
    }

    let selectedValue = null;
    if (plus && plus.classList.contains("glow")) {
        selectedValue = parseFloat(plus.title);
    } else if (minus && minus.classList.contains("glow")) {
        selectedValue = parseFloat(minus.title);
    } else if (box.classList.contains("selected")) {
        selectedValue = value;
    }

    if (selectedValue !== null) {
        let density = 0;
        const sectionDiv = box.closest("[id$='-areas']");
        let sectionId = "";
        if (sectionDiv && sectionDiv.id) {
            sectionId = sectionDiv.id.replace("-areas", "");

            if (globalSelections[sectionId]) {
                density = globalSelections[sectionId].density;
            } else if (beardSelections[sectionId]) {
                density = beardSelections[sectionId].density;
            }

            const adjusted = Math.round(selectedValue * (1 - density / 100));

            const infoLabel = document.createElement("div");
            infoLabel.style.position = "absolute";
            infoLabel.style.bottom = "2px";
            infoLabel.style.right = "4px";
            infoLabel.style.fontSize = "13px";
            infoLabel.style.background = "rgba(255,255,255,0.8)";
            infoLabel.style.padding = "2px 4px";
            infoLabel.style.borderRadius = "4px";
            infoLabel.style.boxShadow = "0 0 2px rgba(0,0,0,0.2)";
            infoLabel.innerText = density > 0 ? `${adjusted}%; (Dens:${density}%)` : `${adjusted}%`;
            previewBox.appendChild(infoLabel);
        }

        previews.push({ sectionId, element: previewBox });
    }
  });

  const desiredOrder = [
    "leftside", "backside", "rightside", "topside",
    "right-eyebrow", "left-eyebrow",
    "right-eyelash", "left-eyelash",
    "right-beard", "central-beard", "left-beard"
  ];

  previews.sort((a, b) => {
    return desiredOrder.indexOf(a.sectionId) - desiredOrder.indexOf(b.sectionId);
  });

  previews.forEach(item => container.appendChild(item.element));
}



function updateAllPreviews() {
  setTimeout(updateSelectedPreview, 0);

  const floatingPreview = document.getElementById("floating-preview");
  if (floatingPreview) {
    if (container.children.length > 0) {
      floatingPreview.style.opacity = "1";
      floatingPreview.style.pointerEvents = "auto";
    } else {
      floatingPreview.style.opacity = "0";
      floatingPreview.style.pointerEvents = "none";
    }
  }
}

// Initialize eyebrow UI after DOM loads
window.addEventListener("DOMContentLoaded", function() {
  renderEyebrow("left");
  renderEyebrow("right");
  updateEyebrowUI();
});
</script>
<!-- Eyelash Section -->
<h3 id="eyelash-title" style="margin-bottom: 5px;">Eyelashes (0.00%)</h3>
<div style="display: flex; flex-direction: column; align-items: center; gap: 0px;">
<div>
<h4 style="text-align: center; margin-bottom: 0px;">Right Eyelash</h4>
<div class="area-container" id="right-eyelash-areas"></div>
</div>
<div>
<h4 style="text-align: center; margin-bottom: 0px;">Left Eyelash</h4>
<div class="area-container" id="left-eyelash-areas"></div>
</div>
</div>
<script>
let eyelashSelections = {
  left: new Set(),
  right: new Set()
};

function renderEyelash(side) {
  const container = document.getElementById(`${side}-eyelash-areas`);
  eyebrowAreas.forEach(area => {
    const box = document.createElement("div");
    box.className = "area-box";
    box.innerText = area.label;
    box.dataset.value = area.value;

    if (area.minus !== undefined) {
      const minus = document.createElement("div");
      minus.className = "minus";
      minus.innerText = "−";
      minus.title = `${area.minus}%`;
      minus.onclick = (e) => {
        e.stopPropagation();
        toggleEyelashSelection(side, area.minus);
      };
      box.appendChild(minus);
    }

    if (area.plus !== undefined) {
      const plus = document.createElement("div");
      plus.className = "plus";
      plus.innerText = "+";
      plus.title = `${area.plus}%`;
      plus.onclick = (e) => {
        e.stopPropagation();
        toggleEyelashSelection(side, area.plus);
      };
      box.appendChild(plus);
    }

    box.onclick = () => {
      toggleEyelashSelection(side, area.value);
    };

    container.appendChild(box);
  });
}

function toggleEyelashSelection(side, value) {
  const val = parseFloat(value);
  const alreadySelected = Array.from(eyelashSelections[side]).some(v => v === val);
  if (alreadySelected) {
    eyelashSelections[side].delete(val);
  } else {
    eyelashSelections[side].clear();
    eyelashSelections[side].add(val);
  }
  updateEyelashUI();
}

function updateEyelashUI() {
  setTimeout(updateSelectedPreview, 0);
  ["left", "right"].forEach(side => {
    const boxEls = document.querySelectorAll(`#${side}-eyelash-areas .area-box`);
    boxEls.forEach(box => {
      const val = parseFloat(box.dataset.value);
      const isSelected = eyelashSelections[side].has(val);
      
      const plusEl = box.querySelector(".plus");
      const minusEl = box.querySelector(".minus");
      const plusVal = plusEl ? parseFloat(plusEl.title) : null;
      const minusVal = minusEl ? parseFloat(minusEl.title) : null;
      const isPlusSelected = plusVal !== null && eyelashSelections[side].has(plusVal);
      const isMinusSelected = minusVal !== null && eyelashSelections[side].has(minusVal);
      box.classList.toggle("selected", isSelected || isPlusSelected || isMinusSelected);

      if (box.querySelector(".plus")) {
        const plusVal = parseFloat(box.querySelector(".plus").title);
        const isPlusSelected = eyelashSelections[side].has(plusVal);
        box.querySelector(".plus").style.backgroundColor = isPlusSelected ? "#ccffcc" : "white";
        box.querySelector(".plus").style.transform = isPlusSelected ? "scale(1.3)" : "scale(1)";
        box.querySelector(".plus").classList.toggle("glow", isPlusSelected);
      }
      if (box.querySelector(".minus")) {
        const minusVal = parseFloat(box.querySelector(".minus").title);
        const isMinusSelected = eyelashSelections[side].has(minusVal);
        box.querySelector(".minus").style.backgroundColor = isMinusSelected ? "#ffcccc" : "white";
        box.querySelector(".minus").style.transform = isMinusSelected ? "scale(1.3)" : "scale(1)";
        box.querySelector(".minus").classList.toggle("glow", isMinusSelected);
      }
    });
  });

  const total = [...eyelashSelections.left, ...eyelashSelections.right].reduce((sum, val) => sum + val, 0);
  document.getElementById("eyelash-title").innerText = `Eyelashes (${total.toFixed(2)}%)`;
}

window.addEventListener("DOMContentLoaded", function() {
  renderEyelash("left");
  renderEyelash("right");
  updateEyelashUI();
});
</script>
<!-- Beard Area Section -->
<h3 id="beard-title" style="margin-bottom: 0px;">Beard Area (0.00%)</h3>
<div style="display: flex; flex-direction: column; gap: 0px;">
<!-- Right Beard -->
<div>
<h4 style="text-align: center; margin-bottom: 0px;">Right Beard Area</h4>
<div style="display: flex; justify-content: space-between; align-items: center;">
<div></div>
<div class="density-container" id="right-beard-density">
<label>Hair Density:<span class="help-icon" onmouseenter="showTooltip(this, 'Help window 22')" onmouseleave="hideTooltip(this)">?</span></label>
<button class="selected" data-density="0"></button>
<button data-density="10"></button>
<button data-density="25"></button>
<button data-density="50"></button>
<button data-density="75"></button>
<button data-density="90"></button>
</div>
</div>
<div class="area-container" id="right-beard-areas"></div>
</div>
<!-- Left Beard -->
<div>
<h4 style="text-align: center; margin-bottom: 0px;">Left Beard Area</h4>
<div style="display: flex; justify-content: space-between; align-items: center;">
<div></div>
<div class="density-container" id="left-beard-density">
<label>Hair Density:<span class="help-icon" onmouseenter="showTooltip(this, 'Help window 2')" onmouseleave="hideTooltip(this)">?</span></label>
<button class="selected" data-density="0"></button>
<button data-density="10"></button>
<button data-density="25"></button>
<button data-density="50"></button>
<button data-density="75"></button>
<button data-density="90"></button>
</div>
</div>
<div class="area-container" id="left-beard-areas"></div>
</div>
<!-- Central Beard -->
<div>
<h4 style="text-align: center; margin-bottom: 0px;">Central Beard Area</h4>
<div style="display: flex; justify-content: space-between; align-items: center;">
<div></div>
<div class="density-container" id="central-beard-density">
<label>Hair Density:<span class="help-icon" onmouseenter="showTooltip(this, 'Help window 2')" onmouseleave="hideTooltip(this)">?</span></label>
<button class="selected" data-density="0"></button>
<button data-density="10"></button>
<button data-density="25"></button>
<button data-density="50"></button>
<button data-density="75"></button>
<button data-density="90"></button>
</div>
</div>
<div class="area-container" id="central-beard-areas"></div>
</div>
</div>
<script>
const beardSections = {
  "right-beard": {
    id: "right-beard",
    areas: [
      { label: "", value: 0 },
      { label: "", value: 1, minus: 0.5, plus: 2 },
      { label: "", value: 4, minus: 3, plus: 6 },
      { label: "", value: 10, minus: 8, plus: 12 },
      { label: "", value: 16, minus: 14.4, plus: 18 },
      { label: "", value: 22.4, minus: 20, plus: 24 },
      { label: "", value: 28, minus: 26.4, plus: 30.4 },
      { label: "", value: 34.4, minus: 32, plus: 37 },
      { label: "", value: 40 }
    ]
  },
  "left-beard": {
    id: "left-beard",
    areas: [
      { label: "", value: 0 },
      { label: "", value: 1, minus: 0.5, plus: 2 },
      { label: "", value: 4, minus: 3, plus: 6 },
      { label: "", value: 10, minus: 8, plus: 12 },
      { label: "", value: 16, minus: 14.4, plus: 18 },
      { label: "", value: 22.4, minus: 20, plus: 24 },
      { label: "", value: 28, minus: 26.4, plus: 30.4 },
      { label: "", value: 34.4, minus: 32, plus: 37 },
      { label: "", value: 40 }
    ]
  },
  "central-beard": {
    id: "central-beard",
    areas: [
      { label: "", value: 0 },
      { label: "", value: 0.5, minus: 0.25, plus: 1 },
      { label: "", value: 2, minus: 1.5, plus: 3 },
      { label: "", value: 5, minus: 4, plus: 6 },
      { label: "", value: 8, minus: 7.3, plus: 9 },
      { label: "", value: 11.2, minus: 10, plus: 12 },
      { label: "", value: 14, minus: 13.2, plus: 15.2 },
      { label: "", value: 17.2, minus: 16, plus: 18.5 },
      { label: "", value: 20 }
    ]
  }
};

let beardSelections = {};

function renderBeardSection(section) {
  const container = document.getElementById(`${section.id}-areas`);
  beardSelections[section.id] = { selected: new Set(), density: 0 };

  section.areas.forEach(area => {
    const box = document.createElement("div");
    box.className = "area-box";
    box.innerText = area.label;
    box.dataset.value = area.value;

    if (area.minus !== undefined) {
      const minus = document.createElement("div");
      minus.className = "minus";
      minus.innerText = "−";
      minus.title = `${area.minus}%`;
      minus.onclick = (e) => {
        e.stopPropagation();
        toggleBeardSelection(section.id, area.minus);
      };
      box.appendChild(minus);
    }

    if (area.plus !== undefined) {
      const plus = document.createElement("div");
      plus.className = "plus";
      plus.innerText = "+";
      plus.title = `${area.plus}%`;
      plus.onclick = (e) => {
        e.stopPropagation();
        toggleBeardSelection(section.id, area.plus);
      };
      box.appendChild(plus);
    }

    box.onclick = () => {
      toggleBeardSelection(section.id, area.value);
    };

    container.appendChild(box);
  });

  document.querySelectorAll(`#${section.id}-density button`).forEach(btn => {
    btn.addEventListener("click", () => {
      beardSelections[section.id].density = parseInt(btn.dataset.density);
      document.querySelectorAll(`#${section.id}-density button`).forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      updateBeardUI();
    });
  });
}

function toggleBeardSelection(sectionId, value) {
  const selection = beardSelections[sectionId];
  const val = parseFloat(value);
  const alreadySelected = Array.from(selection.selected).some(v => v === val);
  if (alreadySelected) {
    selection.selected.delete(val);
  } else {
    selection.selected.clear();
    selection.selected.add(val);
  }
  updateBeardUI();
}

function updateBeardUI() {
  setTimeout(updateSelectedPreview, 0);
  let total = 0;
  for (const [sectionId, data] of Object.entries(beardSelections)) {
    const boxEls = document.querySelectorAll(`#${sectionId}-areas .area-box`);
    boxEls.forEach(box => {
      const val = parseFloat(box.dataset.value);
      const isSelected = data.selected.has(val);
      
      const plusEl = box.querySelector(".plus");
      const minusEl = box.querySelector(".minus");
      const plusVal = plusEl ? parseFloat(plusEl.title) : null;
      const minusVal = minusEl ? parseFloat(minusEl.title) : null;
      const isPlusSelected = plusVal !== null && data.selected.has(plusVal);
      const isMinusSelected = minusVal !== null && data.selected.has(minusVal);
      box.classList.toggle("selected", isSelected || isPlusSelected || isMinusSelected);

      if (box.querySelector(".plus")) {
        const plusVal = parseFloat(box.querySelector(".plus").title);
        const isPlusSelected = data.selected.has(plusVal);
        box.querySelector(".plus").style.backgroundColor = isPlusSelected ? "#ccffcc" : "white";
        box.querySelector(".plus").style.transform = isPlusSelected ? "scale(1.3)" : "scale(1)";
        box.querySelector(".plus").classList.toggle("glow", isPlusSelected);
      }
      if (box.querySelector(".minus")) {
        const minusVal = parseFloat(box.querySelector(".minus").title);
        const isMinusSelected = data.selected.has(minusVal);
        box.querySelector(".minus").style.backgroundColor = isMinusSelected ? "#ffcccc" : "white";
        box.querySelector(".minus").style.transform = isMinusSelected ? "scale(1.3)" : "scale(1)";
        box.querySelector(".minus").classList.toggle("glow", isMinusSelected);
      }
    });

    const subtotal = Array.from(data.selected).reduce((sum, val) => sum + val, 0);
    total += subtotal * (1 - data.density / 100);
  }

  document.getElementById("beard-title").innerText = `Beard Area (${total.toFixed(2)}%)`;
}

window.addEventListener("DOMContentLoaded", function() {
  Object.values(beardSections).forEach(renderBeardSection);
});
</script>
<script>
// Utility to create a tooltip
function createTooltip(text) {
  const tip = document.createElement("div");
  tip.className = "tooltip";
  tip.innerText = text;
  const match = text.match(/(\d+(\.\d+)?)/);
  if (match) {
    const value = parseFloat(match[1]);
    tip.style.backgroundColor = getColorForPercentage(value);
  }
  return tip;
}

// Apply tooltips to a custom section
function applyTooltipToBoxes(sectionPrefix, tooltips, minusTooltips = [], plusTooltips = [], selections) {
  const boxes = document.querySelectorAll(`#${sectionPrefix}-areas .area-box`);
  boxes.forEach((box, i) => {
    const tip = createTooltip(tooltips[i]);
    box.appendChild(tip);
    tip.style.display = "none";

    function showTip() { tip.style.display = "block"; }
    function hideTip() {
      if (!box.classList.contains("selected")) tip.style.display = "none";
    }

    box.addEventListener("mouseenter", showTip);
    box.addEventListener("mouseleave", hideTip);
    box.addEventListener("click", () => {
      document.querySelectorAll(`#${sectionPrefix}-areas .tooltip`).forEach(t => t.style.display = "none");
      tip.style.display = "block";
    });

    const minus = box.querySelector(".minus");
    if (minus && minusTooltips[i - 1]) {
      const minusTip = createTooltip(minusTooltips[i - 1]);
      box.appendChild(minusTip);
      minusTip.style.display = "none";

      minus.addEventListener("mouseenter", () => {
        if (!selections.has(parseFloat(minus.title))) minusTip.style.display = "block";
      });
      minus.addEventListener("mouseleave", () => {
        if (!selections.has(parseFloat(minus.title))) minusTip.style.display = "none";
      });
      minus.addEventListener("click", () => {
        document.querySelectorAll(`#${sectionPrefix}-areas .tooltip`).forEach(t => t.style.display = "none");
        minusTip.style.display = "block";
      });
    }

    const plus = box.querySelector(".plus");
    if (plus && plusTooltips[i - 1]) {
      const plusTip = createTooltip(plusTooltips[i - 1]);
      box.appendChild(plusTip);
      plusTip.style.display = "none";

      plus.addEventListener("mouseenter", () => {
        if (!selections.has(parseFloat(plus.title))) plusTip.style.display = "block";
      });
      plus.addEventListener("mouseleave", () => {
        if (!selections.has(parseFloat(plus.title))) plusTip.style.display = "none";
      });
      plus.addEventListener("click", () => {
        document.querySelectorAll(`#${sectionPrefix}-areas .tooltip`).forEach(t => t.style.display = "none");
        plusTip.style.display = "block";
      });
    }
  });
}

window.addEventListener("DOMContentLoaded", function () {
  const eyebrowTooltips = ["0%", "5%", "10%", "30%", "50%", "70%", "90%"];
  const eyebrowPlus = ["7.5%", "20%", "40%", "60%", "80%", "100%"];
  const eyebrowMinus = ["2.5%"];
  applyTooltipToBoxes("left-eyebrow", eyebrowTooltips, eyebrowMinus, eyebrowPlus, eyebrowSelections.left);
  applyTooltipToBoxes("right-eyebrow", eyebrowTooltips, eyebrowMinus, eyebrowPlus, eyebrowSelections.right);

  const eyelashTooltips = ["0%", "5%", "10%", "30%", "50%", "70%", "90%"];
  applyTooltipToBoxes("left-eyelash", eyelashTooltips, eyebrowMinus, eyebrowPlus, eyelashSelections.left);
  applyTooltipToBoxes("right-eyelash", eyelashTooltips, eyebrowMinus, eyebrowPlus, eyelashSelections.right);

  const beardTooltips = ["0%", "2.5%", "10%", "25%", "40%", "56%", "70%", "86%", "100%"];
  const beardMinus = ["1.25%", "7.5%", "20%", "36%", "50%", "66%", "80%"];
  const beardPlus = ["5%", "15%", "30%", "45%", "60%", "75%", "92.5%"];
  
  const rightBeardTooltips = ["0%", "2.5%", "10%", "25%", "40%", "56%", "70%", "86%", "100%"];
  const rightBeardMinus = ["1.25%", "7.5%", "20%", "36%", "50%", "66%", "80%"];
  const rightBeardPlus = ["5%", "15%", "30%", "45%", "60%", "75%", "92.5%"];

  const leftBeardTooltips = ["0%", "2.5%", "10%", "25%", "40%", "56%", "70%", "86%", "100%"];
  const leftBeardMinus = ["1.25%", "7.5%", "20%", "36%", "50%", "66%", "80%"];
  const leftBeardPlus = ["5%", "15%", "30%", "45%", "60%", "75%", "92.5%"];

  const centralBeardTooltips = ["0%", "2.5%", "10%", "25%", "40%", "55%", "70%", "85", "100%"];
  const centralBeardMinus = ["1.25%", "7.5%", "20%", "35%", "50%", "65%", "80"];
  const centralBeardPlus = ["5%", "15%", "30%", "45%", "60%", "75%", "92.5"];

  applyTooltipToBoxes("right-beard", rightBeardTooltips, rightBeardMinus, rightBeardPlus, beardSelections["right-beard"].selected);
  applyTooltipToBoxes("left-beard", leftBeardTooltips, leftBeardMinus, leftBeardPlus, beardSelections["left-beard"].selected);
  applyTooltipToBoxes("central-beard", centralBeardTooltips, centralBeardMinus, centralBeardPlus, beardSelections["central-beard"].selected);

});
</script>
<script>
function showTooltip(el, text) {
  let tip = document.createElement('div');
  tip.className = 'help-box';
  tip.innerText = text;

  if (text.includes("window 1")) {
    tip.style.backgroundImage = "url('Images/help1.jpg')";
  } else if (text.includes("window 2")) {
    tip.style.backgroundImage = "url('Images/help2.jpg')";
  } else {
    tip.style.background = "#fff";
  }

  el.appendChild(tip);
  tip.style.display = 'block';
}

function hideTooltip(el) {
  const tip = el.querySelector('.help-box');
  if (tip) tip.remove();
}
</script>
<script>document.getElementById("reset-button").onclick = () => location.reload();</script>
<script>
function calculateSectionTotals() {
    const sectionData = {
        Scalp: 0,
        Eyebrows: 0,
        Eyelashes: 0,
        Beard: 0
    };

    // Compute Scalp with AGA adjustment using hair-density adjusted values
(function(){
  const per = {};
  for (const [id, data] of Object.entries(globalSelections)) {
    const subtotal = Array.from(data.selected).reduce((sum, val) => sum + val, 0);
    per[id] = { value: subtotal, density: data.density || 0 };
  }
  const checked = (document.getElementById('aga-checkbox') && document.getElementById('aga-checkbox').checked) === true;
  const Araw = Math.max(0, Math.min(100, (typeof window.androgeneticScore === 'number' ? window.androgeneticScore : 0)));
  const Adens = (globalSelections['androgenetic'] && typeof globalSelections['androgenetic'].density === 'number') ? globalSelections['androgenetic'].density : 0;
  const Aadj  = Araw * (1 - Adens/100);

  if (checked) {
    // Use density-adjusted regional values for numerator
    function adjVal(key){
      if (!per[key]) return 0;
      return per[key].value * (1 - per[key].density/100);
    }
    let B = adjVal('backside');
    let L = adjVal('leftside');
    let R = adjVal('rightside');
    let T = adjVal('topside');
    if (globalThis.__applyAgeScaling) { ({L,R,B,T} = globalThis.__applyAgeScaling({L,R,B,T})); }
    const numerator = B + L + R + T;
    const denominator = 60 + ((100 - Aadj) / 100 * 40);
    sectionData.Scalp = denominator > 0 ? (numerator / denominator) * 100 : 0;
  } else {
    // Default: sum with each region's density slider
    function adjVal2(key){ if (!per[key]) return 0; return per[key].value * (1 - per[key].density/100); }
    let B2 = adjVal2('backside');
    let L2 = adjVal2('leftside');
    let R2 = adjVal2('rightside');
    let T2 = adjVal2('topside');
    if (globalThis.__applyAgeScaling) { ({L:L2,R:R2,B:B2,T:T2} = globalThis.__applyAgeScaling({L:L2,R:R2,B:B2,T:T2})); }
    sectionData.Scalp = B2 + L2 + R2 + T2;
  }
})();

    sectionData.Eyebrows = [...eyebrowSelections.left, ...eyebrowSelections.right]
        .reduce((sum, val) => sum + val, 0);

    sectionData.Eyelashes = [...eyelashSelections.left, ...eyelashSelections.right]
        .reduce((sum, val) => sum + val, 0);

    for (const [id, data] of Object.entries(beardSelections)) {
        const subtotal = Array.from(data.selected).reduce((sum, val) => sum + val, 0);
        sectionData.Beard += subtotal * (1 - data.density / 100);
    }

    
    // Clamp each section to [0,100]
    for (const k of Object.keys(sectionData)) {
        sectionData[k] = Math.max(0, Math.min(100, Number(sectionData[k]) || 0));
    }

    return sectionData;
}

function getColorForSection(pct, alpha = 0.2) {
  pct = Math.min(100, Math.max(0, pct));

  let r, g, b;

  if (pct <= 50) {
    // Grey to Yellow
    const ratio = pct / 50;
    r = Math.floor(128 + (255 - 128) * ratio); // 128 → 255
    g = Math.floor(128 + (255 - 128) * ratio); // 128 → 255
    b = Math.floor(128 - 128 * ratio);         // 128 → 0
  } else {
    // Yellow to Red
    const ratio = (pct - 50) / 50;
    r = 255;
    g = Math.floor(255 * (1 - ratio));         // 255 → 0
    b = 0;
  }

  return `rgba(${r},${g},${b},${alpha})`;
}

function updateResultsSummary() {
    const totals = calculateSectionTotals();
    const resultsDiv = document.getElementById("results-summary");
    resultsDiv.innerHTML = Object.entries(totals).map(([key, val]) => {
        return `<div class="result-box" style="background-color:${getColorForSection(val)}">
            ${key}: ${val.toFixed(1)}%
        </div>`;
    }).join("");
}

setInterval(updateResultsSummary, 1000);
</script>
<div style="margin-top: 30px; text-align: center;">
</div>
<script>
function getCurrentState() {
  const scalp = {};
  for (const [sectionId, data] of Object.entries(globalSelections)) {
    scalp[sectionId] = {
      selected: Array.from(data.selected),
      density: data.density
    };
  }

  const beard = {};
  for (const [sectionId, data] of Object.entries(beardSelections)) {
    beard[sectionId] = {
      selected: Array.from(data.selected),
      density: data.density
    };
  }

  return {
    agaScore: agaScore,
scalp,
    eyebrows: {
      left: Array.from(eyebrowSelections.left),
      right: Array.from(eyebrowSelections.right)
    },
    eyelashes: {
      left: Array.from(eyelashSelections.left),
      right: Array.from(eyelashSelections.right)
    },
    beard
  };
}

function applyState(state) {
  // Restore AGA score if present and refresh score display
  if (typeof state.agaScore === 'number') {
    window.androgeneticScore = state.agaScore;
    try {
      const scoreEl = document.getElementById('androgenetic-score');
      const dens = (globalSelections['androgenetic'] && globalSelections['androgenetic'].density) ? globalSelections['androgenetic'].density : 0;
      const AEff = Math.max(0, Math.min(100, window.androgeneticScore * (1 - dens/100)));
      if (scoreEl) scoreEl.textContent = `Androgenetic alopecia score: ${AEff.toFixed(1)}%`;
    } catch(e){}
  }

  if (state.scalp) {
    for (const [sectionId, data] of Object.entries(state.scalp)) {
      if (sectionId === 'androgenetic') {
        // Do not auto-select the 0 picture on load
        const sel = (Array.isArray(data.selected) ? data.selected.filter(v => v > 0) : []);
        globalSelections[sectionId].selected = new Set(sel);
      } else {
        globalSelections[sectionId].selected = new Set(data.selected);
      }
      globalSelections[sectionId].density = data.density;
    }
    updateScalpUI();
  }

  if (state.eyebrows) {
    eyebrowSelections.left = new Set(state.eyebrows.left);
    eyebrowSelections.right = new Set(state.eyebrows.right);
    updateEyebrowUI();
  }

  if (state.eyelashes) {
    eyelashSelections.left = new Set(state.eyelashes.left);
    eyelashSelections.right = new Set(state.eyelashes.right);
    updateEyelashUI();
  }

  if (state.beard) {
    for (const [sectionId, data] of Object.entries(state.beard)) {
      beardSelections[sectionId].selected = new Set(data.selected);
      beardSelections[sectionId].density = data.density;
    }
    updateBeardUI();
  }
}

function copyCode() {
  const state = getCurrentState();
  const json = JSON.stringify(state);
  const encoded = btoa(json);
  navigator.clipboard.writeText(encoded).then(() => {
    alert("Score code copied to clipboard!");
  });
}

function loadCode() {
  try {
    const input = document.getElementById("codeInput").value.trim();
    if (!input) return alert("Please enter a code.");
    const json = atob(input);
    const state = JSON.parse(json);
    applyState(state);
  } catch (e) {
    alert("Invalid code.");
  }
}
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const pdfButton = document.getElementById("generate-pdf");
    const iconContainer = document.getElementById("pdf-icon-container");
    const previewArea = document.getElementById("selected-preview");

    function updatePdfIconVisibility() {
        iconContainer.style.display = previewArea.children.length > 0 ? "block" : "none";
    }

    const originalUpdateSelectedPreview = updateSelectedPreview;
    updateSelectedPreview = function() {
        originalUpdateSelectedPreview();
        updatePdfIconVisibility();
    }

    if (pdfButton) {
        pdfButton.addEventListener("click", () => {
            const opt = {
                margin:       0.3,
                filename:     'alopecia_preview_disabled.pdf',
                Image:        { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, allowTaint: false, imageTimeout: 15000 },
                jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            
/* preview injection disabled */
var __pdfPromise = null;
/* preview injection had cleanup; nothing to clean now */ catch(e){}
  });
}

        });
    }

    updatePdfIconVisibility();
});
</script>
<script>
/* removed previous generate-pdf listener */
});
</script>
<script>
/* removed previous generate-pdf listener */
});
</script>
<div id="floating-preview" style="position: fixed; top: 20px; right: 20px; width: 250px; height: 250px; padding: 0; margin: 0; overflow: hidden; z-index: 9999; display: none; background: none !important; border: none !important; pointer-events: none;">
<div id="floating-close-btn" style="
        position: absolute;
        top: 2px;
        right: 6px;
        font-size: 18px;
        color: #333;
        font-weight: bold;
        cursor: pointer;
        z-index: 10000;
        pointer-events: auto;
    ">×</div>
</div>
<script>
let previewVisible = true;
let floatingPreviewTimeout;

document.addEventListener("click", function (e) {
  if (e.target && e.target.id === "floating-close-btn") {
    previewVisible = false;
    document.getElementById("floating-preview").style.display = "none";
  }
});

window.addEventListener("scroll", function () {
  clearTimeout(floatingPreviewTimeout);
  const floating = document.getElementById("floating-preview");
  const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;

  if (!previewVisible) return;

  if (scrollTop > 150) {
    floatingPreviewTimeout = setTimeout(updateFloatingPreview, 10);
    if (floating) { floating.style.display = "block"; floating.style.opacity = "1"; }
  } else {
    if (floating) { floating.style.opacity = "0"; floating.style.display = "none"; }
  }
});






function updateFloatingPreview() {
  const floating = document.getElementById("floating-preview");
  if (!floating) return;

  // Preserve/restore close button
  const closeBtn = document.getElementById("floating-close-btn");
  floating.innerHTML = "";
  if (closeBtn) floating.appendChild(closeBtn.cloneNode(true));

  // Build rows from the authoritative selected-preview tiles
  const source = document.getElementById("selected-preview");
  if (!source || source.children.length === 0) return;

  // Buckets based on image URL
  const buckets = {
    scalp:   { left: [], back: [], right: [], top: [] },
    brows:   [],
    lashes:  [],
    beardR:  [], beardC: [], beardL: []
  };

  // Helper to get w/h numbers from a node
  const getWH = (el) => {
    const cs = getComputedStyle(el);
    const w = parseFloat(cs.width)  || parseFloat(el.style.width)  || 60;
    const h = parseFloat(cs.height) || parseFloat(el.style.height) || 60;
    return { w, h };
  };

  Array.from(source.children).forEach(child => {
    const style = child.style;
    const bg = style.backgroundImage || getComputedStyle(child).backgroundImage || "";
    const s  = String(bg).toLowerCase();
    if (!s || s === "none") return;

    const clone = child.cloneNode(true);
    clone.style.transform = "none";
    clone.style.transformOrigin = "top left";
    clone.style.flex = "0 0 auto";
    clone.style.borderRadius = "6px";

    if (s.includes("leftside-"))       buckets.scalp.left.push(clone);
    else if (s.includes("backside-"))  buckets.scalp.back.push(clone);
    else if (s.includes("rightside-")) buckets.scalp.right.push(clone);
    else if (s.includes("topside-"))   buckets.scalp.top.push(clone);
    else if (s.includes("eyebrow"))    buckets.brows.push(clone);
    else if (s.includes("eyelash"))    buckets.lashes.push(clone);
    else if (s.includes("right-beard"))   buckets.beardR.push(clone);
    else if (s.includes("central-beard")) buckets.beardC.push(clone);
    else if (s.includes("left-beard"))    buckets.beardL.push(clone);
  });

  // Compose rows in fixed order
  const rows = [];

  function makeRow(label, tiles) {
    if (!tiles || tiles.length === 0) return null;

    const lab = document.createElement("div");
    lab.textContent = label;
    lab.style.fontSize = "12px";
    lab.style.fontWeight = "600";
    lab.style.marginBottom = "2px";

    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.flexWrap = "nowrap";        // prevent wrapping; we'll scale to fit
    row.style.gap = "6px";
    row.style.alignItems = "flex-start";

    tiles.forEach(t => row.appendChild(t));

    const block = document.createElement("div");
    block.style.display = "flex";
    block.style.flexDirection = "column";
    block.style.alignItems = "flex-start";
    block.appendChild(lab);
    block.appendChild(row);

    // Precompute width/height for instant scale (avoid late reflow)
    const GAP = 6;
    let w = 0, h = 0;
    tiles.forEach((t, i) => {
      const { w: tw, h: th } = getWH(t);
      w += tw + (i > 0 ? GAP : 0);
      if (th > h) h = th;
    });
    block.__w = Math.max(w, lab.offsetWidth || 60);
    block.__h = h + (parseFloat(getComputedStyle(lab).lineHeight) || 14) + 2;

    return block;
  }

  // Scalp: Left, Back, Right, Top in one row
  const scalpTiles = [].concat(buckets.scalp.left, buckets.scalp.back, buckets.scalp.right, buckets.scalp.top);
  const scalpBlock = makeRow("Scalp", scalpTiles);
  if (scalpBlock) rows.push(scalpBlock);

  // Eyebrows / Eyelashes
  const browBlock = makeRow("Eyebrows", buckets.brows);
  if (browBlock) rows.push(browBlock);
  const lashBlock = makeRow("Eyelashes", buckets.lashes);
  if (lashBlock) rows.push(lashBlock);

  // Beard: Right, Central, Left
  const beardTiles = [].concat(buckets.beardR, buckets.beardC, buckets.beardL);
  const beardBlock = makeRow("Beard", beardTiles);
  if (beardBlock) rows.push(beardBlock);

  if (rows.length === 0) return;

  // Build container and compute scale BEFORE showing
  const previewInner = document.createElement("div");
  previewInner.style.display = "flex";
  previewInner.style.flexDirection = "column";
  previewInner.style.gap = "6px";
  previewInner.style.alignItems = "flex-start";
  previewInner.style.width = "max-content";
  previewInner.style.pointerEvents = "none";
  previewInner.style.visibility = "hidden";  // prevent flash

  rows.forEach(r => previewInner.appendChild(r));

  floating.appendChild(previewInner);

  // Compute required dimensions from precomputed numbers
  let totalH = 0, maxW = 0;
  rows.forEach(r => { totalH += (r.__h || 0) + 6; maxW = Math.max(maxW, r.__w || 0); });
  totalH -= 6; // remove last gap

  const pad = 16;
  const fw = floating.clientWidth || 230;
  const fh = floating.clientHeight || 300;
  const scale = Math.min((fw - pad) / maxW, (fh - pad) / totalH, 1);

  previewInner.style.transformOrigin = "top left";
  previewInner.style.transform = `scale(${scale})`;
  previewInner.style.visibility = "visible"; // reveal scaled content immediately
}
</script>
<script>
const allPreviewImages = [
  // Beard
  "Images/left-beard-0.jpg", "Images/left-beard-4.jpg", "Images/left-beard-10.jpg", "Images/left-beard-16.jpg",
  "Images/right-beard-0.jpg", "Images/right-beard-4.jpg", "Images/right-beard-10.jpg", "Images/right-beard-16.jpg",
  "Images/central-beard-0.jpg", "Images/central-beard-5.jpg", "Images/central-beard-8.jpg",

  // Eyebrow
  "Images/left-eyebrow-0.jpg", "Images/left-eyebrow-15.jpg", "Images/right-eyebrow-0.jpg", "Images/right-eyebrow-15.jpg",

  // Eyelash
  "Images/left-eyelash-0.jpg", "Images/right-eyelash-0.jpg"
];
allPreviewImages.forEach(src => {
  const img = new Image();
  img.src = src;
});
</script>
<div id="beard-floating-preview" style="
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 200px;
  max-height: 300px;
  overflow-y: auto;
  background-color: rgba(255, 255, 255, 0.95);
  border: 2px solid #0077cc;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  padding: 8px;
  display: none;
  z-index: 9999;
">
<strong>Beard Preview</strong>
<div id="beard-preview-content" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
</div>
<script>
function updateBeardPreview() {
  const container = document.getElementById("beard-preview-content");
  if (!container) return;
  container.innerHTML = "";

  const beardSectionsToCheck = ["left-beard", "right-beard", "central-beard"];

  beardSectionsToCheck.forEach(sectionId => {
    const areaBoxes = document.querySelectorAll(`#${sectionId}-areas .area-box`);
    areaBoxes.forEach(box => {
      const value = parseFloat(box.dataset.value);
      const style = window.getComputedStyle(box);
      const bgImage = style.backgroundImage;
      const match = bgImage.match(/url\(["']?(.*?)["']?\)/);
      if (!match) return;

      const ImageUrl = match[1];
      const isMain = box.classList.contains("selected");
      const isPlus = box.querySelector(".plus")?.classList.contains("glow") || false;
      const isMinus = box.querySelector(".minus")?.classList.contains("glow") || false;

      if (!(isMain || isPlus || isMinus)) return;

      const imgEl = document.createElement("img");
      imgEl.src = ImageUrl;
      imgEl.style.width = box.offsetWidth + "px";
      imgEl.style.height = box.offsetHeight + "px";
      imgEl.style.objectFit = "cover";
      imgEl.style.border = "2px solid #0077cc";
      imgEl.style.borderRadius = "6px";
      imgEl.style.flex = "0 0 auto";
      imgEl.loading = "eager";

      container.appendChild(imgEl);
    });
  });

  const previewBox = document.getElementById("beard-floating-preview");
  if (container.children.length > 0) {
    previewBox.style.display = "block";
  } else {
    previewBox.style.display = "none";
  }
}
</script>
<script>
// --- Added: ring meters + progress bar updater ---
function setRingPct(el, pct) {
  pct = Math.max(0, Math.min(100, Number(pct) || 0));
  el.style.background = `conic-gradient(#22c55e 0% ${pct}%, #e5e7eb ${pct}% 100%)`;
}
function updateScoreRings() {
  if (typeof calculateSectionTotals !== 'function') return;
  const totals = calculateSectionTotals();
  const entries = [
    ['Scalp', 'ring-scalp', 'ring-val-scalp'],
    ['Eyebrows','ring-eyebrows','ring-val-eyebrows'],
    ['Eyelashes','ring-eyelashes','ring-val-eyelashes'],
    ['Beard','ring-beard','ring-val-beard'],
  ];
  entries.forEach(([key, ringId, valId]) => {
    const prev = previous.get(ringId);
    const pct = (totals && totals[key] != null) ? Number(totals[key]) : 0;
    const ring = document.getElementById(ringId);
    const val = document.getElementById(valId);
    if (ring && val) {
      if (prev != null && Math.abs(prev - pct) < 1e-6) return;
      // Hide beard ring when 0 to avoid flashing on unrelated updates
      if (ring.id === 'ring-beard') {
        ring.style.display = (pct > 0.0001) ? 'grid' : 'none';
      }
      setRingPct(ring, pct.toFixed(1));
      val.textContent = `${pct.toFixed(1)}%`;
    }
  });
  // also update the total scalp progress bar
  const progressBar = document.querySelector('#scalp-progress > div');
  const scalpPct = (totals && totals['Scalp'] != null) ? Number(totals['Scalp']) : 0;
  if (progressBar) progressBar.style.width = `${Math.max(0, Math.min(100, scalpPct))}%`;
}
setInterval(updateScoreRings, 700);

// --- Enhance banner title text to include scalp % dynamically (keeps existing behavior) ---
(function() {
  const origUpdate = (typeof updateScalpUI === 'function') ? updateScalpUI : null;
  if (origUpdate) {
    window.updateScalpUI = function() {
      origUpdate();
      updateScoreRings();
    };
  }
})();

// --- Replace PDF click handler to include Percentage of the areas ---
(function() {
  const oldBtn = document.getElementById("generate-pdf");
  if (!oldBtn) return;
  const newBtn = oldBtn.cloneNode(true);
  oldBtn.parentNode.replaceChild(newBtn, oldBtn);

  newBtn.addEventListener("click", function () {
    const now = new Date();
    const datetime = now.toLocaleString();
    const title = "Alopecia Areata Calculator";

    const scalp = document.getElementById("result").innerText.replace("Total Scalp Alopecia Areata: ", "");
    const eyebrows = document.getElementById("eyebrow-title").innerText.match(/\((.*?)\)/)[1];
    const eyelashes = document.getElementById("eyelash-title").innerText.match(/\((.*?)\)/)[1];
    const beard = document.getElementById("beard-title").innerText.match(/\((.*?)\)/)[1];

    function getSubtotal(selections, density = 0) {
      let total = 0;
      for (const val of selections) total += val;
      total = total * (1 - (density||0) / 100);
      return Number(total.toFixed(2));
    }

    // Subtotals (density-adjusted where applicable)
    const leftScalp = getSubtotal(globalSelections["leftside"].selected, globalSelections["leftside"].density);
    const rightScalp = getSubtotal(globalSelections["rightside"].selected, globalSelections["rightside"].density);
    const topScalp = getSubtotal(globalSelections["topside"].selected, globalSelections["topside"].density);
    const backScalp = getSubtotal(globalSelections["backside"].selected, globalSelections["backside"].density);

    const leftEyebrow = getSubtotal(eyebrowSelections.left, 0);
    const rightEyebrow = getSubtotal(eyebrowSelections.right, 0);

    const leftEyelash = getSubtotal(eyelashSelections.left, 0);
    const rightEyelash = getSubtotal(eyelashSelections.right, 0);

    const leftBeard = getSubtotal(beardSelections["left-beard"].selected, beardSelections["left-beard"].density);
    const rightBeard = getSubtotal(beardSelections["right-beard"].selected, beardSelections["right-beard"].density);
    const centralBeard = getSubtotal(beardSelections["central-beard"].selected, beardSelections["central-beard"].density);

    // Max possible per area (100% loss in that area)
    const MAX = {
      leftScalp: 17, rightScalp: 17, topScalp: 40, backScalp: 24,
      leftEyebrow: 50, rightEyebrow: 50,
      leftEyelash: 50, rightEyelash: 50,
      leftBeard: 40, rightBeard: 40, centralBeard: 20
    };

    function rel(val, max) {
      if (!max) return "0.00";
      const pct = Math.max(0, Math.min(100, (val / max) * 100));
      return pct.toFixed(2);
    }

    const summarySection = document.createElement("div");
    summarySection.id = "pdf-summary";
    summarySection.style.margin = "20px";
    summarySection.style.fontFamily = "'Segoe UI', sans-serif";
    
summarySection.innerHTML = `
      <h2 style='text-align:center;'>${title}</h2>
      <p style='text-align:center;'><em>${datetime}</em></p>
      <hr/>

        
      <style>
          #pdf-summary{max-width:190mm;}
          #pdf-summary table{width:100%;max-width:190mm;border-collapse:collapse;table-layout:fixed;}
          #pdf-summary td{border:1px solid #ccc;padding:6px;word-wrap:break-word;white-space:normal;}
          #pdf-summary tr{page-break-inside:avoid;break-inside:avoid;-webkit-region-break-inside:avoid;-webkit-column-break-inside:avoid;}
          #pdf-summary table, #pdf-summary td{page-break-inside:avoid;break-inside:avoid;}
        .pdf-top-right { position:absolute; top:6px; right:8px; }
</style>

      <h3>Summary of Alopecia Areata Involvement</h3>
      <ul>
        <li><strong>Total Scalp:</strong> ${scalp}</li>
        <li><strong>Total Eyebrows:</strong> ${eyebrows}</li>
        <li><strong>Total Eyelashes:</strong> ${eyelashes}</li>
        <li><strong>Total Beard:</strong> ${beard}</li>${(String(beard).replace('%',''))!=='0.00' && String(beard)!=='0%' ? '' : '<style>#pdf-summary .beard-only{display:none;}.pdf-top-right { position:absolute; top:6px; right:8px; }
</style>'}
      </ul>
      <h3>Detailed Area Breakdown</h3>
      <ul>
        <li><strong>Left Scalp:</strong> ${leftScalp}% (=Percentage of the area=${rel(leftScalp, MAX.leftScalp)}%)</li>
        <li><strong>Right Scalp:</strong> ${rightScalp}% (=Percentage of the area=${rel(rightScalp, MAX.rightScalp)}%)</li>
        <li><strong>Top of the Head:</strong> ${topScalp}% (=Percentage of the area=${rel(topScalp, MAX.topScalp)}%)</li>
        <li><strong>Back of the Head:</strong> ${backScalp}% (=Percentage of the area=${rel(backScalp, MAX.backScalp)}%)</li>
        <li><strong>Left Eyebrow:</strong> ${leftEyebrow}% (=Percentage of the area=${rel(leftEyebrow, MAX.leftEyebrow)}%)</li>
        <li><strong>Right Eyebrow:</strong> ${rightEyebrow}% (=Percentage of the area=${rel(rightEyebrow, MAX.rightEyebrow)}%)</li>
        <li><strong>Left Eyelash:</strong> ${leftEyelash}% (=Percentage of the area=${rel(leftEyelash, MAX.leftEyelash)}%)</li>
        <li><strong>Right Eyelash:</strong> ${rightEyelash}% (=Percentage of the area=${rel(rightEyelash, MAX.rightEyelash)}%)</li>
        <li><strong>Left Beard Area:</strong> ${leftBeard}% (=Percentage of the area=${rel(leftBeard, MAX.leftBeard)}%)</li>
        <li><strong>Right Beard Area:</strong> ${rightBeard}% (=Percentage of the area=${rel(rightBeard, MAX.rightBeard)}%)</li>
        <li><strong>Central Beard Area:</strong> ${centralBeard}% (=Percentage of the area=${rel(centralBeard, MAX.centralBeard)}%)</li>
      </ul>
    `;

    
      
      
// Build exactly one Dominant pattern / Scalp change line for the PDF
(function(){
  if (window.__pdfDominantInjected) return;
  window.__pdfDominantInjected = true;
  try {
    Array.from(summarySection.querySelectorAll('#pdf-dominant-line')).forEach(n=>n.remove());
    const patText = (document.getElementById('pattern-dominant')?.textContent || '').trim();
    let changeText = '';
    if (typeof window.__baselineScalpPct === 'number' && typeof calculateSectionTotals === 'function') {
      try {
        const cur = Number(calculateSectionTotals().Scalp);
        if (Number.isFinite(cur)) {
          const d = window.__baselineScalpPct - cur;
          if (d !== 0) {
            const abs = Math.abs(d).toFixed(1).replace(/\.0$/, '');
            changeText = d > 0 ? ('Scalp improvement: ' + abs + '%') : ('Scalp worsening: ' + abs + '%');
          }
        }
      } catch(e){}
    }
    const lineText = [patText ? ('Dominant pattern: ' + patText + '.') : '', changeText].filter(Boolean).join(' ');
    if (lineText) {
      const p = document.createElement('p');
      p.id = 'pdf-dominant-line';
      p.style.textAlign = 'center';
      p.style.fontWeight = '600';
      p.style.margin = '6px 0 0 0';
      p.textContent = lineText;
      const timeP = summarySection.querySelector('p em');
      if (timeP && timeP.parentElement) timeP.parentElement.insertAdjacentElement('afterend', p);
      else summarySection.prepend(p);
    }
    // Beard gating in PDF
    const beardNum = (function(v){
      if (typeof v === 'number') return v;
      const n = parseFloat(String(v||'').replace('%',''));
      return isNaN(n) ? 0 : n;
    })(typeof beard !== 'undefined' ? beard : 0);
    if (beardNum === 0) {
      const totalLi = Array.from(summarySection.querySelectorAll('ul li')).find(li => /Total\s*Beard/i.test(li.textContent||''));
      if (totalLi) totalLi.remove();
      Array.from(summarySection.querySelectorAll('ul li')).forEach(li => {
        if (/Left\s*Beard\s*Area|Right\s*Beard\s*Area|Central\s*Beard\s*Area/i.test(li.textContent||'')) li.remove();
      });
    }
  } catch(e) {}
})();// Build exactly one Dominant pattern / Scalp change line for the PDF
      try {
        // Remove any existing line from prior runs
        Array.from(summarySection.querySelectorAll('#pdf-dominant-line')).forEach(n=>n.remove());
        const patText = (document.getElementById('pattern-dominant')?.textContent || '').trim();
        let changeText = '';
        if (typeof window.__baselineScalpPct === 'number' && typeof calculateSectionTotals === 'function') {
          try {
            const cur = Number(calculateSectionTotals().Scalp);
            if (Number.isFinite(cur)) {
              const d = window.__baselineScalpPct - cur;
              if (d !== 0) {
                const abs = Math.abs(d).toFixed(1).replace(/\.0$/, '');
                changeText = d > 0 ? ('Scalp improvement: ' + abs + '%') : ('Scalp worsening: ' + abs + '%');
              }
            }
          } catch(e){}
        }
        const lineText = [patText ? ('Dominant pattern: ' + patText + '.') : '', changeText].filter(Boolean).join(' ');
        if (lineText) {
          const p = document.createElement('p');
          p.id = 'pdf-dominant-line';
          p.style.textAlign = 'center';
          p.style.fontWeight = '600';
          p.style.margin = '6px 0 0 0';
          p.textContent = lineText;
          // Insert after the timestamp (<em>${datetime}</em>) if present, else at top
          const timeP = summarySection.querySelector('p em');
          if (timeP && timeP.parentElement) {
            timeP.parentElement.insertAdjacentElement('afterend', p);
          } else {
            summarySection.prepend(p);
          }
        }
        // Beard gating in PDF
        const beardNum = (function(v){
          if (typeof v === 'number') return v;
          const n = parseFloat(String(v||'').replace('%',''));
          return isNaN(n) ? 0 : n;
        })(typeof beard !== 'undefined' ? beard : 0);
        if (beardNum === 0) {
          // Remove total beard line
          const totalLi = Array.from(summarySection.querySelectorAll('ul li')).find(li => /Total\s*Beard/i.test(li.textContent||''));
          if (totalLi) totalLi.remove();
          // Remove beard detail lines
          Array.from(summarySection.querySelectorAll('ul li')).forEach(li => {
            if (/Left\s*Beard\s*Area|Right\s*Beard\s*Area|Central\s*Beard\s*Area/i.test(li.textContent||'')) li.remove();
          });
        }
      } catch(e) {}
    // Normalize dominant line to a single instance and hide beard items when beard == 0
      try {
        // Remove duplicate dominant line nodes, keep the first
        const _dups = summarySection.querySelectorAll('#pdf-dominant-line');
        for (let i = 1; i < _dups.length; i++) { _dups[i].remove(); }

        // Beard gating
        const beardNum = (function(v){
          if (typeof v === 'number') return v;
          if (typeof v === 'string') {
            const n = parseFloat(v.replace('%',''));
            return isNaN(n) ? 0 : n;
          }
          return 0;
        })(typeof beard !== 'undefined' ? beard : 0);

        if (beardNum === 0) {
          // remove Total Beard line
          const totalLi = Array.from(summarySection.querySelectorAll('ul li')).find(li => /Total\s*Beard/i.test(li.textContent||''));
          if (totalLi) totalLi.remove();

          // remove beard detail lines
          Array.from(summarySection.querySelectorAll('ul li')).forEach(li => {
            if (/Left\s*Beard\s*Area|Right\s*Beard\s*Area|Central\s*Beard\s*Area/i.test(li.textContent||'')) {
              li.remove();
            }
          });
        }
      } catch(_e) {}
document.body.appendChild(summarySection);
      // Ensure images can be rendered by html2canvas when loaded from another origin
      try {
        summarySection.querySelectorAll('img').forEach(img => {
          if (!img.getAttribute('crossorigin')) img.setAttribute('crossorigin', 'anonymous');
          // If images are data: URLs this has no effect, but it is safe.
        });
      } catch(e) {}
    

    html2pdf().set({ margin: 10, pagebreak: { mode: ['css','legacy'], avoid: ['tr','td','.no-split'] },
      filename: 'alopecia_areata_detailed_summary.pdf',
      html2canvas: { scale: 2, useCORS: true, allowTaint: false, imageTimeout: 15000 },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    }).from(summarySection).save().then(() => {
      document.body.removeChild(summarySection);
    });
  });
})();
</script>
<script>
// Override ring color: 0% = green (h~120), 100% = red (h~0)
(function(){
  window.setRingPct = function(el, pct) {
    pct = Math.max(0, Math.min(100, Number(pct) || 0));
    const hue = 120 - (pct * 1.2); // 120->0
    const color = `hsl(${hue}, 85%, 45%)`;
    el.style.background = `conic-gradient(${color} 0% ${pct}%, #e5e7eb ${pct}% 100%)`;
  };
})();
</script>
<script>
(function(){
  const pdfBtn = document.getElementById("generate-pdf");
  if (!pdfBtn) return;
  // Create the button
  const copyBtn = document.createElement("button");
  copyBtn.id = "copy-summary";
  copyBtn.type = "button";
  copyBtn.textContent = "Copy summary";
  copyBtn.style.marginLeft = "8px";
  copyBtn.style.padding = "8px 12px";
  copyBtn.style.border = "1px solid #cbd5e1";
  copyBtn.style.borderRadius = "8px";
  copyBtn.style.cursor = "pointer";
  copyBtn.style.background = "white";
  copyBtn.style.boxShadow = "0 1px 2px rgba(0,0,0,.05)";
  pdfBtn.insertAdjacentElement("afterend", copyBtn);

  function getTotalsAndDetails(){
    const scalp = document.getElementById("result").innerText.replace("Total Scalp Alopecia Areata: ", "");
    const eyebrows = document.getElementById("eyebrow-title").innerText.match(/\((.*?)\)/)[1];
    const eyelashes = document.getElementById("eyelash-title").innerText.match(/\((.*?)\)/)[1];
    const beard = document.getElementById("beard-title").innerText.match(/\((.*?)\)/)[1];

    function getSubtotal(selections, density = 0) {
      let total = 0;
      for (const val of selections) total += val;
      total = total * (1 - (density||0) / 100);
      return Number(total.toFixed(2));
    }

    const leftScalp = getSubtotal(globalSelections["leftside"].selected, globalSelections["leftside"].density);
    const rightScalp = getSubtotal(globalSelections["rightside"].selected, globalSelections["rightside"].density);
    const topScalp = getSubtotal(globalSelections["topside"].selected, globalSelections["topside"].density);
    const backScalp = getSubtotal(globalSelections["backside"].selected, globalSelections["backside"].density);

    const leftEyebrow = getSubtotal(eyebrowSelections.left, 0);
    const rightEyebrow = getSubtotal(eyebrowSelections.right, 0);

    const leftEyelash = getSubtotal(eyelashSelections.left, 0);
    const rightEyelash = getSubtotal(eyelashSelections.right, 0);

    const leftBeard = getSubtotal(beardSelections["left-beard"].selected, beardSelections["left-beard"].density);
    const rightBeard = getSubtotal(beardSelections["right-beard"].selected, beardSelections["right-beard"].density);
    const centralBeard = getSubtotal(beardSelections["central-beard"].selected, beardSelections["central-beard"].density);

    const MAX = {
      leftScalp: 17, rightScalp: 17, topScalp: 40, backScalp: 24,
      leftEyebrow: 50, rightEyebrow: 50,
      leftEyelash: 50, rightEyelash: 50,
      leftBeard: 40, rightBeard: 40, centralBeard: 20
    };

    function rel(val, max) {
      if (!max) return "0.00";
      const pct = Math.max(0, Math.min(100, (val / max) * 100));
      return pct.toFixed(2);
    }

    return {
      totals: { scalp, eyebrows, eyelashes, beard },
      details: {
        leftScalp, rightScalp, topScalp, backScalp,
        leftEyebrow, rightEyebrow, leftEyelash, rightEyelash,
        leftBeard, rightBeard, centralBeard
      },
      MAX, rel
    };
  }

  copyBtn.addEventListener("click", async function () {
    const now = new Date();
    const dt = now.toLocaleString();
    const { totals, details, MAX, rel } = getTotalsAndDetails();
        const lines = [];
    // Helper to compute Dominant pattern with scalp-only '(diffuse)'
    function __computeDominantScalpOnly(){
      try {
        var node = document.getElementById('pattern-dominant');
        var base = (node && node.textContent) ? String(node.textContent).trim() : '';
        base = base.replace(/\s*\(diffuse\)\s*$/i, '').trim();
        // compute scalp densities > 0
        var dens = [];
        if (typeof globalSelections === 'object' && globalSelections) {
          ['backside','topside','leftside','rightside','androgenetic'].forEach(function(id){
            if (globalSelections[id] && typeof globalSelections[id].density !== 'undefined') {
              dens.push(Number(globalSelections[id].density)||0);
            }
          });
        }
        var isDiffuse = dens.some(function(d){ return (Number(d)||0) > 0; });
        return base ? (base + (isDiffuse ? " (diffuse)" : "")) : "";
      } catch(e){ return ""; }
    }
    // Update existing Dominant pattern line if present; else insert near top after title
    (function(){
      var dp = __computeDominantScalpOnly();
      if (!dp) return;
      var updated = false;
      for (var i=0; i<lines.length; i++){
        if (/^[-\s]*Dominant pattern\s*:/i.test(String(lines[i]||""))) {
          lines[i] = "Dominant pattern: " + dp;
          updated = true;
          break;
        }
      }
      if (!updated) {
        // place after title/date if present, else at start
        var insertAt = 0;
        if (lines.length >= 2 && /^Alopecia Areata Calculator$/i.test(lines[0])) insertAt = 2; // after title+date
        lines.splice(insertAt, 0, "Dominant pattern: " + dp);
      }
    })();

    // Robust dominant pattern line using scalp densities only (independent of decorators)
    try {
      var __patNode0 = document.getElementById('pattern-dominant');
      var __pat0 = __patNode0 && __patNode0.textContent ? __patNode0.textContent.trim() : '';
      // compute scalp-only diffuse flag
      var __dens = [];
      try {
        if (typeof globalSelections === 'object' && globalSelections) {
          ['backside','topside','leftside','rightside','androgenetic'].forEach(function(id){
            if (globalSelections[id] && typeof globalSelections[id].density !== 'undefined') {
              __dens.push(Number(globalSelections[id].density)||0);
            }
          });
        }
      } catch(__e2){}
      var __isDiffuse = __dens.some(function(d){ return (Number(d)||0) > 0; });
      var __patFinal = String(__pat0).replace(/\s*\(diffuse\)\s*$/i, '').trim();
      if (__isDiffuse && __patFinal) { __patFinal += " (diffuse)"; }
      if (__patFinal && !lines.some(function(l){ return /^[-\s]*Dominant pattern/i.test(String(l||'')); })) {
        lines.push("Dominant pattern: " + __patFinal);
      }
    } catch(__e0) {}

    // Ensure dominant pattern is included once, using scalp-only diffuse decoration
    try {
      var __patNode = document.getElementById('pattern-dominant');
      var __patText = __patNode && __patNode.textContent ? __patNode.textContent.trim() : '';
      if (window.__aa_decorateDominant) { __patText = window.__aa_decorateDominant(__patText); }
      if (__patText && !lines.some(function(l){ return /^[-\s]*Dominant pattern/i.test(String(l||'')); })) {
        lines.push('Dominant pattern: ' + __patText);
      }
    } catch(__e) {}

    lines.push("Alopecia Areata Calculator");
    lines.push(dt);
    lines.push("");
    lines.push("Summary of Alopecia Areata Involvement");
    // Dominant pattern (scalp-only diffuse)
    try {
      var __patNode = document.getElementById('pattern-dominant');
      var __patText = __patNode && __patNode.textContent ? __patNode.textContent.trim() : '';
      if (window.decorateDominant) { __patText = window.decorateDominant(__patText); }
      // avoid duplicates
      if (__patText && !lines.some(function(l){ return /^[-\s]*Dominant pattern/i.test(String(l||'')); })) {
        lines.push('Dominant pattern: ' + __patText);
      }
    } catch(__e) {}

    lines.push(`- Total Scalp: ${Number(totals.scalp).toFixed(0)}%`);
    
    // Append scalp change if baseline exists and non-zero (works with totals.Scalp or totals.scalp)
    (function(){ try {
      if (typeof window.__baselineScalpPct === 'number') {
        const __cur = (typeof totals === 'object') ? (('Scalp' in totals ? totals.Scalp : (('scalp' in totals) ? totals.scalp : null))) : null;
        const __val = Number(__cur);
        if (Number.isFinite(__val)) {
          const __delta = window.__baselineScalpPct - __val;
          if (__delta !== 0) {
            const __abs = Math.abs(__delta).toFixed(1).replace(/\.0$/, '');
            if (__delta > 0) { lines.push(`- Scalp improvement: ${__abs}%`); }
            else { lines.push(`- Scalp worsening: ${__abs}%`); }
          }
        }
      }
    } catch(__e){} })();
lines.push(`- Total Eyebrows: ${Number(totals.eyebrows).toFixed(0)}%`);
    lines.push(`- Total Eyelashes: ${Number(totals.eyelashes).toFixed(0)}%`);
    if (Number(totals.beard) > 0) { lines.push(`- Total Beard: ${Number(totals.beard).toFixed(0)}%`); }
    try { if (typeof encodeAA19==="function") { lines.push(`Code: ${encodeAA19()}`); } } catch(e){}
    lines.push("");
try { if (typeof encodeAA19==="function") { lines.push(`Code: ${encodeAA19()}`); } } catch(e){}
    
    // Normalize Dominant pattern line once, with scalp-only diffuse
    (function(){
      try {
        var dp = (typeof __computeDominantScalpOnly === 'function') ? __computeDominantScalpOnly() : "";
        if (dp) {
          // remove duplicates
          var firstIdx = -1;
          for (var i=0; i<lines.length; i++){
            if (/^[-\s]*Dominant pattern\s*:/i.test(String(lines[i]||""))) {
              if (firstIdx === -1) firstIdx = i;
              else { lines.splice(i,1); i--; }
            }
          }
          if (firstIdx === -1) {
            lines.splice(0, 0, "Dominant pattern: " + dp);
          } else {
            lines[firstIdx] = "Dominant pattern: " + dp;
          }
        }
      } catch(e){}
    })();

const text = lines.join("
");
    async function writeClipboard(t){
      try {
        await navigator.clipboard.writeText(t);
        return true;
      } catch (e) {
        // Fallback
        try {
          const ta = document.createElement("textarea");
          ta.value = t;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
          return true;
        } catch (err) {
          return false;
        }
      }
    }
    try { if (typeof encodeAA19==="function" && lines && Array.isArray(lines)) { lines.push(`Code: ${encodeAA19()}`); text = lines.join("
"); } } catch(e){}
    const ok = await writeClipboard(text);
    if (ok) {
      copyBtn.textContent = "Copied!";
      setTimeout(()=>copyBtn.textContent="Copy summary", 1200);
    } else {
      alert("Sorry, copying to clipboard failed.");
    }
  });
})();
</script>
<script>
document.addEventListener("DOMContentLoaded", function(){
  var pdfWrap = document.getElementById("pdf-icon-container");
  if (pdfWrap) pdfWrap.style.display = "block";
});
</script>
<script>
(function(){
  function anySelections(){
    const sel = document.querySelector('.area-box.selected');
    return !!sel;
  }
  function showFloating(force){
    const floating = document.getElementById("floating-preview");
    if (!floating) return;
    if (force || anySelections()){
      floating.style.display = "block";
      try { updateFloatingPreview && updateFloatingPreview(); } catch(e){}
    }
  }
  document.addEventListener("DOMContentLoaded", function(){
    // On load, if any selections already present, show it
    showFloating(false);

    // Observe selection changes
    const observer = new MutationObserver(()=>showFloating(false));
    observer.observe(document.body, { attributes: true, subtree: true, attributeFilter: ["class"] });

    // Also when totals update after clicks, show it
    document.body.addEventListener("click", function(e){
      if (e.target && e.target.classList && e.target.classList.contains("area-box")){
        setTimeout(()=>showFloating(false), 30);
      }
    });

    // Fallback: ensure it appears a bit after load
    setTimeout(()=>showFloating(false), 1000);
  });
})();
</script>
<script>
(function(){
  function injectCopy(){
    const pdfBtn = document.getElementById("generate-pdf");
    if (!pdfBtn) return false;
    if (document.getElementById("copy-summary")) return true;
    const copyBtn = document.createElement("button");
    copyBtn.id = "copy-summary";
    copyBtn.type = "button";
    copyBtn.textContent = "Copy summary";
    copyBtn.style.marginLeft = "8px";
    copyBtn.style.padding = "8px 12px";
    copyBtn.style.border = "1px solid #cbd5e1";
    copyBtn.style.borderRadius = "8px";
    copyBtn.style.cursor = "pointer";
    copyBtn.style.background = "white";
    copyBtn.style.boxShadow = "0 1px 2px rgba(0,0,0,.05)";
    pdfBtn.parentNode.insertBefore(copyBtn, pdfBtn.nextSibling);

    // Wire up action (re-use earlier function if present)
    function getTotalsAndDetails(){
      const scalp = document.getElementById("result").innerText.replace("Total Scalp Alopecia Areata: ", "");
      const eyebrows = document.getElementById("eyebrow-title").innerText.match(/\((.*?)\)/)[1];
      const eyelashes = document.getElementById("eyelash-title").innerText.match(/\((.*?)\)/)[1];
      const beard = document.getElementById("beard-title").innerText.match(/\((.*?)\)/)[1];

      function getSubtotal(selections, density = 0) {
        let total = 0;
        for (const val of selections) total += val;
        total = total * (1 - (density||0) / 100);
        return Number(total.toFixed(2));
      }

      const leftScalp = getSubtotal(globalSelections["leftside"].selected, globalSelections["leftside"].density);
      const rightScalp = getSubtotal(globalSelections["rightside"].selected, globalSelections["rightside"].density);
      const topScalp = getSubtotal(globalSelections["topside"].selected, globalSelections["topside"].density);
      const backScalp = getSubtotal(globalSelections["backside"].selected, globalSelections["backside"].density);

      const leftEyebrow = getSubtotal(eyebrowSelections.left, 0);
      const rightEyebrow = getSubtotal(eyebrowSelections.right, 0);

      const leftEyelash = getSubtotal(eyelashSelections.left, 0);
      const rightEyelash = getSubtotal(eyelashSelections.right, 0);

      const leftBeard = getSubtotal(beardSelections["left-beard"].selected, beardSelections["left-beard"].density);
      const rightBeard = getSubtotal(beardSelections["right-beard"].selected, beardSelections["right-beard"].density);
      const centralBeard = getSubtotal(beardSelections["central-beard"].selected, beardSelections["central-beard"].density);

      const MAX = {
        leftScalp: 17, rightScalp: 17, topScalp: 40, backScalp: 24,
        leftEyebrow: 50, rightEyebrow: 50,
        leftEyelash: 50, rightEyelash: 50,
        leftBeard: 40, rightBeard: 40, centralBeard: 20
      };

      function rel(val, max) {
        if (!max) return "0.00";
        const pct = Math.max(0, Math.min(100, (val / max) * 100));
        return pct.toFixed(2);
      }

      return {
        totals: { scalp, eyebrows, eyelashes, beard },
        details: {
          leftScalp, rightScalp, topScalp, backScalp,
          leftEyebrow, rightEyebrow, leftEyelash, rightEyelash,
          leftBeard, rightBeard, centralBeard
        },
        MAX, rel
      };
    }

    copyBtn.addEventListener("click", async function () {
      const now = new Date();
      const dt = now.toLocaleString();
      const { totals, details, MAX, rel } = getTotalsAndDetails();
      const lines = [];
    lines.push("Alopecia Areata Calculator");
    lines.push(dt);
    lines.push("");
    lines.push("Summary of Alopecia Areata Involvement");
    lines.push(`- Total Scalp: ${Number(totals.scalp).toFixed(0)}%`);
    
    // Append scalp change if baseline exists and non-zero (works with totals.Scalp or totals.scalp)
    (function(){ try {
      if (typeof window.__baselineScalpPct === 'number') {
        const __cur = (typeof totals === 'object') ? (('Scalp' in totals ? totals.Scalp : (('scalp' in totals) ? totals.scalp : null))) : null;
        const __val = Number(__cur);
        if (Number.isFinite(__val)) {
          const __delta = window.__baselineScalpPct - __val;
          if (__delta !== 0) {
            const __abs = Math.abs(__delta).toFixed(1).replace(/\.0$/, '');
            if (__delta > 0) { lines.push(`- Scalp improvement: ${__abs}%`); }
            else { lines.push(`- Scalp worsening: ${__abs}%`); }
          }
        }
      }
    } catch(__e){} })();
lines.push(`- Total Eyebrows: ${Number(totals.eyebrows).toFixed(0)}%`);
    lines.push(`- Total Eyelashes: ${Number(totals.eyelashes).toFixed(0)}%`);
    if (Number(totals.beard) > 0) { lines.push(`- Total Beard: ${Number(totals.beard).toFixed(0)}%`); }
    try { if (typeof encodeAA19==="function") { lines.push(`Code: ${encodeAA19()}`); } } catch(e){}
    lines.push("");
const text = lines.join("
");

      async function writeClipboard(t){
        try {
          await navigator.clipboard.writeText(t);
          return true;
        } catch (e) {
          try {
            const ta = document.createElement("textarea");
            ta.value = t;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            document.body.removeChild(ta);
            return true;
          } catch (err) {
            return false;
          }
        }
      }
      try { if (typeof encodeAA19==="function" && lines && Array.isArray(lines)) { lines.push(`Code: ${encodeAA19()}`); text = lines.join("
"); } } catch(e){}
    const ok = await writeClipboard(text);
      if (ok) {
        copyBtn.textContent = "Copied!";
        setTimeout(()=>copyBtn.textContent="Copy summary", 1200);
      } else {
        alert("Sorry, copying to clipboard failed.");
      }
    });
    return true;
  }
  function tryInject(){
    if (!injectCopy()) {
      setTimeout(tryInject, 300);
    }
  }
  document.addEventListener("DOMContentLoaded", tryInject);
})();
</script>
<script>
(function(){
  function applyTransparentClickThrough(){
    const fp = document.getElementById('floating-preview');
    if (!fp) return;
    // Make the outer container fully click-through and transparent
    fp.style.background = 'transparent';
    fp.style.boxShadow = 'none';
    fp.style.border = 'none';
    fp.style.pointerEvents = 'none'; // allow clicks to pass through
    // Ensure inner wrapper doesn't capture events either
    const inner = fp.querySelector('.fp-inner');
    if (inner) {
      inner.style.pointerEvents = 'none';
      // If inner added any background in previous steps, clear it
      inner.style.background = 'transparent';
    }
  }
  document.addEventListener('DOMContentLoaded', function(){
    applyTransparentClickThrough();
    // Re-apply after autoscale/setup might tweak styles
    setTimeout(applyTransparentClickThrough, 50);
    setTimeout(applyTransparentClickThrough, 500);
  });
  // Also on window resize or DOM changes
  window.addEventListener('resize', applyTransparentClickThrough);
  new MutationObserver(applyTransparentClickThrough).observe(document.documentElement, {subtree:true, childList:true, attributes:true});
})();
</script>
<!-- MICRO-SCROLL-GLOBAL -->
<script>
(function() {
  function microScroll1px() {
    var y = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
    window.scrollTo(0, y + 1);
    window.scrollTo(0, y);
  }
  document.addEventListener('change', function(e) {
    if (e.target && e.target.closest('select, input[type="radio"], input[type="checkbox"]')) {
      microScroll1px();
    }
  }, true);
  document.addEventListener('click', function(e) {
    if (!e.target) return;
    if (e.target.closest('.area-box, .plus, .minus, button, [role="button"]')) {
      microScroll1px();
    }
  }, true);
})();
</script>
<!-- HIDE FLOATING PREVIEW ON SMALL SCREENS -->
<script>
(function() {
  function checkFloatingPreviewVisibility() {
    const floating = document.getElementById("floating-preview");
    if (!floating) return;
    if (window.innerWidth < 1500) {
      floating.style.display = "none";
    }
  }
  window.addEventListener('resize', checkFloatingPreviewVisibility);
  document.addEventListener('DOMContentLoaded', checkFloatingPreviewVisibility);
})();
</script>
<script>
/* Smooth sweep + pulse + particle burst on value change for score rings + pinned peek; improved triggers */
(function () {
  // Ensure a peek container exists
  function ensurePeekRoot() {
    let root = document.getElementById('ring-peek');
    if (!root) {
      root = document.createElement('div');
      root.id = 'ring-peek';
      document.body.appendChild(root);
    }
    return root;
  }

  // Make/update a mini ring item
  const peekItems = new Map(); // key: ring id -> {el, hideTimer}

  // Map region name to its ring id and track the active region for peeks
  const REGION_TO_RING = {
    'Scalp': 'ring-scalp',
    'Eyebrows': 'ring-eyebrows',
    'Eyelashes': 'ring-eyelashes',
    'Beard': 'ring-beard'
  };
  let currentPeekRegion = null;

  function clearNonActivePeeks() {
    const root = ensurePeekRoot();
    const keepRingId = currentPeekRegion ? REGION_TO_RING[currentPeekRegion] : null;
    for (const [rid, item] of Array.from(peekItems.entries())) {
      if (!keepRingId || rid !== keepRingId) {
        if (item.hideTimer) clearTimeout(item.hideTimer);
        item.el.remove();
        peekItems.delete(rid);
      }
    }
  }
  function setMiniRingPct(el, pct) {
    const clamped = Math.max(0, Math.min(100, pct || 0));
    const hue = 120 - (clamped * 1.2);
    el.style.background = `conic-gradient(hsl(${hue}, 85%, 50%) 0% ${clamped}%, #e5e7eb ${clamped}% 100%)`;
  }
  function showPeek(ringId, label, pct) {
    // Only show peek for the current active region, if set
    if (currentPeekRegion) {
      const keepRingId = REGION_TO_RING[currentPeekRegion] || null;
      if (keepRingId && ringId !== keepRingId) return;
    }
    const root = ensurePeekRoot();
    clearNonActivePeeks();
    let item = peekItems.get(ringId);
    if (!item) {
      const container = document.createElement('div');
      container.className = 'peek-item';
      const circle = document.createElement('div');
      circle.className = 'peek-ring';
      const textWrap = document.createElement('div');
      const title = document.createElement('div');
      title.className = 'peek-title';
      title.textContent = label;
      const value = document.createElement('div');
      value.className = 'peek-value';
      value.textContent = (pct ?? 0).toFixed ? (pct).toFixed(1) + '%' : pct + '%';
      textWrap.appendChild(title);
      textWrap.appendChild(value);
      container.appendChild(circle);
      container.appendChild(textWrap);
      root.appendChild(container);
      item = { el: container, circle, title, value, hideTimer: null };
      peekItems.set(ringId, item);
      // Click to scroll to the ring or section
      container.addEventListener('click', () => {
        let target = document.getElementById(ringId);
        if (!target) {
          // try matching section by label
          const sec = Array.from(document.querySelectorAll('section, .section, .area, fieldset')).find(el =>
            el.textContent && el.textContent.toLowerCase().includes(label.toLowerCase())
          );
          if (sec) target = sec;
        }
        if (target) target.scrollIntoView({ behavior: 'smooth', block: 'center' });
      });
    }
    item.title.textContent = label;
    item.value.textContent = (Number(pct)||0).toFixed(1) + '%';
    setMiniRingPct(item.circle, pct);

    // reset hide timer (2s)
    if (item.hideTimer) clearTimeout(item.hideTimer);
    item.el.classList.remove('hide');
    item.hideTimer = setTimeout(() => {
      item.el.classList.add('hide');
      setTimeout(() => {
        if (peekItems.get(ringId) === item) {
          item.el.remove();
          peekItems.delete(ringId);
          if (peekItems.size === 0) { currentPeekRegion = null; }
        }
      }, 260);
    }, 2000);
  }

  const previous = new Map();
  const easeOutCubic = t => 1 - Math.pow(1 - t, 3);
  function numberTween(from, to, t) { return from + (to - from) * t; }
  function burst(ringEl, colorHue) {
    const n = 12;
    for (let i = 0; i < n; i++) {
      const s = document.createElement('span');
      s.className = 'particle';
      const theta = (i * (360 / n)) + (Math.random() * 10 - 5);
      s.style.setProperty('--theta', theta + 'deg');
      s.style.setProperty('--time', (320 + Math.random() * 240) + 'ms');
      s.style.background = `hsl(${colorHue}, 85%, 50%)`;
      ringEl.appendChild(s);
      setTimeout(() => s.remove(), 700);
    }
  }
  function hueForPct(pct) { return 120 - (pct * 1.2); }

  // Animate a single ring to target percentage; 'label' used for peek
  function animateRingTo(ringEl, valueEl, targetPct, label) {
    const to = Math.max(0, Math.min(100, Number(targetPct) || 0));
    const from = previous.has(ringEl) ? previous.get(ringEl) : 0;

    // If difference is extremely small, still update text & peek so user sees feedback
    if (Math.abs(to - from) < 0.001) {
      if (typeof setRingPct === 'function') setRingPct(ringEl, to);
      if (valueEl) valueEl.textContent = to.toFixed(1) + '%';
      showPeek(ringEl.id || label, label, to);
      previous.set(ringEl, to);
      return;
    }

    const increasing = to > from;
    const overshoot = increasing ? Math.min(100, to + Math.min(8, (to - from) * 0.25)) : to;

    ringEl.classList.remove('flash'); void ringEl.offsetWidth; ringEl.classList.add('flash');

    const start = performance.now();
    const duration = 850;

    function frame(now) {
      const t = Math.min(1, (now - start) / duration);
      const k = easeOutCubic(t);
      const current = numberTween(from, overshoot, k);
      if (typeof setRingPct === 'function') setRingPct(ringEl, current);
      const shown = numberTween(from, to, k);
      if (valueEl) valueEl.textContent = shown.toFixed(1) + '%';

      // Always mirror progress into the peek widget
      showPeek(ringEl.id || label, label, shown);

      if (t < 1) requestAnimationFrame(frame);
      else {
        if (typeof setRingPct === 'function') setRingPct(ringEl, to);
        previous.set(ringEl, to);
        burst(ringEl, hueForPct(to));
        showPeek(ringEl.id || label, label, to);
      }
    }
    requestAnimationFrame(frame);
  }

  const originalUpdate = window.updateScoreRings;
  window.updateScoreRings = function () {
    if (typeof calculateSectionTotals !== 'function') { if (typeof originalUpdate === 'function') try{originalUpdate()}catch{}; return; }
    const totals = calculateSectionTotals();
    const entries = [
      ['Scalp',     'ring-scalp',     'ring-val-scalp'],
      ['Eyebrows',  'ring-eyebrows',  'ring-val-eyebrows'],
      ['Eyelashes', 'ring-eyelashes', 'ring-val-eyelashes'],
      ['Beard',     'ring-beard',     'ring-val-beard'],
    ];
    entries.forEach(([key, ringId, valId]) => {
      const ring = document.getElementById(ringId);
      const val  = document.getElementById(valId);
      if (!ring || !val) return;
      const pct = (totals && totals[key] != null) ? Number(totals[key]) : 0;
      animateRingTo(ring, val, pct, key);
    });

    const progressBar = document.querySelector('#scalp-progress > div');
    if (progressBar) {
      const scalpPct = (totals && totals['Scalp'] != null) ? Number(totals['Scalp']) : 0;
      progressBar.style.width = `${Math.max(0, Math.min(100, scalpPct))}%`;
    }

    if (typeof originalUpdate === 'function') { try { originalUpdate(); } catch {} }
  };

  // Heuristic: detect which region the user is interacting with from the event target
  
  
function detectRegionFromEventTarget(t) {
  // Compose a broad string from the element and a nearby container
  const s = (
    (t.id||'') + ' ' + (t.name||'') + ' ' + (t.className||'') + ' ' +
    (t.getAttribute && (t.getAttribute('aria-label')||'')) + ' ' +
    (t.closest && (t.closest('section, fieldset, .section, .area, .card')?.textContent||''))
  ).toLowerCase();

  // Quick text checks
  if (s.includes('eyebrow') || s.includes('brow')) return 'Eyebrows';
  if (s.includes('eyelash') || s.includes('eyelid')) return 'Eyelashes';
  if (s.includes('beard')) return 'Beard';
  if (s.includes('scalp')) return 'Scalp';

  // Ancestor id/class checks
  if (t.closest('[id*="eyebrow" i], [class*="eyebrow" i], [aria-label*="eyebrow" i]')) return 'Eyebrows';
  if (t.closest('[id*="eyelash" i], [class*="eyelash" i], [aria-label*="eyelash" i], [id*="eyelid" i], [class*="eyelid" i]')) return 'Eyelashes';
  if (t.closest('[id*="beard" i], [class*="beard" i], [aria-label*="beard" i]')) return 'Beard';

  // Scalp sections use ids without the word "scalp" (backside/leftside/rightside/topside).
  // Detect those.
  if (t.closest('[id*="backside" i], [id*="leftside" i], [id*="rightside" i], [id*="topside" i], #androgenetic-areas')) return 'Scalp';
  if (t.closest('[id$="-density" i]')) {
    const id = (t.closest('[id$="-density" i]')?.id||'').toLowerCase();
    if (/(backside|leftside|rightside|topside)-density/.test(id)) return 'Scalp';
  }

  return null;
}



  



function showImmediatePeekFor(region) {
  const map = {
    'Scalp':     ['ring-scalp',     'ring-val-scalp'],
    'Eyebrows':  ['ring-eyebrows',  'ring-val-eyebrows'],
    'Eyelashes': ['ring-eyelashes', 'ring-val-eyelashes'],
    'Beard':     ['ring-beard',     'ring-val-beard'],
  };
  const pair = map[region];
  if (!pair) return;
  const [ringId, valId] = pair;
  const ring = document.getElementById(ringId);
  const val  = document.getElementById(valId);
  if (!ring || !val) return;

  // Authoritative target from calculation
  let target = 0;
  try {
    if (typeof calculateSectionTotals === 'function') {
      const totals = calculateSectionTotals();
      if (totals && totals[region] != null) target = Number(totals[region]) || 0;
      else target = 0;
    } else {
      target = parseFloat((val.textContent||'0').replace('%','')) || 0;
    }
  } catch(_) {
    target = parseFloat((val.textContent||'0').replace('%','')) || 0;
  }

  // Show peek immediately and then animate ring/text
  try { showPeek(ringId, region, target); } catch(_){}
  if (typeof animateRingTo === 'function') {
    try { animateRingTo(ring, val, target, region); } catch(_){}
  }
}

['input','change','click'].forEach(evt => {
  document.addEventListener(evt, (e) => {
    const region = detectRegionFromEventTarget(e.target);
    if (!region) return;
    currentPeekRegion = region;
    clearNonActivePeeks();
    // Defer until after native handlers (toggle* functions) complete
    const run = () => {
      if (typeof window.updateScoreRings === 'function') {
        try { window.updateScoreRings(); } catch {}
      }
      showImmediatePeekFor(region);
    };
    if ('requestAnimationFrame' in window) {
      requestAnimationFrame(() => setTimeout(run, 0));
    } else {
      setTimeout(run, 0);
    }
  }, false); // listen in bubbling phase
});


  window.addEventListener('DOMContentLoaded', () => {
    [['ring-scalp','ring-val-scalp','Scalp'],['ring-eyebrows','ring-val-eyebrows','Eyebrows'],
     ['ring-eyelashes','ring-val-eyelashes','Eyelashes'],['ring-beard','ring-val-beard','Beard']]
      .forEach(([rid, vid]) => {
        const r = document.getElementById(rid);
        const v = document.getElementById(vid);
        if (r && v) {
          const n = parseFloat((v.textContent || '0').replace('%','')) || 0;
          previous.set(r, n);
        }
      });
  });
})();
</script>
<script>
(function(){
  ));
    }
    
    catch (err) {
            // Tainted canvas; hide the image to avoid blocking export
            img.style.display = 'none';
          }
        } catch (e) {
          img.style.display = 'none';
        }
      }
    }

    async function buildAndSavePdf(e){
    try{
      if (e) { e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation(); }
      if (window.__pdfRunning) return;
      window.__pdfRunning = true;

      const now = new Date();
      const datetime = now.toLocaleString();
      const title = "Alopecia Areata Calculator";

      const scalp = (document.getElementById("result")?.innerText || "").replace("Total Scalp Alopecia Areata: ", "");
      const eyebrows = (document.getElementById("eyebrow-title")?.innerText.match(/\((.*?)\)/)||[, "0.00%"])[1];
      const eyelashes = (document.getElementById("eyelash-title")?.innerText.match(/\((.*?)\)/)||[, "0.00%"])[1];
      const beard = (document.getElementById("beard-title")?.innerText.match(/\((.*?)\)/)||[, "0.00%"])[1];

      function getSubtotal(selections, density){
        let total = 0;
        if (selections && typeof selections.forEach === "function") {
          selections.forEach(v => total += Number(v) * (1 - Number(density||0)/100));
        } else if (Array.isArray(selections)) {
          selections.forEach(v => total += Number(v) * (1 - Number(density||0)/100));
        }
        return total.toFixed(2);
      }

      
      const MAX = {
        leftScalp: 17, rightScalp: 17, topScalp: 40, backScalp: 24,
        leftEyebrow: 50, rightEyebrow: 50,
        leftEyelash: 50, rightEyelash: 50,
        leftBeard: 40, rightBeard: 40, centralBeard: 20
      };
      function rel(val, max){ try { return ( (Number(val)||0) / (Number(max)||1) * 100 ).toFixed(2); } catch(e){ return "0.00"; } }
    const leftScalp  = getSubtotal((globalSelections?.leftside||{}).selected,  globalSelections?.leftside?.density);
      const rightScalp = getSubtotal((globalSelections?.rightside||{}).selected, globalSelections?.rightside?.density);
      const topScalp   = getSubtotal((globalSelections?.topside||{}).selected,   globalSelections?.topside?.density);
      const backScalp  = getSubtotal((globalSelections?.backside||{}).selected,  globalSelections?.backside?.density);

      const leftEyebrow  = getSubtotal(eyebrowSelections?.left, 0);
      const rightEyebrow = getSubtotal(eyebrowSelections?.right, 0);

      const leftEyelash  = getSubtotal(eyelashSelections?.left, 0);
      const rightEyelash = getSubtotal(eyelashSelections?.right, 0);

      const leftBeard    = getSubtotal(beardSelections?.["left-beard"]?.selected,    beardSelections?.["left-beard"]?.density);
      const rightBeard   = getSubtotal(beardSelections?.["right-beard"]?.selected,   beardSelections?.["right-beard"]?.density);
      const centralBeard = getSubtotal(beardSelections?.["central-beard"]?.selected, beardSelections?.["central-beard"]?.density);

      const summarySection = document.createElement("div");
      summarySection.id = "pdf-summary";
      summarySection.style.margin = "20px";
      summarySection.style.fontFamily = "'Segoe UI', sans-serif";
      
summarySection.innerHTML = `
        <h2 style='text-align:center;'>${title}</h2>
        <p style='text-align:center;'><em>${datetime}</em></p>
        <hr/>
        
      <h3>Summary of Alopecia Areata Involvement</h3>
        <ul>
          <li><strong>Total Scalp:</strong> ${scalp}</li>
          <li><strong>Total Eyebrows:</strong> ${eyebrows}</li>
          <li><strong>Total Eyelashes:</strong> ${eyelashes}</li>
          <li><strong>Total Beard:</strong> ${beard}</li>${(String(beard).replace('%',''))!=='0.00' && String(beard)!=='0%' ? '' : '<style>#pdf-summary .beard-only{display:none;}.pdf-top-right { position:absolute; top:6px; right:8px; }
</style>'}
        </ul>
        <h3>Detailed Area Breakdown</h3>
        <table id="detail-table" style="width:100%;border-collapse:collapse;">
          <tr><td style="border:1px solid #ccc;padding:6px;">Left Scalp</td><td style="border:1px solid #ccc;padding:6px;">${leftScalp}% (Percentage of the area: ${rel(leftScalp, MAX.leftScalp)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Right Scalp</td><td style="border:1px solid #ccc;padding:6px;">${rightScalp}% (Percentage of the area: ${rel(rightScalp, MAX.rightScalp)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Top of the Head</td><td style="border:1px solid #ccc;padding:6px;">${topScalp}% (Percentage of the area: ${rel(topScalp, MAX.topScalp)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Back of the Head</td><td style="border:1px solid #ccc;padding:6px;">${backScalp}% (Percentage of the area: ${rel(backScalp, MAX.backScalp)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Left Eyebrow</td><td style="border:1px solid #ccc;padding:6px;">${leftEyebrow}% (Percentage of the area: ${rel(leftEyebrow, MAX.leftEyebrow)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Right Eyebrow</td><td style="border:1px solid #ccc;padding:6px;">${rightEyebrow}% (Percentage of the area: ${rel(rightEyebrow, MAX.rightEyebrow)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Left Eyelash</td><td style="border:1px solid #ccc;padding:6px;">${leftEyelash}% (Percentage of the area: ${rel(leftEyelash, MAX.leftEyelash)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Right Eyelash</td><td style="border:1px solid #ccc;padding:6px;">${rightEyelash}% (Percentage of the area: ${rel(rightEyelash, MAX.rightEyelash)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Left Beard Area</td><td style="border:1px solid #ccc;padding:6px;">${leftBeard}% (Percentage of the area: ${rel(leftBeard, MAX.leftBeard)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Right Beard Area</td><td style="border:1px solid #ccc;padding:6px;">${rightBeard}% (Percentage of the area: ${rel(rightBeard, MAX.rightBeard)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Central Beard Area</td><td style="border:1px solid #ccc;padding:6px;">${centralBeard}% (Percentage of the area: ${rel(centralBeard, MAX.centralBeard)}%)</td></tr>
        </table>
        `;

      
      
      // Build exactly one Dominant pattern / Scalp change line for the PDF
      try {
        // Remove any existing line from prior runs
        Array.from(summarySection.querySelectorAll('#pdf-dominant-line')).forEach(n=>n.remove());
        const patText = (document.getElementById('pattern-dominant')?.textContent || '').trim();
        let changeText = '';
        if (typeof window.__baselineScalpPct === 'number' && typeof calculateSectionTotals === 'function') {
          try {
            const cur = Number(calculateSectionTotals().Scalp);
            if (Number.isFinite(cur)) {
              const d = window.__baselineScalpPct - cur;
              if (d !== 0) {
                const abs = Math.abs(d).toFixed(1).replace(/\.0$/, '');
                changeText = d > 0 ? ('Scalp improvement: ' + abs + '%') : ('Scalp worsening: ' + abs + '%');
              }
            }
          } catch(e){}
        }
        const lineText = [patText ? ('Dominant pattern: ' + patText + '.') : '', changeText].filter(Boolean).join(' ');
        if (lineText) {
          const p = document.createElement('p');
          p.id = 'pdf-dominant-line';
          p.style.textAlign = 'center';
          p.style.fontWeight = '600';
          p.style.margin = '6px 0 0 0';
          p.textContent = lineText;
          // Insert after the timestamp (<em>${datetime}</em>) if present, else at top
          const timeP = summarySection.querySelector('p em');
          if (timeP && timeP.parentElement) {
            timeP.parentElement.insertAdjacentElement('afterend', p);
          } else {
            summarySection.prepend(p);
          }
        }
        // Beard gating in PDF
        const beardNum = (function(v){
          if (typeof v === 'number') return v;
          const n = parseFloat(String(v||'').replace('%',''));
          return isNaN(n) ? 0 : n;
        })(typeof beard !== 'undefined' ? beard : 0);
        if (beardNum === 0) {
          // Remove total beard line
          const totalLi = Array.from(summarySection.querySelectorAll('ul li')).find(li => /Total\s*Beard/i.test(li.textContent||''));
          if (totalLi) totalLi.remove();
          // Remove beard detail lines
          Array.from(summarySection.querySelectorAll('ul li')).forEach(li => {
            if (/Left\s*Beard\s*Area|Right\s*Beard\s*Area|Central\s*Beard\s*Area/i.test(li.textContent||'')) li.remove();
          });
        }
      } catch(e) {}
    // Normalize dominant line to a single instance and hide beard items when beard == 0
      try {
        // Remove duplicate dominant line nodes, keep the first
        const _dups = summarySection.querySelectorAll('#pdf-dominant-line');
        for (let i = 1; i < _dups.length; i++) { _dups[i].remove(); }

        // Beard gating
        const beardNum = (function(v){
          if (typeof v === 'number') return v;
          if (typeof v === 'string') {
            const n = parseFloat(v.replace('%',''));
            return isNaN(n) ? 0 : n;
          }
          return 0;
        })(typeof beard !== 'undefined' ? beard : 0);

        if (beardNum === 0) {
          // remove Total Beard line
          const totalLi = Array.from(summarySection.querySelectorAll('ul li')).find(li => /Total\s*Beard/i.test(li.textContent||''));
          if (totalLi) totalLi.remove();

          // remove beard detail lines
          Array.from(summarySection.querySelectorAll('ul li')).forEach(li => {
            if (/Left\s*Beard\s*Area|Right\s*Beard\s*Area|Central\s*Beard\s*Area/i.test(li.textContent||'')) {
              li.remove();
            }
          });
        }
      } catch(_e) {}
const preview = document.getElementById("selected-preview")?.cloneNode(true);
      document.body.appendChild(summarySection);
      // Ensure images can be rendered by html2canvas when loaded from another origin
      try {
        summarySection.querySelectorAll('img').forEach(img => {
          if (!img.getAttribute('crossorigin')) img.setAttribute('crossorigin', 'anonymous');
          // If images are data: URLs this has no effect, but it is safe.
        });
      } catch(e) {}
    
      html2pdf().set({
        margin: 10,
        filename: 'alopecia_areata_summary_with_details.pdf',
        html2canvas: { scale: 2, useCORS: true, allowTaint: false, imageTimeout: 15000 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      }).from(summarySection).save()
      .then(() => { /* success */ })
      .catch((err) => { console && console.warn && console.warn('PDF export failed:', err); })
      .finally(() => { try { document.body.removeChild(summarySection); } catch(e) {} window.__pdfRunning = false; });
    }catch(err){ window.__pdfRunning = false; }
    return false;
  }

  function install(){
    const btn = document.getElementById("generate-pdf");
    if (!btn) return;
    const clone = btn.cloneNode(true); // strips all listeners
    btn.parentNode.replaceChild(clone, btn);
    clone.addEventListener("click", (ev)=>{ buildAndSavePdf(ev); }, true); // capture
  }

  if (document.readyState === "complete" || document.readyState === "interactive") {
    setTimeout(install, 0);
  } else {
    document.addEventListener("DOMContentLoaded", install);
  }
})();
</script>
<script>
(function(){
  function buildAndSavePdf(e){
    try {
      if (e) { e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation(); }
      if (window.__pdfRunning) return false;
      window.__pdfRunning = true;

      const now = new Date();
      const datetime = now.toLocaleString();
      const title = "Alopecia Areata Calculator";

      const scalp = (document.getElementById("result")?.innerText || "").replace("Total Scalp Alopecia Areata: ", "");
      const eyebrows = (document.getElementById("eyebrow-title")?.innerText.match(/\((.*?)\)/)||[, "0.00%"])[1];
      const eyelashes = (document.getElementById("eyelash-title")?.innerText.match(/\((.*?)\)/)||[, "0.00%"])[1];
      const beard = (document.getElementById("beard-title")?.innerText.match(/\((.*?)\)/)||[, "0.00%"])[1];

      function getSubtotal(selections, density){
        let total = 0;
        if (selections && typeof selections.forEach === "function") {
          selections.forEach(v => total += Number(v) * (1 - Number(density||0)/100));
        } else if (Array.isArray(selections)) {
          selections.forEach(v => total += Number(v) * (1 - Number(density||0)/100));
        }
        return total.toFixed(2);
      }

      // Compute detailed values
      const leftScalp  = getSubtotal((globalSelections?.leftside||{}).selected,  globalSelections?.leftside?.density);
      const rightScalp = getSubtotal((globalSelections?.rightside||{}).selected, globalSelections?.rightside?.density);
      const topScalp   = getSubtotal((globalSelections?.topside||{}).selected,   globalSelections?.topside?.density);
      const backScalp  = getSubtotal((globalSelections?.backside||{}).selected,  globalSelections?.backside?.density);

      const leftEyebrow  = getSubtotal(eyebrowSelections?.left, 0);
      const rightEyebrow = getSubtotal(eyebrowSelections?.right, 0);

      const leftEyelash  = getSubtotal(eyelashSelections?.left, 0);
      const rightEyelash = getSubtotal(eyelashSelections?.right, 0);

      const leftBeard    = getSubtotal(beardSelections?.["left-beard"]?.selected,    beardSelections?.["left-beard"]?.density);
      const rightBeard   = getSubtotal(beardSelections?.["right-beard"]?.selected,   beardSelections?.["right-beard"]?.density);
      const centralBeard = getSubtotal(beardSelections?.["central-beard"]?.selected, beardSelections?.["central-beard"]?.density);

      const MAX = {
        leftScalp: 17, rightScalp: 17, topScalp: 40, backScalp: 24,
        leftEyebrow: 50, rightEyebrow: 50,
        leftEyelash: 50, rightEyelash: 50,
        leftBeard: 40, rightBeard: 40, centralBeard: 20
      };
      function pctArea(val, max){ try { return ( (Number(val)||0) / (Number(max)||1) * 100 ).toFixed(2); } catch(e){ return "0.00"; } }

      // Compose export section (no pictures)
      const section = document.createElement("div");
      section.id = "pdf-summary";
      section.style.margin = "20px";
      section.style.fontFamily = "'Segoe UI', sans-serif";
      section.innerHTML = `
        <h2 style='text-align:center;'>${title}</h2>
        <p style='text-align:center;'><em>${datetime}</em></p>
        <hr/>
        <h3>Summary of Alopecia Areata Involvement</h3>
        <ul>
          <li><strong>Total Scalp:</strong> ${scalp}</li>
          <li><strong>Total Eyebrows:</strong> ${eyebrows}</li>
          <li><strong>Total Eyelashes:</strong> ${eyelashes}</li>
          <li><strong>Total Beard:</strong> ${beard}</li>${(String(beard).replace('%',''))!=='0.00' && String(beard)!=='0%' ? '' : '<style>#pdf-summary .beard-only{display:none;}.pdf-top-right { position:absolute; top:6px; right:8px; }
</style>'}
        </ul>
        <h3>Detailed Area Breakdown</h3>
        <table style="width:100%;border-collapse:collapse;">
          <tr><td style="border:1px solid #ccc;padding:6px;">Left Scalp</td><td style="border:1px solid #ccc;padding:6px;">${leftScalp}% (Percentage of the area: ${pctArea(leftScalp, MAX.leftScalp)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Right Scalp</td><td style="border:1px solid #ccc;padding:6px;">${rightScalp}% (Percentage of the area: ${pctArea(rightScalp, MAX.rightScalp)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Top of the Head</td><td style="border:1px solid #ccc;padding:6px;">${topScalp}% (Percentage of the area: ${pctArea(topScalp, MAX.topScalp)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Back of the Head</td><td style="border:1px solid #ccc;padding:6px;">${backScalp}% (Percentage of the area: ${pctArea(backScalp, MAX.backScalp)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Left Eyebrow</td><td style="border:1px solid #ccc;padding:6px;">${leftEyebrow}% (Percentage of the area: ${pctArea(leftEyebrow, MAX.leftEyebrow)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Right Eyebrow</td><td style="border:1px solid #ccc;padding:6px;">${rightEyebrow}% (Percentage of the area: ${pctArea(rightEyebrow, MAX.rightEyebrow)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Left Eyelash</td><td style="border:1px solid #ccc;padding:6px;">${leftEyelash}% (Percentage of the area: ${pctArea(leftEyelash, MAX.leftEyelash)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Right Eyelash</td><td style="border:1px solid #ccc;padding:6px;">${rightEyelash}% (Percentage of the area: ${pctArea(rightEyelash, MAX.rightEyelash)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Left Beard Area</td><td style="border:1px solid #ccc;padding:6px;">${leftBeard}% (Percentage of the area: ${pctArea(leftBeard, MAX.leftBeard)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Right Beard Area</td><td style="border:1px solid #ccc;padding:6px;">${rightBeard}% (Percentage of the area: ${pctArea(rightBeard, MAX.rightBeard)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Central Beard Area</td><td style="border:1px solid #ccc;padding:6px;">${centralBeard}% (Percentage of the area: ${pctArea(centralBeard, MAX.centralBeard)}%)</td></tr>
        </table>
      `;

      document.body.appendChild(section);
      html2pdf().set({
        margin: 10,
        filename: 'alopecia_areata_summary_without_pictures.pdf',
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      
  // Add "Dominant pattern and change" line into the temporary section before export
  try {
    var extra2 = document.createElement('div');
    extra2.id = 'pdf-extra-line';
    extra2.style.marginTop = '8px';
    extra2.style.fontWeight = '600';
    var patNode2 = document.getElementById('pattern-dominant');
    var patText2 = patNode2 && patNode2.textContent ? patNode2.textContent.trim() : '';
    var line2 = patText2 ? ('Dominant pattern: ' + patText2 + '.') : '';
    if (typeof window.__baselineScalpPct === 'number' && typeof calculateSectionTotals === 'function') {
      try {
        var cur2 = Number(calculateSectionTotals().Scalp);
        if (Number.isFinite(cur2)) {
          var d2 = window.__baselineScalpPct - cur2;
          if (d2 !== 0) {
            var abs2 = Math.abs(d2).toFixed(1).replace(/\.0$/, '');
            line2 += (line2 ? ' ' : '') + (d2 > 0 ? ('Scalp improvement: ' + abs2 + '%') : ('Scalp worsening: ' + abs2 + '%'));
          }
        }
      } catch(e){}
    }
    if (line2) { extra2.textContent = line2; extra2.style.padding = "4px 0"; if (section.firstChild) { section.insertBefore(extra2, section.firstChild); } else { section.appendChild(extra2); } }
  } catch(e){}
}).from(section).save().catch(
(err)=>{ console && console.warn && console.warn('PDF export failed:', err); })
        .finally(()=>{ try { document.body.removeChild(section); } catch(e) {} window.__pdfRunning = false; });
    } catch (err) { window.__pdfRunning = false; }
    return false;
  }

  function install(){
    const btn = document.getElementById("generate-pdf");
    if (!btn) return;
    const clone = btn.cloneNode(true);   // strips ALL previous listeners
    btn.parentNode.replaceChild(clone, btn);
    clone.addEventListener("click", buildAndSavePdf, true); // capture phase
  }

  if (document.readyState === "complete" || document.readyState === "interactive") {
    setTimeout(install, 0);
  } else {
    document.addEventListener("DOMContentLoaded", install);
  }
})();
</script>
<div id="shortcode-controls" style="display:flex; align-items:center; justify-content:center; gap:12px; padding:20px 0;"><button class="btn-blue" id="btnCopyCode18">📋 Copy Score</button><input id="codeInput" placeholder="Paste score code here" style="width: 300px; margin: 5px;"/><button class="btn-blue" id="btnLoadCode18">📥 Load Score</button></div><script>
(function(){
  // 52-symbol alphabet: uppercase + lowercase
  const ALPHA = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";

  // Densities used on the UI
  const DENSITIES = [0,10,25,50,75,90];

  // Helpers
  function valuesFromAreas(areas){
    const set = new Set();
    (areas||[]).forEach(a => {
      if (typeof a.value === "number") set.add(+a.value);
      if (typeof a.plus === "number") set.add(+a.plus);
      if (typeof a.minus === "number") set.add(+a.minus);
    });
    return Array.from(set).sort((a,b)=>a-b).map(v => +Number(v).toFixed(2));
  }
  function idx52(list, val){
    const x = +Number(val).toFixed(2);
    for (let i=0;i<list.length;i++){
      if (Math.abs(list[i]-x) < 1e-6) return i;
    }
    // nearest fallback
    let best=0, d=Infinity;
    for (let i=0;i<list.length;i++){
      const dd = Math.abs(list[i]-x);
      if (dd<d){ d=dd; best=i; }
    }
    return best;
  }
  function enc52(i){ if (i<0 || i>=52) throw new Error("index>52"); return ALPHA[i]; }
  function dec52(ch){ const i = ALPHA.indexOf(ch); if (i<0) throw new Error("bad char"); return i; }
  function sumMod52(arr){ let s=0; for (const x of arr) s=(s + (x|0)) % 52; return s; }

  // Allowed ladders derived from existing config objects
  const scalpAllowed = {
    backside: valuesFromAreas((typeof scalpSections!=='undefined' && scalpSections.backside && scalpSections.backside.areas) || []),
    leftside: valuesFromAreas((typeof scalpSections!=='undefined' && scalpSections.leftside && scalpSections.leftside.areas) || []),
    rightside: valuesFromAreas((typeof scalpSections!=='undefined' && scalpSections.rightside && scalpSections.rightside.areas) || []),
    topside: valuesFromAreas((typeof scalpSections!=='undefined' && scalpSections.topside && scalpSections.topside.areas) || []),
  };
  const browAllowed  = valuesFromAreas((typeof eyebrowAreas!=='undefined' && eyebrowAreas) || []);
  const lashAllowed  = browAllowed.slice();
  const beardAllowed = {
    "right-beard":  valuesFromAreas((typeof beardSections!=='undefined' && beardSections["right-beard"]  && beardSections["right-beard"].areas)  || []),
    "left-beard":   valuesFromAreas((typeof beardSections!=='undefined' && beardSections["left-beard"]   && beardSections["left-beard"].areas)   || []),
    "central-beard":valuesFromAreas((typeof beardSections!=='undefined' && beardSections["central-beard"]&& beardSections["central-beard"].areas)|| []),
  };

  // Read current density from DOM (selected button) with state fallback
  function readDensity(sectionId){
    const cont = document.getElementById(sectionId + "-density");
    if (cont){
      const btn = cont.querySelector("button.selected[data-density]");
      if (btn) return +btn.getAttribute("data-density");
    }
    try { return (globalSelections && globalSelections[sectionId] && +globalSelections[sectionId].density) || 0; } catch(e){ return 0; }
  }
  function setDensityUI(sectionId, density){
    const cont = document.getElementById(sectionId + "-density");
    if (cont){
      cont.querySelectorAll("button[data-density]").forEach(b=>b.classList.remove("selected"));
      const match = cont.querySelector(`button[data-density="${density}"]`);
      if (match) match.classList.add("selected");
    }
  }
  function getSingleFromSet(s){ const arr = Array.from(s||[]); return arr.length? +Number(arr[0]).toFixed(2) : 0; }

  // Read scalars
  function readScalars(){
    const s = {
      back:   { density: readDensity('backside'),  score: getSingleFromSet(globalSelections?.backside?.selected) },
      left:   { density: readDensity('leftside'),  score: getSingleFromSet(globalSelections?.leftside?.selected) },
      right:  { density: readDensity('rightside'), score: getSingleFromSet(globalSelections?.rightside?.selected) },
      top:    { density: readDensity('topside'),   score: getSingleFromSet(globalSelections?.topside?.selected) },
      browR:  { score: getSingleFromSet(eyebrowSelections?.right) },
      browL:  { score: getSingleFromSet(eyebrowSelections?.left) },
      lashR:  { score: getSingleFromSet(eyelashSelections?.right) },
      lashL:  { score: getSingleFromSet(eyelashSelections?.left) },
      beardR: { density: (beardSelections?.["right-beard"]?.density)||0,  score: getSingleFromSet(beardSelections?.["right-beard"]?.selected) },
      beardL: { density: (beardSelections?.["left-beard"]?.density)||0,   score: getSingleFromSet(beardSelections?.["left-beard"]?.selected) },
      beardC: { density: (beardSelections?.["central-beard"]?.density)||0,score: getSingleFromSet(beardSelections?.["central-beard"]?.selected) },
    };
    return s;
  }

  // Apply helpers
  function setScalp(sectionId, densityIdx, scoreIdx){
    const dens = DENSITIES[Math.max(0, Math.min(DENSITIES.length-1, densityIdx))] ?? 0;
    if (globalSelections && globalSelections[sectionId]){
      globalSelections[sectionId].density = dens;
      const allowed = scalpAllowed[sectionId] || [0];
      const val = allowed[Math.max(0, Math.min(allowed.length-1, scoreIdx))] || 0;
      globalSelections[sectionId].selected.clear();
      if (val > 0) {
        globalSelections[sectionId].selected.add(val);
      }
    }
    setDensityUI(sectionId, dens);
  }
  function setBrow(side, scoreIdx){
    const val = browAllowed[Math.max(0, Math.min(browAllowed.length-1, scoreIdx))] || 0;
    if (eyebrowSelections && eyebrowSelections[side]){
      eyebrowSelections[side].clear();
      if (val > 0) {
        eyebrowSelections[side].add(val);
      }
    }
  }
  function setLash(side, scoreIdx){
    const val = lashAllowed[Math.max(0, Math.min(lashAllowed.length-1, scoreIdx))] || 0;
    if (eyelashSelections && eyelashSelections[side]){
      eyelashSelections[side].clear();
      if (val > 0) {
        eyelashSelections[side].add(val);
      }
    }
  }
  function setBeard(sectionId, densityIdx, scoreIdx){
    const dens = DENSITIES[Math.max(0, Math.min(DENSITIES.length-1, densityIdx))] ?? 0;
    if (beardSelections && beardSelections[sectionId]){
      beardSelections[sectionId].density = dens;
      const allowed = beardAllowed[sectionId] || [0];
      const val = allowed[Math.max(0, Math.min(allowed.length-1, scoreIdx))] || 0;
      beardSelections[sectionId].selected.clear();
      if (val > 0) {
        beardSelections[sectionId].selected.add(val);
      }
    }
    setDensityUI(sectionId, dens); // if density buttons exist for beard
  }

  // Encode 18-character
  window.encodeAA18 = function(){
    const s = readScalars();
    const idxs = [];
    // Densities and scores in fixed order
    idxs.push( idx52(DENSITIES, s.back.density) );
    idxs.push( idx52(scalpAllowed.backside, s.back.score) );
    idxs.push( idx52(DENSITIES, s.left.density) );
    idxs.push( idx52(scalpAllowed.leftside, s.left.score) );
    idxs.push( idx52(DENSITIES, s.right.density) );
    idxs.push( idx52(scalpAllowed.rightside, s.right.score) );
    idxs.push( idx52(DENSITIES, s.top.density) );
    idxs.push( idx52(scalpAllowed.topside, s.top.score) );
    idxs.push( idx52(browAllowed, s.browR.score) );
    idxs.push( idx52(browAllowed, s.browL.score) );
    idxs.push( idx52(lashAllowed, s.lashR.score) );
    idxs.push( idx52(lashAllowed, s.lashL.score) );
    idxs.push( idx52(DENSITIES, s.beardR.density) );
    idxs.push( idx52(beardAllowed["right-beard"], s.beardR.score) );
    idxs.push( idx52(DENSITIES, s.beardL.density) );
    idxs.push( idx52(beardAllowed["left-beard"], s.beardL.score) );
    idxs.push( idx52(DENSITIES, s.beardC.density) );
    idxs.push( idx52(beardAllowed["central-beard"], s.beardC.score) );
    return idxs.map(enc52).join("");
  };

  // Encode 19-character with checksum
  window.encodeAA19 = function(){
    const code18 = window.encodeAA18();
    const idxs = code18.split("").map(dec52);
    const chk = sumMod52(idxs);
    return code18 + enc52(chk);
  };

  // Apply from 18 chars
  window.applyAA18 = function(code){
    try { window.__patternDirty = false; } catch(e) {}

    if (!code || code.length!==18) throw new Error("needs 18 chars");
    const a = code.split("").map(dec52);
    let i=0;
    setScalp('backside', a[i++], a[i++]);
    setScalp('leftside',  a[i++], a[i++]);
    setScalp('rightside', a[i++], a[i++]);
    setScalp('topside',   a[i++], a[i++]);
    setBrow('right', a[i++]);
    setBrow('left',  a[i++]);
    setLash('right', a[i++]);
    setLash('left',  a[i++]);
    setBeard('right-beard',  a[i++], a[i++]);
    setBeard('left-beard',   a[i++], a[i++]);
    setBeard('central-beard',a[i++], a[i++]);
    if (typeof updateScalpUI==='function') updateScalpUI();
    if (typeof updateEyebrowUI==='function') updateEyebrowUI();
    if (typeof updateEyelashUI==='function') updateEyelashUI();
    if (typeof updateBeardUI==='function') updateBeardUI();
    if (typeof updateScoreRings==='function') updateScoreRings();
    if (typeof updateSummaryUI==='function') updateSummaryUI();
  };

  // Apply from 19 with checksum
  window.applyAA19 = function(code){
    try { window.__patternDirty = false; } catch(e) {}

    if (!code || code.length!==19) throw new Error("needs 19 chars");
    const idxs = code.split("").map(dec52);
    const data = idxs.slice(0,18);
    const chk  = idxs[18];
    const want = sumMod52(data);
    if (chk !== want) throw new Error("checksum mismatch");
    window.applyAA18(code.slice(0,18));
  };

  // Wire buttons
  function copyToClipboard(text){
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
  }
  function byId(id){ return document.getElementById(id); }
  function init(){
    const input = byId('codeInput');
    const bCopy18 = byId('btnCopyCode18');
    const bLoad18 = byId('btnLoadCode18');
    const bCopy19 = byId('btnCopyCode19');
    const bLoad19 = byId('btnLoadCode19');

    if (bCopy18) bCopy18.onclick = () => {
      try {
        const code = encodeAA18();
        if (input) input.value = code;
        copyToClipboard(code);
        
      } catch(e){ alert("Could not generate code."); }
    };
    if (bLoad18) bLoad18.onclick = () => {
      try {
        const v = (input && input.value || '').trim();
        applyAA18(v);
        
      } catch(e){ alert("Invalid 18-char code."); }
    };
    
    
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();
</script>



<script>
/* Robust selection marker for AGA options:
   - Works for .aga-option, [data-aga-option], [data-value], and .area-box inside #aga-score
   - Adds .selected to the chosen element
   - Updates window.androgeneticScore and triggers updateScalpUI */
(function(){
  function findAGAButtons(){
    const root = document.getElementById('aga-score') || document;
    return root.querySelectorAll('#aga-score .aga-option, #aga-score [data-aga-option], #aga-score [data-value], #aga-score .area-box');
  }
  function valueOf(el){
    const v = el.getAttribute('data-value') || el.dataset?.value || el.value;
    const num = parseFloat(v);
    return isNaN(num) ? null : num;
  }
  function applySelected(value){
    const btns = findAGAButtons();
    btns.forEach(b => {
      const v = valueOf(b);
      if (v !== null && v === value) b.classList.add('selected'); else b.classList.remove('selected');
    });
  }
  function init(){
    const btns = findAGAButtons();
    if (!btns.length) return;
    btns.forEach(btn => {
      btn.addEventListener('click', function(){
        const v = valueOf(this);
        if (v === null) return;
        window.androgeneticScore = v;
        applySelected(v);
        if (typeof window.updateScalpUI === 'function') { try { window.updateScalpUI(); } catch(e){} }
      });
    });
    // Initialize from any pre-set global
    const initial = (typeof window.androgeneticScore === 'number') ? window.androgeneticScore : null;
    if (initial !== null && initial > 0) {
      applySelected(initial);
    } else {
      try {
        if (!globalSelections['androgenetic']) globalSelections['androgenetic'] = { selected: new Set(), density: 0 };
        globalSelections['androgenetic'].selected = new Set();
        const boxes = document.querySelectorAll('#androgenetic-areas .area-box');
        boxes.forEach(b => b.classList.remove('selected'));
      } catch(e) {}
    }
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();
})();
</script>






<script>
/* Keep the androgenetic option's tooltip visible as the label until another option is chosen. */
(function(){
  function refreshAgaTooltip(){
    const root = document.getElementById('androgenetic-areas');
    if (!root) return;
    // Hide all AGA tooltips first
    root.querySelectorAll('.tooltip').forEach(t => { t.style.display = 'none'; });
    // Find the selected box
    const sel = root.querySelector('.area-box.selected');
    if (!sel) return;
    // If plus/minus is the active choice, prefer its tooltip; else show the main box tooltip
    let tipToShow = null;
    if (sel.querySelector('.plus.glow')) {
      // plus tooltip is usually appended to the same box; choose the last tooltip or one with recognizable content
      const tips = sel.querySelectorAll('.tooltip');
      tipToShow = tips[tips.length - 1] || null;
    } else if (sel.querySelector('.minus.glow')) {
      const tips = sel.querySelectorAll('.tooltip');
      tipToShow = tips[tips.length - 1] || null;
    } else {
      tipToShow = sel.querySelector('.tooltip');
    }
    if (tipToShow) tipToShow.style.display = 'block';
  }

  // Patch updateScalpUI so our behavior runs after the app updates selection
  const orig = window.updateScalpUI;
  window.updateScalpUI = function(){
    if (typeof orig === 'function') { try { orig(); } catch(e){} }
    try { refreshAgaTooltip(); } catch(e){}
  };

  // Also run once on load in case a default selection exists
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function(){ try { refreshAgaTooltip(); } catch(e){} });
  } else {
    try { refreshAgaTooltip(); } catch(e){}
  }
})();
</script>

<script>
/* AGA persistent tooltip click augmentation.
   - On click inside #androgenetic-areas, mark the clicked box as selected,
     unselect others, and show its tooltip.
   - Because hideTip() in your code keeps tooltip visible when .selected is present,
     the tooltip will persist after mouseleave.
*/
(function(){
  function findBox(el){
    return el && el.closest ? el.closest('#androgenetic-areas .area-box') : null;
  }
  function showOnlyThisBoxTooltip(box){
    const root = document.getElementById('androgenetic-areas');
    if (!root || !box) return;
    // Hide all tooltips in AGA section
    root.querySelectorAll('.tooltip').forEach(t => t.style.display = 'none');
    // Prefer tooltip for the hovered/active element if any, otherwise first tooltip in the box
    // We simply show the first tooltip appended to the box to avoid assumptions.
    const tip = box.querySelector('.tooltip');
    if (tip) tip.style.display = 'block';
  }
  function onClick(ev){
    const box = findBox(ev.target);
    if (!box) return;
    const root = document.getElementById('androgenetic-areas');
    if (!root) return;
    // Unselect others, then select this one
    root.querySelectorAll('.area-box.selected').forEach(b => b.classList.remove('selected'));
    box.classList.add('selected');
    // Show its tooltip and keep it (mouseleave handler won't hide because .selected is present)
    showOnlyThisBoxTooltip(box);
  }
  // Attach after DOM is ready
  function attach(){
    const root = document.getElementById('androgenetic-areas');
    if (!root) return;
    root.addEventListener('click', onClick, true); // capture to run before any global hides
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', attach);
  } else {
    attach();
  }
})();
</script>

<script>
(function(){
  function refreshAgaTooltip(){
    const root = document.getElementById('androgenetic-areas');
    if (!root) return;
    // hide all AGA tooltips first
    root.querySelectorAll('.tooltip').forEach(t => t.style.display = 'none');
    const sel = root.querySelector('.area-box.selected');
    if (!sel) return;
    let tipToShow = null;
    if (sel.querySelector('.plus.glow')) {
      tipToShow = sel.querySelector('.tooltip[data-role="plus"]');
    } else if (sel.querySelector('.minus.glow')) {
      tipToShow = sel.querySelector('.tooltip[data-role="minus"]');
    } else {
      tipToShow = sel.querySelector('.tooltip[data-role="main"]');
    }
    if (tipToShow) tipToShow.style.display = 'block';
  }

  // Expose for other code paths
  window.refreshAgaTooltip = refreshAgaTooltip;

  // Hook: after any global UI refresh, also refresh AGA tooltip
  const prevUpdate = window.updateScalpUI;
  window.updateScalpUI = function(){
    if (typeof prevUpdate === 'function') { try { prevUpdate(); } catch(e){} }
    try { refreshAgaTooltip(); } catch(e){}
  };

  // Run once on load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', refreshAgaTooltip);
  } else {
    refreshAgaTooltip();
  }
})();
</script>





<script>
(function(){
  function ensureCopyButton(){
    // If already there, nothing to do
    if (document.getElementById('copy-summary')) return;
    // Preferred anchor: the PDF button
    var pdfBtn = document.getElementById('generate-pdf');
    var btn = document.createElement('button');
    btn.id = 'copy-summary';
    btn.type = 'button';
    btn.textContent = 'Copy summary';
    btn.style.marginLeft = '8px';
    btn.style.padding = '8px 12px';
    btn.style.border = '1px solid #cbd5e1';
    btn.style.borderRadius = '8px';
    btn.style.cursor = 'pointer';
    btn.style.background = 'white';
    btn.style.boxShadow = '0 1px 2px rgba(0,0,0,.05)';
    if (pdfBtn && pdfBtn.parentNode) {
      pdfBtn.parentNode.insertBefore(btn, pdfBtn.nextSibling);
    } else {
      // Fallback: place at top of page
      var host = document.body || document.documentElement;
      host.insertBefore(btn, host.firstChild);
    }

    // Click handler - same summary formatting + code
    btn.addEventListener('click', async function(){
      function writeClipboard(text){
        if (navigator.clipboard && navigator.clipboard.writeText) {
          return navigator.clipboard.writeText(text).then(()=>true).catch(()=>false);
        } else {
          try {
            const ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            return true;
          } catch(e){ return false; }
        }
      }
      function getTotals(){
        try { return calculateSectionTotals && calculateSectionTotals(); } catch(e){}
        return { Scalp: 0, Eyebrows: 0, Eyelashes: 0, Beard: 0 };
      }
      const totals = getTotals();
      const now = new Date();
      const dt = now.toLocaleString();
      const lines = [];
      lines.push('Alopecia Areata Calculator');
      lines.push(dt);
      lines.push('');
      lines.push('Summary of Alopecia Areata Involvement');
      lines.push(`- Total Scalp: ${Number(totals.Scalp).toFixed(0)}%`);

    // Append scalp change if baseline exists and non-zero (works with totals.Scalp or totals.scalp)
    (function(){ try {
      if (typeof window.__baselineScalpPct === 'number') {
        const __cur = (typeof totals === 'object') ? (('Scalp' in totals ? totals.Scalp : (('scalp' in totals) ? totals.scalp : null))) : null;
        const __val = Number(__cur);
        if (Number.isFinite(__val)) {
          const __delta = window.__baselineScalpPct - __val;
          if (__delta !== 0) {
            const __abs = Math.abs(__delta).toFixed(1).replace(/\.0$/, '');
            if (__delta > 0) { lines.push(`- Scalp improvement: ${__abs}%`); }
            else { lines.push(`- Scalp worsening: ${__abs}%`); }
          }
        }
      }
    } catch(__e){} })();
// Include percentage change if a code baseline exists and only when non-zero
if (typeof window.__baselineScalpPct === 'number') {
  const delta = window.__baselineScalpPct - Number(totals.Scalp);
  if (delta !== 0) {
    const abs = Math.abs(delta).toFixed(1).replace(/\.0$/, '');
    if (delta > 0) {
      lines.push(`- Scalp improvement: ${abs}%`);
    } else {
      lines.push(`- Scalp worsening: ${abs}%`);
    }
  }
}

      // Include percentage change if a code baseline exists
      if (typeof window.__baselineScalpPct === 'number') {
        const delta = window.__baselineScalpPct - Number(totals.Scalp);
        const abs = Math.abs(delta).toFixed(1).replace(/\.0$/, '');
        if (delta > 0) {
          lines.push(`- Scalp improvement: ${abs}%`);
        } else if (delta < 0) {
          lines.push(`- Scalp worsening: ${abs}%`);
        } else {
          lines.push(`- Scalp improvement: 0%`);
        }
      }

      lines.push(`- Total Eyebrows: ${Number(totals.Eyebrows).toFixed(0)}%`);
      lines.push(`- Total Eyelashes: ${Number(totals.Eyelashes).toFixed(0)}%`);
      if (Number(totals.Beard) > 0) lines.push(`- Total Beard: ${Number(totals.Beard).toFixed(0)}%`);
      try {
        if (typeof window.encodeAA19 === 'function') {
          const code = window.encodeAA19();
          lines.push(`Code: ${code}`);
        }
      } catch(e){}
      lines.push('');
      const ok = await writeClipboard(lines.join('\
'));
      if (ok) { btn.textContent = 'Copied!'; setTimeout(()=>btn.textContent='Copy summary', 1200); }
      else { alert('Copy failed'); }
    });
  }
  function boot(){
    try { ensureCopyButton(); } catch(e){}
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', boot);
  } else {
    boot();
  }
  // Also retry a few times in case the PDF button is injected late
  let attempts = 0;
  const iv = setInterval(function(){
    attempts++;
    if (document.getElementById('copy-summary')) { clearInterval(iv); return; }
    try { ensureCopyButton(); } catch(e){}
    if (attempts > 20) clearInterval(iv);
  }, 300);
})();
</script>





<script>
(function(){
  function writeClipboard(text){
    if (navigator.clipboard && navigator.clipboard.writeText) {
      return navigator.clipboard.writeText(text).then(()=>true).catch(()=>false);
    }
    try {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      return true;
    } catch(e){ return false; }
  }

  function getTotalsSafe(){
    try {
      if (typeof calculateSectionTotals === 'function') return calculateSectionTotals();
    } catch(e){}
    return { Scalp: 0, Eyebrows: 0, Eyelashes: 0, Beard: 0 };
  }

  function getCodeSafe(){
    try {
      if (typeof window.encodeAA19 === 'function') return String(window.encodeAA19()||'');
      if (typeof window.encodeAA18 === 'function' && typeof window.dec52==='function' && typeof window.enc52==='function' && typeof window.sumMod52==='function') {
        const c18 = window.encodeAA18();
        const idxs = c18.split('').map(window.dec52);
        const chk = window.sumMod52(idxs);
        return c18 + window.enc52(chk);
      }
    } catch(e){}
    return '';
  }

  function buildSummary(){
    const totals = getTotalsSafe();
    const now = new Date();
    const dt = now.toLocaleString();
    const L = [];
    L.push('Alopecia Areata Calculator');
    L.push(dt);
    L.push('');
    L.push('Summary of Alopecia Areata Involvement');
    L.push(`- Total Scalp: ${Math.round(Number(totals.Scalp)||0)}%`);
    L.push(`- Total Eyebrows: ${Math.round(Number(totals.Eyebrows)||0)}%`);
    L.push(`- Total Eyelashes: ${Math.round(Number(totals.Eyelashes)||0)}%`);
    if ((Number(totals.Beard)||0) > 0) L.push(`- Total Beard: ${Math.round(Number(totals.Beard)||0)}%`);
    const code = getCodeSafe();
    if (code && code.length===19) {
      L.push('');
      L.push(`Code: ${code}`);
    }
    L.push('');
    return L.join('\
');
  }

  function hijackBtn(){
    const btn = document.getElementById('copy-summary');
    if (!btn) return false;
    // Replace node to remove any existing listeners
    const clone = btn.cloneNode(true);
    btn.parentNode.replaceChild(clone, btn);
    clone.addEventListener('click', async function(ev){
      ev.preventDefault();
      ev.stopPropagation();
      const text = buildSummary();
      const ok = await writeClipboard(text);
      if (ok) { clone.textContent = 'Copied!'; setTimeout(()=>clone.textContent='Copy summary', 1200); }
      else { alert('Copy failed'); }
      return false;
    });
    return true;
  }

  function boot(){
    if (!hijackBtn()) {
      // try again a few times if the button is inserted late
      let tries = 0;
      const iv = setInterval(()=>{
        if (hijackBtn()) { clearInterval(iv); return; }
        tries++;
        if (tries > 30) clearInterval(iv);
      }, 250);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', boot);
  } else {
    boot();
  }
})();
</script>











<script>
(function(){
  function waitFor(pred, timeoutMs){
    return new Promise((resolve, reject)=>{
      const t0 = Date.now();
      function tick(){
        try { if (pred()) return resolve(true); } catch(e){}
        if (Date.now() - t0 > timeoutMs) return reject(new Error("waitFor timeout"));
        setTimeout(tick, 50);
      }
      tick();
    });
  }
  function writeClipboard(text){
    if (navigator.clipboard && navigator.clipboard.writeText) {
      return navigator.clipboard.writeText(text).then(()=>true).catch(()=>false);
    }
    try {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      return Promise.resolve(true);
    } catch(e){ return Promise.resolve(false); }
  }
  function ensureButton(){
    let btn = document.getElementById('copy-summary');
    if (!btn) {
      const pdfBtn = document.getElementById('generate-pdf');
      btn = document.createElement('button');
      btn.id = 'copy-summary';
      btn.type = 'button';
      btn.textContent = 'Copy summary';
      btn.style.marginLeft = '8px';
      btn.style.padding = '8px 12px';
      btn.style.border = '1px solid #cbd5e1';
      btn.style.borderRadius = '8px';
      btn.style.cursor = 'pointer';
      btn.style.background = 'white';
      btn.style.boxShadow = '0 1px 2px rgba(0,0,0,.05)';
      if (pdfBtn && pdfBtn.parentNode) pdfBtn.parentNode.insertBefore(btn, pdfBtn.nextSibling);
      else (document.body || document.documentElement).insertBefore(btn, document.body.firstChild);
    } else {
      // drop pre-existing listeners
      const clone = btn.cloneNode(true);
      btn.parentNode.replaceChild(clone, btn);
      btn = clone;
    }
    return btn;
  }
  function composeSummary(){
    const totals = (typeof calculateSectionTotals==='function') ? calculateSectionTotals() : {Scalp:0, Eyebrows:0, Eyelashes:0, Beard:0};
    const dt = new Date().toLocaleString();
    const lines = [];
    lines.push('Alopecia Areata Calculator');
    lines.push(dt);
    lines.push('');
    lines.push('Summary of Alopecia Areata Involvement');
    lines.push(`- Total Scalp: ${Math.round(Number(totals.Scalp)||0)}%`);
    
    // Append scalp change if baseline exists and non-zero (works with totals.Scalp or totals.scalp)
    (function(){ try {
      if (typeof window.__baselineScalpPct === 'number') {
        const __cur = (typeof totals === 'object') ? (('Scalp' in totals ? totals.Scalp : (('scalp' in totals) ? totals.scalp : null))) : null;
        const __val = Number(__cur);
        if (Number.isFinite(__val)) {
          const __delta = window.__baselineScalpPct - __val;
          if (__delta !== 0) {
            const __abs = Math.abs(__delta).toFixed(1).replace(/\.0$/, '');
            if (__delta > 0) { lines.push(`- Scalp improvement: ${__abs}%`); }
            else { lines.push(`- Scalp worsening: ${__abs}%`); }
          }
        }
      }
    } catch(__e){} })();
lines.push(`- Total Eyebrows: ${Math.round(Number(totals.Eyebrows)||0)}%`);
    lines.push(`- Total Eyelashes: ${Math.round(Number(totals.Eyelashes)||0)}%`);
    if ((Number(totals.Beard)||0) > 0) lines.push(`- Total Beard: ${Math.round(Number(totals.Beard)||0)}%`);
    let code = '';
    try {
      // Unconditional attempt; if not yet defined, fallback to 18+checksum
      code = String(encodeAA19());
    } catch(e){
      try {
        const c18 = (typeof encodeAA18==='function') ? encodeAA18() : '';
        if (c18 && typeof dec52==='function' && typeof enc52==='function' && typeof sumMod52==='function'){
          const idxs = c18.split('').map(dec52);
          const chk = sumMod52(idxs);
          code = c18 + enc52(chk);
        }
      } catch(_){ code = ''; }
    }
    if (code) {
      lines.push('');
      lines.push(`Code: ${code}`);
    }
    lines.push('');
    return lines.join('\n'); // real newlines
  }
  async function initCopySummary(){
    // Wait for required functions
    await waitFor(()=> typeof encodeAA19==='function' || typeof encodeAA18==='function', 5000).catch(()=>{});
    await waitFor(()=> typeof calculateSectionTotals==='function', 5000).catch(()=>{});
    const btn = ensureButton();
    btn.addEventListener('click', async (ev)=>{
      ev.preventDefault();
      ev.stopPropagation();
      const ok = await writeClipboard(composeSummary());
      if (ok) { btn.textContent = 'Copied!'; setTimeout(()=>btn.textContent='Copy summary', 1200); }
    }, true);
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCopySummary);
  } else {
    initCopySummary();
  }
})();
</script>



<!-- PATCH v2: MutationObserver to mirror "Beard Area (...%)" into the beard ring -->
<script>
(function(){
  function parseBeardPctFromTitle(){
    const t = document.getElementById('beard-title');
    if (!t) return null;
    const m = (t.textContent||'').match(/\(([-\d.]+)%\)/);
    if (!m) return null;
    const v = parseFloat(m[1]);
    if (isNaN(v)) return null;
    return Math.min(100, Math.max(0, v));
  }
  function setBeardRing(pct){
    const ring = document.getElementById('ring-beard');
    const val  = document.getElementById('ring-val-beard');
    if (!ring || !val || pct == null) return;
    if (typeof setRingPct === 'function') setRingPct(ring, pct);
    val.textContent = (Math.round(pct*100)/100).toFixed(2) + '%';
    ring.style.display = (pct > 0.0001) ? 'grid' : 'none';
  }
  function syncOnce(){
    const pct = parseBeardPctFromTitle();
    setBeardRing(pct);
  }
  // Observe changes to beard-title text
  function observeTitle(){
    const t = document.getElementById('beard-title');
    if (!t || typeof MutationObserver === 'undefined') return;
    const mo = new MutationObserver(syncOnce);
    mo.observe(t, {characterData:true, childList:true, subtree:true});
    // run an initial sync
    syncOnce();
  }
  // Wrap updateScoreRings to enforce mirroring after any app updates
  const prev = window.updateScoreRings;
  window.updateScoreRings = function(){
    try { if (typeof prev === 'function') prev(); } catch(_){}
    syncOnce();
  };
  // Safety periodic sync in case some paths don't call updateScoreRings or change the title in-place
  setInterval(syncOnce, 300);

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', observeTitle);
  } else {
    observeTitle();
  }
})();
</script>

<style id="scalp-extra-controls-css">
/* Extra controls for scalp boxes at 1/3 and 2/3 heights */
.area-box .middleplus, .area-box .middleminus, .area-box .lowerplus, .area-box .lowerminus {
  position: absolute;
  width: 18px;
  height: 18px;
  border: 1px solid #888;
  border-radius: 50%;
  background-color: white;
  text-align: center;
  line-height: 18px;
  font-weight: bold;
  font-size: 14px;
  cursor: pointer;
}
.area-box .middleplus, .area-box .middleminus { top: 33.333%; transform: translateY(-50%); }
.area-box .lowerplus, .area-box .lowerminus  { top: 66.666%; transform: translateY(-50%); }
.area-box .middleplus, .area-box .lowerplus  { right: 2px; }
.area-box .middleminus, .area-box .lowerminus { left: 2px; }
.pdf-top-right { position:absolute; top:6px; right:8px; }
</style>

<script id="scalp-extra-controls-js">
(function(){
  if (window.__scalpExtraControlsApplied) return;
  window.__scalpExtraControlsApplied = true;
  const scalpIds = ['backside','topside','leftside','rightside'];

  function addButtonsOnce() {
    scalpIds.forEach(id => {
      const root = document.getElementById(id + '-areas');
      if (!root) return;
      root.querySelectorAll('.area-box').forEach(box => {
        if (box.querySelector('.middleplus') || box.querySelector('.middleminus') ||
            box.querySelector('.lowerplus')  || box.querySelector('.lowerminus')) return;

        const sectionId = (box.parentElement && box.parentElement.id)
          ? box.parentElement.id.replace(/-areas$/, '')
          : id;

        const topPlus  = box.querySelector(':scope > .plus:not(.middleplus):not(.lowerplus)');
        const topMinus = box.querySelector(':scope > .minus:not(.middleminus):not(.lowerminus)');

        function makeBtn(kind, cls, titleVal) {
          const d = document.createElement('div');
          d.className = kind + ' ' + cls;
          d.innerText = kind === 'plus' ? '+' : '−';
          if (typeof titleVal === 'string') d.title = titleVal;
          d.onclick = (e) => {
            e.stopPropagation();
            const val = parseFloat((d.title || '').replace('%',''));
            if (Number.isFinite(val) && typeof window.toggleScalpSelection === 'function') {
              window.toggleScalpSelection(sectionId, val);
            }
          };
          return d;
        }

        if (topPlus && topPlus.title) {
          const mPlus = makeBtn('plus', 'middleplus', topPlus.title);
          const lPlus = makeBtn('plus', 'lowerplus',  topPlus.title);
          box.appendChild(mPlus);
          box.appendChild(lPlus);
        }
        if (topMinus && topMinus.title) {
          const mMinus = makeBtn('minus', 'middleminus', topMinus.title);
          const lMinus = makeBtn('minus', 'lowerminus',  topMinus.title);
          box.appendChild(mMinus);
          box.appendChild(lMinus);
        }
      });
    });
  }

  function mirrorGlowState() {
  scalpIds.forEach(id => {
    const root = document.getElementById(id + '-areas');
    if (!root) return;
    root.querySelectorAll('.area-box').forEach(box => {
      const primaryPlus  = box.querySelector(':scope > .plus:not(.middleplus):not(.lowerplus)');
      const primaryMinus = box.querySelector(':scope > .minus:not(.middleminus):not(.lowerminus)');
      const onPlus  = !!(primaryPlus  && primaryPlus.classList.contains('glow'));
      const onMinus = !!(primaryMinus && primaryMinus.classList.contains('glow'));
      const last = box.dataset.lastClickPos || 'upper';

      function paint(selector, active, bgOn, bgOff) {
        box.querySelectorAll(selector).forEach(el => {
          el.classList.toggle('glow', !!active);
          el.style.backgroundColor = active ? bgOn : 'white';
          el.style.transform = active ? 'scale(1.3)' : 'scale(1)';
        });
      }

      const mid = last === 'middle';
      const low = last === 'lower';

      // Clear both tiers implicitly by painting with active=false where appropriate
      paint('.plus.middleplus',   mid && onPlus,  '#ccffcc', 'white');
      paint('.minus.middleminus', mid && onMinus, '#ffcccc', 'white');
      paint('.plus.lowerplus',    low && onPlus,  '#ccffcc', 'white');
      paint('.minus.lowerminus',  low && onMinus, '#ffcccc', 'white');
    });
  });
}

  if (typeof window.updateScalpUI === 'function') {
    const original = window.updateScalpUI;
    window.updateScalpUI = function() {
      const r = original.apply(this, arguments);
      mirrorGlowState();
      return r;
    };
  } else {
    let tries = 0;
    const t = setInterval(() => {
      if (typeof window.updateScalpUI === 'function') {
        clearInterval(t);
        const original = window.updateScalpUI;
        window.updateScalpUI = function() {
          const r = original.apply(this, arguments);
          mirrorGlowState();
          return r;
        };
        mirrorGlowState();
      } else if (++tries > 40) {
        clearInterval(t);
      }
    }, 100);
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(() => { addButtonsOnce(); mirrorGlowState(); }, 0);
  } else {
    document.addEventListener('DOMContentLoaded', () => { setTimeout(() => { addButtonsOnce(); mirrorGlowState(); }, 0); });
  }
})();
</script>


<script id="pattern-score-js">
(function(){
  if (window.__patternScoreApplied) return;
  window.__patternScoreApplied = true;

  const scores = {
    "Patchy alopecia areata": 0,
    "Focal alopecia areata": 0,
    "Ophiasis pattern": 0
  };

  const scalpIds = ['backside','leftside','rightside','topside'];

  function ensureOutcomeNode(){
    const rings = document.getElementById('score-rings');
    if (!rings) return null;
    let node = document.getElementById('pattern-dominant');
    if (!node) {
      node = document.createElement('div');
      node.id = 'pattern-dominant';
      node.style.font = '600 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
      node.style.textAlign = 'center';
      node.style.marginTop = '6px';
      rings.insertAdjacentElement('afterend', node);
    }
    return node;
  }

  function updateOutcome(){
    try {
      const totals = (typeof calculateSectionTotals === 'function') ? calculateSectionTotals() : null;
      const scalpPct = totals && totals.Scalp != null ? Number(totals.Scalp) : 0;
      if (Math.round(scalpPct) === 100) {
        node.textContent = 'Alopecia totalis';
        node.style.display = '';
        return;
      }
    } catch(e) {}

    const node = ensureOutcomeNode();
    if (!node) return;
    const total = scores["Patchy alopecia areata"] + scores["Focal alopecia areata"] + scores["Ophiasis pattern"];
    if (total === 0) {
      node.textContent = '';
      node.style.display = 'none';
      return;
    }
    node.style.display = '';
    const entries = Object.entries(scores);
    let best = entries[0];
    for (let i=1; i<entries.length; i++){
      if (entries[i][1] > best[1]) best = entries[i];
    }
    node.textContent = best[0];
  }

  const resetBtn = document.getElementById('reset-button');
  if (resetBtn) resetBtn.addEventListener('click', () => {
    scores["Patchy alopecia areata"] = 0;
    scores["Focal alopecia areata"] = 0;
    scores["Ophiasis pattern"] = 0;
    updateOutcome();
  });

  function indexWithinSection(box){
    const parent = box.closest('.area-container');
    if (!parent) return -1;
    const boxes = Array.from(parent.querySelectorAll('.area-box'));
    return boxes.indexOf(box) + 1;
  }

  function classify(sectionId, pos, index, value){
    if (!isFinite(value) || Number(value) === 0) return null;
    if (pos === 'upper') return "Patchy alopecia areata";
    if (pos === 'middle') {
      if (sectionId === 'topside') {
        if (index >= 2 && index <= 6) return "Focal alopecia areata";
      } else if (sectionId === 'backside' || sectionId === 'leftside' || sectionId === 'rightside') {
        if (index >= 2 && index <= 5) return "Focal alopecia areata";
      }
      return "Patchy alopecia areata";
    }
    if (pos === 'lower') return "Ophiasis pattern";
    return "Patchy alopecia areata";
  }

  document.addEventListener('click', function(e){
    const btn = e.target.closest('.plus, .minus');
    const box = e.target.closest('.area-box');
    if (!box) return;
    const parentId = (box.parentElement && box.parentElement.id) ? box.parentElement.id : '';
    const sectionId = parentId.replace(/-areas$/, '');
    if (!scalpIds.includes(sectionId)) return;

    const value = parseFloat(box.dataset.value || 'NaN');
    let pos = 'upper';
    if (btn) {
      if (btn.classList.contains('middleplus') || btn.classList.contains('middleminus')) pos = 'middle';
      else if (btn.classList.contains('lowerplus') || btn.classList.contains('lowerminus')) pos = 'lower';
      else pos = 'upper';
    } else {
      const rect = box.getBoundingClientRect();
      const relY = (e.clientY - rect.top) / rect.height;
      if (relY < 1/3) pos = 'upper';
      else if (relY < 2/3) pos = 'middle';
      else pos = 'lower';
    }

    const idx = indexWithinSection(box);
    const pattern = classify(sectionId, pos, idx, value);
    if (pattern) {
      scores[pattern] = (scores[pattern] || 0) + 1;
      updateOutcome();
    }
  }, true);

  ensureOutcomeNode();
  updateOutcome();
})();
</script>



<style id="pattern-chip-style">
#pattern-dominant {
  align-self: stretch;
  margin: 0 0 8px 0; /* place above rings with extra separation */
  border: none;
  background: none;
  padding: 0;
  font: 400 13px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  white-space: nowrap;
}
#selected-preview #pattern-dominant-preview {
  width: 100%;
  text-align: center;
  margin-bottom: 6px;
  font: 600 13px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
}
.pdf-top-right { position:absolute; top:6px; right:8px; }
</style>


<script id="pattern-selection-based">
(function(){
  if (window.__patternSelectionBasedApplied) return;
  window.__patternSelectionBasedApplied = true;
  // Do not show dominant pattern until user edits after load
  window.__patternDirty = false;

  const SCALP_IDS = ['backside','leftside','rightside','topside'];

  function ensurePatternNode(){
    const rings = document.getElementById('score-rings');
    if (!rings || !rings.parentNode) return null;
    // Ensure rings container can host a line above it
    const parent = rings.parentNode;
    let node = document.getElementById('pattern-dominant');
    if (!node) {
      node = document.createElement('div');
      node.id = 'pattern-dominant';
    }
    // Place ABOVE the rings
    if (node.parentNode !== parent || node.nextElementSibling !== rings) {
      parent.insertBefore(node, rings);
    }
    return node;
  }

  function ensurePreviewPatternNode(){
    const prev = document.getElementById('selected-preview');
    if (!prev) return null;
    let node = document.getElementById('pattern-dominant-preview');
    if (!node) {
      node = document.createElement('div');
      node.id = 'pattern-dominant-preview';
      prev.prepend(node);
    }
    return node;
  }

  document.addEventListener('click', function(e){
    const box = e.target.closest('.area-box');
    if (!box) return;
    const container = box.parentElement;
    if (!container || !/-(?:areas)$/.test(container.id)) return;
    const sectionId = container.id.replace(/-areas$/, '');
    if (!SCALP_IDS.includes(sectionId)) return;

    let pos = 'upper';
    const btn = e.target.closest('.plus, .minus');
    if (btn) {
      if (btn.classList.contains('middleplus') || btn.classList.contains('middleminus')) pos = 'middle';
      else if (btn.classList.contains('lowerplus') || btn.classList.contains('lowerminus')) pos = 'lower';
      else pos = 'upper';
    } else {
      const r = box.getBoundingClientRect();
      const y = (e.clientY - r.top) / r.height;
      if (y < 1/3) pos = 'upper';
      else if (y < 2/3) pos = 'middle';
      else pos = 'lower';
    }
    box.dataset.lastClickPos = pos;
  }, true);

  function boxIndex1(box){
    const parent = box.closest('.area-container');
    if (!parent) return -1;
    const boxes = Array.from(parent.querySelectorAll('.area-box'));
    return boxes.indexOf(box) + 1;
  }

  function classify(sectionId, pos, idx, value){
    const v = Number(value);
    if (!Number.isFinite(v) || v === 0) return null;
    if (pos === 'upper') return 'Patchy alopecia areata';
    if (pos === 'middle') {
      if (sectionId === 'topside') {
        if (idx >= 2 && idx <= 6) return 'Focal alopecia areata';
      } else if (sectionId === 'backside' || sectionId === 'leftside' || sectionId === 'rightside') {
        if (idx >= 2 && idx <= 5) return 'Focal alopecia areata';
      }
      return 'Patchy alopecia areata';
    }
    if (pos === 'lower') return 'Ophiasis pattern';
    return 'Patchy alopecia areata';
  }

  function computeDominantPattern(){
    try {
      const totals = (typeof calculateSectionTotals === 'function') ? calculateSectionTotals() : null;
      const scalpPct = totals && totals.Scalp != null ? Number(totals.Scalp) : 0;
      if (Math.round(scalpPct) === 100) return 'Alopecia totalis';
    } catch(e) {}

    const scores = { 'Patchy alopecia areata':0, 'Focal alopecia areata':0, 'Ophiasis pattern':0 };
    SCALP_IDS.forEach(id => {
      const root = document.getElementById(id + '-areas');
      if (!root) return;
      root.querySelectorAll('.area-box').forEach(box => {
        if (!box.classList.contains('selected')) return;

        const idx = boxIndex1(box);
        const value = parseFloat(box.dataset.value || 'NaN');

        const hasMidGlow = box.querySelector('.middleplus.glow, .middleminus.glow');
const hasLowGlow = box.querySelector('.lowerplus.glow, .lowerminus.glow');
const hasTopGlow = box.querySelector(':scope > .plus.glow, :scope > .minus.glow');

let pos = box.dataset.lastClickPos || null;
if (!pos) {
  if (hasLowGlow) pos = 'lower';
  else if (hasMidGlow) pos = 'middle';
  else if (hasTopGlow) pos = 'upper';
  else pos = 'upper';
}

        const p = classify(id, pos, idx, value);
        if (p) scores[p]++;
      });
    });
    const total = scores['Patchy alopecia areata'] + scores['Focal alopecia areata'] + scores['Ophiasis pattern'];
    if (!total) return '';
    let best = 'Patchy alopecia areata';
    if (scores['Focal alopecia areata'] > scores[best]) best = 'Focal alopecia areata';
    if (scores['Ophiasis pattern'] > scores[best]) best = 'Ophiasis pattern';
    return best;
  }

  function renderPattern(){
    if (!window.__patternDirty) {
      const node = ensurePatternNode();
      const prev = ensurePreviewPatternNode();
      if (node) { node.textContent=''; node.style.display='none'; }
      if (prev) { prev.textContent=''; prev.style.display='none'; }
      return;
    }
    const name = computeDominantPattern();
    const node = ensurePatternNode();
    const prev = ensurePreviewPatternNode();
    if (!node) return;

    if (!name) {
      node.textContent = '';
      node.style.display = 'none';
      if (prev) { prev.textContent = ''; prev.style.display = 'none'; }
      return;
    }
    node.style.display = '';
    node.textContent = name;
    if (prev) { prev.style.display = ''; prev.textContent = 'Dominant pattern: ' + name; }
  }

  if (typeof window.updateScalpUI === 'function') {
    const orig = window.updateScalpUI;
    window.updateScalpUI = function(){
      const r = orig.apply(this, arguments);
      renderPattern();
      return r;
    };
  }

  // Observe for PDF summary creation and insert the pattern
  const mo = new MutationObserver(function(list){
    list.forEach(rec => {
      rec.addedNodes && rec.addedNodes.forEach(node => {
        try {
          if (node.nodeType === 1 && node.id === 'pdf-summary') {
            const name = computeDominantPattern();
            if (name) {
              const p = document.createElement('p');
              p.innerHTML = '<strong>Dominant pattern:</strong> ' + name;
              const totalsList = node.querySelector('h3 + ul'); // after the Totals list
              if (totalsList) totalsList.insertAdjacentElement('afterend', p);
              else node.prepend(p);
            }
          }
        } catch(e){}
      });
    });
  });
  mo.observe(document.documentElement, { childList: true, subtree: true });

  // Patch clipboard writes: append dominant pattern and collapse multiple blank lines
  try {
    if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
      const _orig = navigator.clipboard.writeText.bind(navigator.clipboard);
      navigator.clipboard.writeText = function(t){
        try {
                    if (typeof t === 'string') {
            const decorate = (window.__aa_decorateDominant || window.decorateDominantScalpOnly || window.decorateDominant || (x => x));
            const nameRaw = computeDominantPattern();
            const name = decorate(nameRaw);
            if (name) {
              if ((/Dominant pattern:/i).test(t)) {
                t = t.replace(/(^|\n)Dominant pattern:[^\n]*/i, function(_m, p1){ return p1 + 'Dominant pattern: ' + name; });
              } else {
                t = t + '\nDominant pattern: ' + name;
              }
            }
            // Collapse double or more newlines to a single newline
            t = t.replace(/\n{2,}/g, '\n').replace(/[ \t]+\n/g, '\n').replace(/\n[ \t]+/g, '\n').trim();
          }
        } catch(e){}
        return _orig(t);
      };
    }
  } catch(e){}

  
  // Mark dirty on any user change and re-render
  ['click','input','change'].forEach(function(evt){
    document.addEventListener(evt, function(){
      window.__patternDirty = true; // mark dirty on user action
      try { renderPattern(); } catch(e){}
    }, true);
  });

  // Initial render
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(renderPattern, 0);
  } else {
    document.addEventListener('DOMContentLoaded', function(){ setTimeout(renderPattern, 0); });
  }
})();
</script>



<script>
(function(){
  function getScalpPctSafe(){
    try {
      if (typeof calculateSectionTotals === 'function') {
        const t = calculateSectionTotals();
        const v = Number(t && t.Scalp);
        return Number.isFinite(v) ? Math.max(0, Math.min(100, v)) : null;
      }
    } catch(e){}
    return null;
  }

  function getPatternNode(){
    var n = document.getElementById('pattern-dominant');
    return n || null;
  }

  function updateScalpDelta(){
    if (typeof window.__baselineScalpPct !== 'number') return;
    var now = getScalpPctSafe();
    if (now == null) return;

    var delta = window.__baselineScalpPct - now; // decrease = improvement
    var node = getPatternNode();
    if (!node || !node.textContent) return;

    var id = 'scalp-delta-badge';
var badge = document.getElementById(id);
if (!badge) {
  badge = document.createElement('span');
  badge.id = id;
  badge.style.marginLeft = '8px';
  badge.style.fontWeight = '600';
  node.appendChild(badge);
}

var abs = Math.abs(delta).toFixed(1).replace(/\.0$/, '');
if (delta > 0) {
  badge.textContent = 'Scalp improvement: ' + abs + '%';
  badge.style.color = '#16a34a';
  badge.style.display = '';
} else if (delta < 0) {
  badge.textContent = 'Scalp worsening: ' + abs + '%';
  badge.style.color = '#dc2626';
  badge.style.display = '';
} else {
  // No change: hide the badge entirely
  if (badge && badge.parentNode) {
    badge.parentNode.removeChild(badge);
  }
}
  }

  function setBaselineFromCurrent(){
    var v = getScalpPctSafe();
    if (v != null) window.__baselineScalpPct = v;
  }

  function wrap(fnName){
    var orig = window[fnName];
    if (typeof orig !== 'function') return;
    window[fnName] = function(){
      var r = orig.apply(this, arguments);
      try { setBaselineFromCurrent(); updateScalpDelta(); } catch(e){}
      return r;
    };
  }

  wrap('applyAA18');
  wrap('applyAA19');
  wrap('applyState');
  wrap('loadCode');

  (function hookUpdate(){
    var prev = window.updateScalpUI;
    if (typeof prev === 'function') {
      window.updateScalpUI = function(){
        var r = prev.apply(this, arguments);
        try { updateScalpDelta(); } catch(e){}
        return r;
      };
    } else {
      var tries = 0, iv = setInterval(function(){
        if (typeof window.updateScalpUI === 'function') {
          clearInterval(iv);
          var p = window.updateScalpUI;
          window.updateScalpUI = function(){
            var r = p.apply(this, arguments);
            try { updateScalpDelta(); } catch(e){}
            return r;
          };
        } else if (++tries > 40) clearInterval(iv);
      }, 100);
    }
  })();

  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(updateScalpDelta, 0);
  } else {
    document.addEventListener('DOMContentLoaded', function(){ setTimeout(updateScalpDelta, 0); });
  }
})();
</script>


<script>
(function(){
  function getBeardTotal(){
    try {
      if (typeof calculateSectionTotals === 'function') {
        var t = calculateSectionTotals();
        var v = Number(t && (t.Beard ?? t.beard));
        return Number.isFinite(v) ? v : 0;
      }
    } catch(e){}
    return 0;
  }
  function toggleBeardVisibility(){
    var total = getBeardTotal();
    var show = total > 0;
    var ids = ['beard-title','right-beard-density','left-beard-density','central-beard-density'];
    ids.forEach(function(id){
      var el = document.getElementById(id);
      if (el) el.closest('div').style.display = show ? '' : 'none';
    });
  }
  // Hook common update paths
  ['updateBeardUI','updateScalpUI'].forEach(function(name){
    var orig = window[name];
    if (typeof orig === 'function'){
      window[name] = function(){
        var r = orig.apply(this, arguments);
        try { toggleBeardVisibility(); } catch(e){}
        return r;
      };
    }
  });
  document.addEventListener('DOMContentLoaded', function(){ setTimeout(toggleBeardVisibility, 50); });
})();
</script>


<script>
(function(){
  function anyDensityPositive(){
    try {
      var dens = [];
      if (typeof globalSelections === 'object' && globalSelections) {
        ['backside','topside','leftside','rightside','androgenetic'].forEach(function(id){
          if (globalSelections[id] && typeof globalSelections[id].density !== 'undefined') {
            dens.push(Number(globalSelections[id].density)||0);
          }
        });
      }
      if (typeof beardSelections === 'object' && beardSelections) {
        ['left-beard','right-beard','central-beard'].forEach(function(id){
          if (beardSelections[id] && typeof beardSelections[id].density !== 'undefined') {
            dens.push(Number(beardSelections[id].density)||0);
          }
        });
      }
      return dens.some(function(d){ return (Number(d)||0) > 0; });
    } catch(e){ return false; }
  }

  function decorate(txt){
    if (!txt) return txt;
    var base = String(txt).replace(/\s*\(diffuse\)\s*$/i, '').trim();
    if (anyDensityPositive()) return base + " (diffuse)";
    return base;
  }

  function refreshDominant(){
    try {
      var node = document.getElementById('pattern-dominant');
      if (node && node.textContent != null) {
        var newTxt = decorate(node.textContent);
        if (newTxt !== node.textContent) node.textContent = newTxt;
      }
    } catch(e){}
  }

  // Make functions available for other code paths (PDF/clipboard readers can call this)
  window.__aa_anyDensityPositive = anyDensityPositive;
  window.__aa_decorateDominant = decorate;
  window.__aa_refreshDominant = refreshDominant;

  // Hook UI changes without modifying existing functions
  document.addEventListener("click", function(ev){
    // Many density changes happen via button clicks
    setTimeout(refreshDominant, 0);
  }, true);
  document.addEventListener("input", function(){ setTimeout(refreshDominant, 0); }, true);
  document.addEventListener("DOMContentLoaded", function(){ setTimeout(refreshDominant, 0); });
})();
</script>


<script>
// Override helpers to make '(diffuse)' depend only on scalp densities
(function(){
  window.__aa_anyDensityPositive = function(){
    try {
      var dens = [];
      if (typeof globalSelections === 'object' && globalSelections) {
        ['backside','topside','leftside','rightside','androgenetic'].forEach(function(id){
          if (globalSelections[id] && typeof globalSelections[id].density !== 'undefined') {
            dens.push(Number(globalSelections[id].density)||0);
          }
        });
      }
      return dens.some(function(d){ return (Number(d)||0) > 0; });
    } catch(e){ return false; }
  };
  window.__aa_decorateDominant = function(txt){
    if (!txt) return txt;
    var base = String(txt).replace(/\s*\(diffuse\)\s*$/i, '').trim();
    if (window.__aa_anyDensityPositive && window.__aa_anyDensityPositive()) return base + " (diffuse)";
    return base;
  };
  // Refresh once on load
  try { if (window.__aa_refreshDominant) setTimeout(window.__aa_refreshDominant, 0); } catch(e){}
})();
</script>





<style>
  .age-controls { display:flex; align-items:center; gap:8px; }
  .age-controls .label { font-weight:600; margin-right:4px; }
  .age-btn {
    padding: 4px 10px;
    border: 1px solid #cbd5e1;
    border-radius: 9999px;
    background: white;
    color: #111827;
    cursor: pointer;
    font-size: 13px;
  }
  .age-btn.selected { background: #2563eb; color: #fff; border-color: #2563eb; }
  .title-topbar { display:flex; align-items:center; justify-content:space-between; margin-top: 10px; }
.pdf-top-right { position:absolute; top:6px; right:8px; }
</style>
<script>
(function(){
  // default age group
  globalThis.__ageGroup = globalThis.__ageGroup || 'over12';

  // scaling function
  globalThis.__applyAgeScaling = function(parts){
    const g = globalThis.__ageGroup || 'over12';
    let {L=0,R=0,B=0,T=0} = parts || {};
    if (g === '6to11') {
      L *= (19/18); R *= (19/18); B *= (23/24); T *= (39/40);
    } else if (g === 'under6') {
      L *= (19/18); R *= (19/18); B *= (24/24); T *= (38/40);
    }
    return {L,R,B,T};
  };

  function installAgeControls(){
    const banner = document.querySelector('.title-banner');
    const pdfBtn = document.getElementById('generate-pdf');
    if (!banner || !pdfBtn) return;

    // bar sits a bit lower - place after subtitle if present, else append
    const topbar = document.createElement('div');
    topbar.className = 'title-topbar';

    // left controls
    const left = document.createElement('div');
    left.className = 'age-controls';
    left.innerHTML = `
      <span class="label">Age</span>
      <button type="button" class="age-btn" data-age="over12" aria-pressed="true">12+</button>
      <button type="button" class="age-btn" data-age="6to11">6 to 11</button>
      <button type="button" class="age-btn" data-age="under6">Under 6</button>
    `;

    // right - put existing PDF button here to be on the same line
    const right = document.createElement('div');
    right.style.display = 'flex';
    right.style.alignItems = 'center';
    right.style.gap = '8px';
    right.style.marginTop = '6px';
    right.appendChild(pdfBtn);

    topbar.appendChild(left);

    const subtitle = banner.querySelector('.title-sub');
    if (subtitle) subtitle.insertAdjacentElement('afterend', topbar);
    else banner.appendChild(topbar);

    if (!banner.style.position) banner.style.position = 'relative';
    const pdfHolder = document.createElement('div');
    pdfHolder.className = 'pdf-top-right';
    pdfHolder.appendChild(pdfBtn);
    banner.appendChild(pdfHolder);

    function setAge(g){
      globalThis.__ageGroup = g;
      left.querySelectorAll('.age-btn').forEach(btn => {
        const on = btn.getAttribute('data-age') === g;
        btn.classList.toggle('selected', on);
        btn.setAttribute('aria-pressed', on ? 'true' : 'false');
      });
      try { globalThis.updateScalpUI && globalThis.updateScalpUI(); } catch(e){}
      try { globalThis.updateScoreRings && globalThis.updateScoreRings(); } catch(e){}
    }
    left.querySelectorAll('.age-btn').forEach(btn => {
      btn.addEventListener('click', () => setAge(btn.getAttribute('data-age')));
    });
    setAge(globalThis.__ageGroup || 'over12');

    // keep pdf visibility consistent with existing app behavior
    const preview = document.getElementById('selected-preview');
    function syncPdfVisibility(){
      try {
        const show = preview && preview.children && preview.children.length > 0;
        pdfBtn.style.display = show ? '' : 'none';
      } catch(e){}
    }
    syncPdfVisibility();
    try { if (preview) new MutationObserver(syncPdfVisibility).observe(preview, { childList: true }); } catch(e){}
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', installAgeControls);
  } else {
    installAgeControls();
  }
})();
</script>

</body></html>
<!-- removed legacy SAFE OVERRIDES -->
