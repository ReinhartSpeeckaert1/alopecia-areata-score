<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Alopecia Areata Calculator</title>
<style>
    body {
      font-family: "Segoe UI", "Helvetica Neue", sans-serif;
      padding: 20px;
      background: linear-gradient(to bottom, #f0f0f0, #dcdcdc);
      margin: 0;
    }

    .area-container, .density-container {
      justify-content: center;
      display: flex;
      gap: 4px;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .area-box:hover {
      transform: scale(1.05);
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
    }

    .area-box {
  will-change: transform, box-shadow;
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
      width: 60px;
      height: 60px;
      border: 2px solid #ccc;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      background-color: white;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    .area-box.selected {
      transform: scale(1.12);
      box-shadow: 0 0 20px rgba(0, 119, 204, 0.5);
      background-color: rgba(179, 217, 255, 0.8);
      border-color: #0077cc;
    }

    .plus:hover, .minus:hover {
      transform: scale(2.0);
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);
    }

    .plus, .minus {
      transition: transform 0.2s;
      border: 1px solid #888;
      position: absolute;
      font-weight: bold;
      cursor: pointer;
      background-color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      text-align: center;
      line-height: 18px;
      font-size: 14px;
    }

    .plus {
      top: 2px;
      right: 2px;
    }

    .minus {
      top: 2px;
      left: 2px;
    }

    .density-container button {
      padding: 5px 10px;
      border: 2px solid #ccc;
      background-color: white;
      cursor: pointer;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      min-width: 40px;
      min-height: 30px;
    }

    .density-container button.selected {
      background-color: rgba(179, 255, 179, 0.8);
      border-color: #00aa00;
      box-shadow: 0 0 20px rgba(0, 170, 0, 0.7);
    }

    #result {
      font-size: 18px;
      font-weight: bold;
    }
  
    .tooltip {
      position: absolute;
      top: -25px;
      background-color: transparent;
      color: black;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 18px;
      white-space: nowrap;
      z-index: 10;
      pointer-events: none;
    }

    /* Custom row heights for different sections */
    
    /* Scalp sections */
    #backside-areas .area-box {
  will-change: transform, box-shadow; height: 340px; width: 100px; }
    #topside-areas .area-box {
  will-change: transform, box-shadow; height: 340px; width: 100px; }
    #leftside-areas .area-box {
  will-change: transform, box-shadow; height: 340px; width: 100px; }
    #rightside-areas .area-box {
  will-change: transform, box-shadow; height: 340px; width: 100px; }
    
    /* Eyebrow sections */
    #right-eyebrow-areas .area-box {
  will-change: transform, box-shadow; height: 48px; width: 160px; }
    #left-eyebrow-areas .area-box {
  will-change: transform, box-shadow; height: 48px; width: 160px; }
    
    /* Eyelash sections */
    #right-eyelash-areas .area-box {
  will-change: transform, box-shadow; height: 84px; width: 160px; }
    #left-eyelash-areas .area-box {
  will-change: transform, box-shadow; height: 84px; width: 160px; }
    
    /* Beard sections */
    #right-beard-areas .area-box {
  will-change: transform, box-shadow; height: 138px; width: 120px; }
    #left-beard-areas .area-box {
  will-change: transform, box-shadow; height: 138px; width: 120px; }
    #central-beard-areas .area-box {
  will-change: transform, box-shadow; height: 136.8px; width: 120px; }
    
    /* Density button customization */
    #backside-density button { width: 50px; height: 35px; }
    #topside-density button { width: 50px; height: 35px; }
    #leftside-density button { width: 50px; height: 35px; }
    #rightside-density button { width: 50px; height: 35px; }
    #right-beard-density button { width: 45px; height: 40px; }
    #left-beard-density button { width: 45px; height: 40px; }
    #central-beard-density button { width: 45px; height: 40px; }

    /* Individual box identification for background Images */
    
    /* Backside scalp boxes */
    #backside-areas .area-box:nth-child(1) { background-Image: url('Images/backside-0.jpg'); }
    #backside-areas .area-box:nth-child(2) { background-Image: url('Images/backside-05.jpg'); }
    #backside-areas .area-box:nth-child(3) { background-Image: url('Images/backside-1.jpg'); }
    #backside-areas .area-box:nth-child(4) { background-Image: url('Images/backside-4.jpg'); }
    #backside-areas .area-box:nth-child(5) { background-Image: url('Images/backside-7.jpg'); }
    #backside-areas .area-box:nth-child(6) { background-Image: url('Images/backside-10.jpg'); }
    #backside-areas .area-box:nth-child(7) { background-Image: url('Images/backside-13.jpg'); }
    #backside-areas .area-box:nth-child(8) { background-Image: url('Images/backside-16.jpg'); }
    #backside-areas .area-box:nth-child(9) { background-Image: url('Images/backside-19.jpg'); }
    #backside-areas .area-box:nth-child(10) { background-Image: url('Images/backside-22.jpg'); }
    #backside-areas .area-box:nth-child(11) { background-Image: url('Images/backside-24.jpg'); }
    
    /* Topside scalp boxes */
    #topside-areas .area-box:nth-child(1) { background-Image: url('Images/topside-0.jpg'); }
    #topside-areas .area-box:nth-child(2) { background-Image: url('Images/topside-05.jpg'); }
    #topside-areas .area-box:nth-child(3) { background-Image: url('Images/topside-1.jpg'); }
    #topside-areas .area-box:nth-child(4) { background-Image: url('Images/topside-4.jpg'); }
    #topside-areas .area-box:nth-child(5) { background-Image: url('Images/topside-7.jpg'); }
    #topside-areas .area-box:nth-child(6) { background-Image: url('Images/topside-10.jpg'); }
    #topside-areas .area-box:nth-child(7) { background-Image: url('Images/topside-13.jpg'); }
    #topside-areas .area-box:nth-child(8) { background-Image: url('Images/topside-16.jpg'); }
    #topside-areas .area-box:nth-child(9) { background-Image: url('Images/topside-19.jpg'); }
    #topside-areas .area-box:nth-child(10) { background-Image: url('Images/topside-22.jpg'); }
    #topside-areas .area-box:nth-child(11) { background-Image: url('Images/topside-25.jpg'); }
    #topside-areas .area-box:nth-child(12) { background-Image: url('Images/topside-28.jpg'); }
    #topside-areas .area-box:nth-child(13) { background-Image: url('Images/topside-31.jpg'); }
    #topside-areas .area-box:nth-child(14) { background-Image: url('Images/topside-34.jpg'); }
    #topside-areas .area-box:nth-child(15) { background-Image: url('Images/topside-37.jpg'); }
    #topside-areas .area-box:nth-child(16) { background-Image: url('Images/topside-39.jpg'); }
    
    /* Leftside scalp boxes */
    #leftside-areas .area-box:nth-child(1) { background-Image: url('Images/leftside-0.jpg'); }
    #leftside-areas .area-box:nth-child(2) { background-Image: url('Images/leftside-05.jpg'); }
    #leftside-areas .area-box:nth-child(3) { background-Image: url('Images/leftside-1.jpg'); }
    #leftside-areas .area-box:nth-child(4) { background-Image: url('Images/leftside-2.jpg'); }
    #leftside-areas .area-box:nth-child(5) { background-Image: url('Images/leftside-5.jpg'); }
    #leftside-areas .area-box:nth-child(6) { background-Image: url('Images/leftside-8.jpg'); }
    #leftside-areas .area-box:nth-child(7) { background-Image: url('Images/leftside-11.jpg'); }
    #leftside-areas .area-box:nth-child(8) { background-Image: url('Images/leftside-14.jpg'); }
    #leftside-areas .area-box:nth-child(9) { background-Image: url('Images/leftside-17.jpg'); }
    
    /* Rightside scalp boxes */
    #rightside-areas .area-box:nth-child(1) { background-Image: url('Images/rightside-0.jpg'); }
    #rightside-areas .area-box:nth-child(2) { background-Image: url('Images/rightside-05.jpg'); }
    #rightside-areas .area-box:nth-child(3) { background-Image: url('Images/rightside-1.jpg'); }
    #rightside-areas .area-box:nth-child(4) { background-Image: url('Images/rightside-2.jpg'); }
    #rightside-areas .area-box:nth-child(5) { background-Image: url('Images/rightside-5.jpg'); }
    #rightside-areas .area-box:nth-child(6) { background-Image: url('Images/rightside-8.jpg'); }
    #rightside-areas .area-box:nth-child(7) { background-Image: url('Images/rightside-11.jpg'); }
    #rightside-areas .area-box:nth-child(8) { background-Image: url('Images/rightside-14.jpg'); }
    #rightside-areas .area-box:nth-child(9) { background-Image: url('Images/rightside-17.jpg'); }
    
    /* Eyebrow boxes */
    #right-eyebrow-areas .area-box:nth-child(1) { background-Image: url('Images/right-eyebrow-0.jpg'); }
    #right-eyebrow-areas .area-box:nth-child(2) { background-Image: url('Images/right-eyebrow-025.jpg'); }
    #right-eyebrow-areas .area-box:nth-child(3) { background-Image: url('Images/right-eyebrow-5.jpg'); }
    #right-eyebrow-areas .area-box:nth-child(4) { background-Image: url('Images/right-eyebrow-15.jpg'); }
    #right-eyebrow-areas .area-box:nth-child(5) { background-Image: url('Images/right-eyebrow-25.jpg'); }
    #right-eyebrow-areas .area-box:nth-child(6) { background-Image: url('Images/right-eyebrow-35.jpg'); }
    #right-eyebrow-areas .area-box:nth-child(7) { background-Image: url('Images/right-eyebrow-45.jpg'); }
    
    #left-eyebrow-areas .area-box:nth-child(1) { background-Image: url('Images/left-eyebrow-0.jpg'); }
    #left-eyebrow-areas .area-box:nth-child(2) { background-Image: url('Images/left-eyebrow-025.jpg'); }
    #left-eyebrow-areas .area-box:nth-child(3) { background-Image: url('Images/left-eyebrow-5.jpg'); }
    #left-eyebrow-areas .area-box:nth-child(4) { background-Image: url('Images/left-eyebrow-15.jpg'); }
    #left-eyebrow-areas .area-box:nth-child(5) { background-Image: url('Images/left-eyebrow-25.jpg'); }
    #left-eyebrow-areas .area-box:nth-child(6) { background-Image: url('Images/left-eyebrow-35.jpg'); }
    #left-eyebrow-areas .area-box:nth-child(7) { background-Image: url('Images/left-eyebrow-45.jpg'); }
    
    /* Eyelash boxes */
    #right-eyelash-areas .area-box:nth-child(1) { background-Image: url('Images/right-eyelash-0.jpg'); }
    #right-eyelash-areas .area-box:nth-child(2) { background-Image: url('Images/right-eyelash-025.jpg'); }
    #right-eyelash-areas .area-box:nth-child(3) { background-Image: url('Images/right-eyelash-5.jpg'); }
    #right-eyelash-areas .area-box:nth-child(4) { background-Image: url('Images/right-eyelash-15.jpg'); }
    #right-eyelash-areas .area-box:nth-child(5) { background-Image: url('Images/right-eyelash-25.jpg'); }
    #right-eyelash-areas .area-box:nth-child(6) { background-Image: url('Images/right-eyelash-35.jpg'); }
    #right-eyelash-areas .area-box:nth-child(7) { background-Image: url('Images/right-eyelash-45.jpg'); }
    
    #left-eyelash-areas .area-box:nth-child(1) { background-Image: url('Images/left-eyelash-0.jpg'); }
    #left-eyelash-areas .area-box:nth-child(2) { background-Image: url('Images/left-eyelash-025.jpg'); }
    #left-eyelash-areas .area-box:nth-child(3) { background-Image: url('Images/left-eyelash-5.jpg'); }
    #left-eyelash-areas .area-box:nth-child(4) { background-Image: url('Images/left-eyelash-15.jpg'); }
    #left-eyelash-areas .area-box:nth-child(5) { background-Image: url('Images/left-eyelash-25.jpg'); }
    #left-eyelash-areas .area-box:nth-child(6) { background-Image: url('Images/left-eyelash-35.jpg'); }
    #left-eyelash-areas .area-box:nth-child(7) { background-Image: url('Images/left-eyelash-45.jpg'); }
    
    /* Beard boxes */
    #right-beard-areas .area-box:nth-child(1) { background-Image: url('Images/right-beard-0.jpg'); }
    #right-beard-areas .area-box:nth-child(2) { background-Image: url('Images/right-beard-1.jpg'); }
    #right-beard-areas .area-box:nth-child(3) { background-Image: url('Images/right-beard-4.jpg'); }
    #right-beard-areas .area-box:nth-child(4) { background-Image: url('Images/right-beard-10.jpg'); }
    #right-beard-areas .area-box:nth-child(5) { background-Image: url('Images/right-beard-16.jpg'); }
    #right-beard-areas .area-box:nth-child(6) { background-Image: url('Images/right-beard-224.jpg'); }
    #right-beard-areas .area-box:nth-child(7) { background-Image: url('Images/right-beard-28.jpg'); }
    #right-beard-areas .area-box:nth-child(8) { background-Image: url('Images/right-beard-344.jpg'); }
    #right-beard-areas .area-box:nth-child(9) { background-Image: url('Images/right-beard-40.jpg'); }
    
    #left-beard-areas .area-box:nth-child(1) { background-Image: url('Images/left-beard-0.jpg'); }
    #left-beard-areas .area-box:nth-child(2) { background-Image: url('Images/left-beard-1.jpg'); }
    #left-beard-areas .area-box:nth-child(3) { background-Image: url('Images/left-beard-4.jpg'); }
    #left-beard-areas .area-box:nth-child(4) { background-Image: url('Images/left-beard-10.jpg'); }
    #left-beard-areas .area-box:nth-child(5) { background-Image: url('Images/left-beard-16.jpg'); }
    #left-beard-areas .area-box:nth-child(6) { background-Image: url('Images/left-beard-224.jpg'); }
    #left-beard-areas .area-box:nth-child(7) { background-Image: url('Images/left-beard-28.jpg'); }
    #left-beard-areas .area-box:nth-child(8) { background-Image: url('Images/left-beard-344.jpg'); }
    #left-beard-areas .area-box:nth-child(9) { background-Image: url('Images/left-beard-40.jpg'); }
    
    #central-beard-areas .area-box:nth-child(1) { background-Image: url('Images/central-beard-0.jpg'); }
    #central-beard-areas .area-box:nth-child(2) { background-Image: url('Images/central-beard-05.jpg'); }
    #central-beard-areas .area-box:nth-child(3) { background-Image: url('Images/central-beard-2.jpg'); }
    #central-beard-areas .area-box:nth-child(4) { background-Image: url('Images/central-beard-5.jpg'); }
    #central-beard-areas .area-box:nth-child(5) { background-Image: url('Images/central-beard-8.jpg'); }
    #central-beard-areas .area-box:nth-child(6) { background-Image: url('Images/central-beard-112.jpg'); }
    #central-beard-areas .area-box:nth-child(7) { background-Image: url('Images/central-beard-14.jpg'); }
    #central-beard-areas .area-box:nth-child(8) { background-Image: url('Images/central-beard-172.jpg'); }
    #central-beard-areas .area-box:nth-child(9) { background-Image: url('Images/central-beard-20.jpg'); }
    
    /* Density button background Images */
    #backside-density button:nth-child(2) { background-Image: url('Images/density-0.jpg'); }
    #backside-density button:nth-child(3) { background-Image: url('Images/density-10.jpg'); }
    #backside-density button:nth-child(4) { background-Image: url('Images/density-25.jpg'); }
    #backside-density button:nth-child(5) { background-Image: url('Images/density-50.jpg'); }
    #backside-density button:nth-child(6) { background-Image: url('Images/density-75.jpg'); }
    #backside-density button:nth-child(7) { background-Image: url('Images/density-90.jpg'); }
    
    /* Apply same density Images to all sections */
    #topside-density button:nth-child(2) { background-Image: url('Images/density-0.jpg'); }
    #topside-density button:nth-child(3) { background-Image: url('Images/density-10.jpg'); }
    #topside-density button:nth-child(4) { background-Image: url('Images/density-25.jpg'); }
    #topside-density button:nth-child(5) { background-Image: url('Images/density-50.jpg'); }
    #topside-density button:nth-child(6) { background-Image: url('Images/density-75.jpg'); }
    #topside-density button:nth-child(7) { background-Image: url('Images/density-90.jpg'); }
    
    #leftside-density button:nth-child(2) { background-Image: url('Images/density-0.jpg'); }
    #leftside-density button:nth-child(3) { background-Image: url('Images/density-10.jpg'); }
    #leftside-density button:nth-child(4) { background-Image: url('Images/density-25.jpg'); }
    #leftside-density button:nth-child(5) { background-Image: url('Images/density-50.jpg'); }
    #leftside-density button:nth-child(6) { background-Image: url('Images/density-75.jpg'); }
    #leftside-density button:nth-child(7) { background-Image: url('Images/density-90.jpg'); }
    
    #rightside-density button:nth-child(2) { background-Image: url('Images/density-0.jpg'); }
    #rightside-density button:nth-child(3) { background-Image: url('Images/density-10.jpg'); }
    #rightside-density button:nth-child(4) { background-Image: url('Images/density-25.jpg'); }
    #rightside-density button:nth-child(5) { background-Image: url('Images/density-50.jpg'); }
    #rightside-density button:nth-child(6) { background-Image: url('Images/density-75.jpg'); }
    #rightside-density button:nth-child(7) { background-Image: url('Images/density-90.jpg'); }
    
    #right-beard-density button:nth-child(2) { background-Image: url('Images/density-0.jpg'); }
    #right-beard-density button:nth-child(3) { background-Image: url('Images/density-10.jpg'); }
    #right-beard-density button:nth-child(4) { background-Image: url('Images/density-25.jpg'); }
    #right-beard-density button:nth-child(5) { background-Image: url('Images/density-50.jpg'); }
    #right-beard-density button:nth-child(6) { background-Image: url('Images/density-75.jpg'); }
    #right-beard-density button:nth-child(7) { background-Image: url('Images/density-90.jpg'); }
    
    #left-beard-density button:nth-child(2) { background-Image: url('Images/density-0.jpg'); }
    #left-beard-density button:nth-child(3) { background-Image: url('Images/density-10.jpg'); }
    #left-beard-density button:nth-child(4) { background-Image: url('Images/density-25.jpg'); }
    #left-beard-density button:nth-child(5) { background-Image: url('Images/density-50.jpg'); }
    #left-beard-density button:nth-child(6) { background-Image: url('Images/density-75.jpg'); }
    #left-beard-density button:nth-child(7) { background-Image: url('Images/density-90.jpg'); }
    
    #central-beard-density button:nth-child(2) { background-Image: url('Images/density-0.jpg'); }
    #central-beard-density button:nth-child(3) { background-Image: url('Images/density-10.jpg'); }
    #central-beard-density button:nth-child(4) { background-Image: url('Images/density-25.jpg'); }
    #central-beard-density button:nth-child(5) { background-Image: url('Images/density-50.jpg'); }
    #central-beard-density button:nth-child(6) { background-Image: url('Images/density-75.jpg'); }
    #central-beard-density button:nth-child(7) { background-Image: url('Images/density-90.jpg'); }
    
    
.density-container button:nth-child(2) { background-Image: url('Images/density-0.jpg'); }
.density-container button:nth-child(3) { background-Image: url('Images/density-10.jpg'); }
.density-container button:nth-child(4) { background-Image: url('Images/density-25.jpg'); }
.density-container button:nth-child(5) { background-Image: url('Images/density-50.jpg'); }
.density-container button:nth-child(6) { background-Image: url('Images/density-75.jpg'); }
.density-container button:nth-child(7) { background-Image: url('Images/density-90.jpg'); }

.plus.glow {
  box-shadow: 0 0 6px 3px #00ff00; /* Green glow */
}

.minus.glow {
  box-shadow: 0 0 6px 3px #ff0000; /* Red glow */
}


.area-box.selected {
  z-index: 10;
}


.title-banner {
  background-color: #0077cc;
  color: white;
  padding: 15px;
  text-align: center;
  margin-bottom: 20px;
  border-radius: 8px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.title-banner h2 {
  margin: 0;
  font-size: 24px;
  font-weight: normal;
}


.help-icon {
  display: inline-block;
  background-color: white;
  color: black;
  border-radius: 50%;
  border: 1px solid #999;
  width: 18px;
  height: 18px;
  font-size: 14px;
  font-weight: bold;
  text-align: center;
  line-height: 18px;
  cursor: pointer;
  position: relative;
  margin-left: 5px;
}

.help-tooltip {
  position: absolute;
  top: 22px;
  left: 0;
  background-color: white;
  border: 1px solid #ccc;
  padding: 6px 10px;
  font-size: 14px;
  border-radius: 6px;
  white-space: nowrap;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  display: none;
  z-index: 1000;
}


  .help-box {
    width: 220px;
    height: 140px;
    background-size: cover;
    background-position: center;
    border: 2px solid #aaa;
    border-radius: 8px;
    padding: 10px;
    font-size: 14px;
    color: #000;
    position: absolute;
    top: 22px;
    left: 0;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    display: none;
  }


#results-summary {
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
    margin: 10px 0 20px 0;
}

.result-box {
    font-size: 14px;
    padding: 6px 10px;
    border-radius: 6px;
    font-weight: bold;
    min-width: 100px;
    text-align: center;
    color: black;
}

#floating-preview {
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;

  position: fixed;
  top: 20px;
  right: 20px;
  width: 200px;
  max-height: 300px;
  overflow-y: auto;
  background-color: rgba(255, 255, 255, 0.95);
  border: 2px solid #0077cc;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  padding: 8px;
  display: none;
  z-index: 9999;
}


/* --- Added: Ring meters + enhanced banner + total gauge --- */
.title-banner {
  background: linear-gradient(135deg, #0ea5e9, #2563eb);
  position: relative;
  overflow: visible;
}
.title-banner::after{
  content: "";
  position: absolute;
  inset: -40% -20%;
  background: radial-gradient(circle at 20% 20%, rgba(255,255,255,.2), transparent 50%),
              radial-gradient(circle at 80% 0%, rgba(255,255,255,.15), transparent 50%);
  pointer-events: none;
}
.title-sub {
  font-size: 13px;
  opacity: .9;
  margin-top: 4px;
}
#score-rings {
  display:flex;
  gap:14px;
  justify-content:center;
  flex-wrap:wrap;
  margin: 6px 0 16px 0;
}
.ring {
  width: 90px;
  height: 90px;
  border-radius: 50%;
  background: conic-gradient(#22c55e 0% 0%, #e5e7eb 0%);
  display:grid;
  place-items:center;
  position: relative;
  box-shadow: 0 4px 10px rgba(0,0,0,.08);
}
.ring::before {
  content:"";
  position:absolute;
  width: 68px;
  height: 68px;
  background: white;
  border-radius: 50%;
}
.ring-label, .ring-val {
  position: absolute;
  text-align:center;
  pointer-events:none;
}
.ring-val { font-weight: 700; font-size: 16px; }
.ring-label { bottom: -20px; font-size: 12px; color:#374151; width: 100%; }
#result {
  background: white;
  border-radius: 10px;
  padding: 10px 14px;
  display:inline-block;
  margin: 12px auto;
  border: 1px solid #e5e7eb;
  box-shadow: 0 6px 16px rgba(2,132,199,.1);
}
#scalp-progress {
  height: 8px;
  width: 280px;
  max-width: 90vw;
  background: #eef2ff;
  border-radius: 999px;
  overflow: hidden;
  margin: 8px auto 0 auto;
  border: 1px solid #e5e7eb;
}
#scalp-progress > div {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, #22c55e, #ef4444);
  transition: width .25s ease;
}
/* --- End Added CSS --- */


/* Scalp progress scale */
#scalp-scale { width: 280px; max-width: 90vw; margin: 6px auto 0 auto; }
#scalp-scale .ticks {
  height: 8px;
  background:
    linear-gradient(to right, transparent, transparent),
    repeating-linear-gradient(
      to right,
      #bdbdbd,
      #bdbdbd 1px,
      transparent 1px,
      transparent 10%
    );
  border-radius: 3px;
}
#scalp-scale .labels {
  display: flex;
  justify-content: space-between;
  font-size: 10px;
  color: #666;
  margin-top: 2px;
  line-height: 1;
}
#scalp-scale .labels span { white-space: nowrap; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- Preload all beard Images -->
  <link rel="preload" as="Image" href="Images/left-beard-0.jpg" fetchpriority="high">
  <link rel="preload" as="Image" href="Images/left-beard-1.jpg" fetchpriority="high">
  <link rel="preload" as="Image" href="Images/left-beard-4.jpg" fetchpriority="high">
  <link rel="preload" as="Image" href="Images/left-beard-10.jpg" fetchpriority="high">
  <link rel="preload" as="Image" href="Images/left-beard-16.jpg" fetchpriority="high">
  <link rel="preload" as="Image" href="Images/left-beard-224.jpg" fetchpriority="high">
  <link rel="preload" as="Image" href="Images/left-beard-28.jpg" fetchpriority="high">
  <link rel="preload" as="Image" href="Images/left-beard-344.jpg" fetchpriority="high">
  <link rel="preload" as="Image" href="Images/left-beard-40.jpg" fetchpriority="high">

  <link rel="preload" as="Image" href="Images/right-beard-0.jpg" fetchpriority="high">
  <link rel="preload" as="Image" href="Images/right-beard-1.jpg" fetchpriority="high">
  <link rel="preload" as="Image" href="Images/right-beard-4.jpg" fetchpriority="high">
  <link rel="preload" as="Image" href="Images/right-beard-10.jpg" fetchpriority="high">
  <link rel="preload" as="Image" href="Images/right-beard-16.jpg" fetchpriority="high">
  <link rel="preload" as="Image" href="Images/right-beard-224.jpg" fetchpriority="high">
  <link rel="preload" as="Image" href="Images/right-beard-28.jpg" fetchpriority="high">
  <link rel="preload" as="Image" href="Images/right-beard-344.jpg" fetchpriority="high">
  <link rel="preload" as="Image" href="Images/right-beard-40.jpg" fetchpriority="high">

  <link rel="preload" as="Image" href="Images/central-beard-0.jpg" fetchpriority="high">
  <link rel="preload" as="Image" href="Images/central-beard-05.jpg" fetchpriority="high">
  <link rel="preload" as="Image" href="Images/central-beard-2.jpg" fetchpriority="high">
  <link rel="preload" as="Image" href="Images/central-beard-5.jpg" fetchpriority="high">
  <link rel="preload" as="Image" href="Images/central-beard-8.jpg" fetchpriority="high">
  <link rel="preload" as="Image" href="Images/central-beard-112.jpg" fetchpriority="high">
  <link rel="preload" as="Image" href="Images/central-beard-14.jpg" fetchpriority="high">
  <link rel="preload" as="Image" href="Images/central-beard-172.jpg" fetchpriority="high">
  <link rel="preload" as="Image" href="Images/central-beard-20.jpg" fetchpriority="high">


  <!-- Preload key eyebrow Images -->
<link rel="preload" as="Image" href="Images/left-eyebrow-0.jpg" fetchpriority="high">
<link rel="preload" as="Image" href="Images/left-eyebrow-15.jpg" fetchpriority="high">
<link rel="preload" as="Image" href="Images/right-eyebrow-0.jpg" fetchpriority="high">
<link rel="preload" as="Image" href="Images/right-eyebrow-15.jpg" fetchpriority="high">

<!-- Preload key eyelash Images -->
<link rel="preload" as="Image" href="Images/left-eyelash-0.jpg" fetchpriority="high">
<link rel="preload" as="Image" href="Images/right-eyelash-0.jpg" fetchpriority="high">





<style>
  /* Keep #results-summary for layout/preview, hide only its original inner text background */
  #results-summary {
    background: none !important;
    box-shadow: none !important;
    padding: 0 !important;
    font-size: 0 !important;
  }
  #results-summary > * { display: none !important; }
</style>


<style>
  /* Visually collapse banner but keep contents in DOM (for scripts that depend on them) */
  #results-summary {
    background: none !important;
    box-shadow: none !important;
    padding: 0 !important;
    margin: 0 !important;
    border: none !important;
    max-height: 0 !important;
    overflow: hidden !important;
  }
</style>


<style>
/* --- Fancy ring animations --- */
.ring { will-change: background, transform, box-shadow; }

/* Pulse on update */
@keyframes ring-pop {
  0%   { transform: scale(0.96); box-shadow: 0 4px 10px rgba(0,0,0,.08); }
  50%  { transform: scale(1.04); box-shadow: 0 6px 18px rgba(2,132,199,.20); }
  100% { transform: scale(1);    box-shadow: 0 4px 10px rgba(0,0,0,.08); }
}
.ring.flash { animation: ring-pop 480ms cubic-bezier(.2,.8,.2,1); }

/* Tiny particles that shoot outward from the ring center */
.ring .particle {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: currentColor;
  transform: translate(-50%, -50%);
  opacity: .95;
  pointer-events: none;
  filter: drop-shadow(0 0 4px rgba(0,0,0,.15));
  animation: particle-shoot var(--time, 420ms) ease-out forwards;
}
@keyframes particle-shoot {
  to {
    transform: translate(-50%, -50%) rotate(var(--theta, 0deg)) translate(44px);
    opacity: 0;
  }
}

/* Accessibility */
@media (prefers-reduced-motion: reduce) {
  .ring, .ring.flash, .ring .particle { animation: none !important; transition: none !important; }
}
</style>


<style>
/* --- Floating 'peek' for offscreen ring updates --- */
#ring-peek {
  position: fixed;
  left: 16px;
  top: 16px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 9999;
  pointer-events: none;
}
.peek-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  backdrop-filter: blur(8px);
  background: rgba(255,255,255,0.85);
  border-radius: 14px;
  box-shadow: 0 6px 22px rgba(0,0,0,.12);
  transform: translateY(8px);
  opacity: 0;
  animation: peek-in 240ms cubic-bezier(.2,.8,.2,1) forwards;
  pointer-events: auto;
}
@keyframes peek-in { to { opacity: 1; transform: translateY(0); } }
.peek-item.hide { animation: peek-out 240ms ease forwards; }
@keyframes peek-out { to { opacity: 0; transform: translateY(8px); } }
.peek-title { font: 600 13px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color: #0f172a; }
.peek-value { font: 600 13px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color: #0ea5e9; }
.peek-ring {
  position: relative;
  width: 40px; height: 40px; border-radius: 50%;
  background: conic-gradient(#e5e7eb 0%, #e5e7eb 100%);
  flex: none;
}
.peek-ring::after {
  content: "";
  position: absolute; inset: 6px;
  border-radius: 50%;
  background: white;
}
/* Dark mode friendly-ish */
@media (prefers-color-scheme: dark) {
  .peek-item { background: rgba(15,15,18,0.75); box-shadow: 0 8px 24px rgba(0,0,0,.35); }
  .peek-title { color: #e5e7eb; }
  .peek-ring::after { background: #111827; }
}
@media (prefers-reduced-motion: reduce) {
  #ring-peek, .peek-item { animation: none !important; }
}
</style>

<style>.title-banner { overflow: visible !important; }</style>
</head>
<body>
<style>
@media (max-width: 1200px) {
  #floating-preview, #floating-close-btn {
    display: none !important;
  }
}
</style>
<div class="title-banner" style="position: relative;"><div style="position: absolute; top: 5px; left: 10px;">
<span class="help-icon" onmouseenter="showTooltip(this, 'Click on the Images, + or - to indicate the Images that best fit with the EXTENT of the alopecia areata.')" onmouseleave="hideTooltip(this)">?</span>
</div>
<div style="position: absolute; bottom: 5px; right: 10px; font-size: 12px; color: white; opacity: 0.8;">
    © Reinhart Speeckaert, Nanja van Geel
  </div>
<h2 id="main-title">Alopecia areata calculator</h2>
<div class="title-sub">Select the options that best fit with the extent of alopecia areata</div>
</div>
<div id="pdf-icon-container" style="display: none; text-align: right; margin-bottom: 8px;">
<button id="generate-pdf" style="color: red; font-weight: bold;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 18px;
        color: red;
    " title="Download PDF">
        📄 PDF
    </button>
</div><div id="selected-preview" style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 20px;"></div>
<div id="results-summary" style="padding: 10px; font-size: 18px; background: #e0f0ff; border-radius: 8px; box-shadow: 0 0 5px #ccc;">
<!-- Results will be populated here -->
</div>
<div id="score-rings">
  <div class="ring" id="ring-scalp"><span class="ring-val" id="ring-val-scalp">0%</span><span class="ring-label">Scalp</span></div>
  <div class="ring" id="ring-eyebrows"><span class="ring-val" id="ring-val-eyebrows">0%</span><span class="ring-label">Eyebrows</span></div>
  <div class="ring" id="ring-eyelashes"><span class="ring-val" id="ring-val-eyelashes">0%</span><span class="ring-label">Eyelashes</span></div>
  <div class="ring" id="ring-beard"><span class="ring-val" id="ring-val-beard">0%</span><span class="ring-label">Beard</span></div>
</div>
<div style="text-align: right; margin-top: -10px; margin-bottom: 10px;">
<button id="reset-button" style="background: none; border: none; cursor: pointer; font-size: 20px; color: #0077cc;" title="Reset Page">🔄 Reset</button></div>
<div style="display: flex; justify-content: space-between; align-items: center;">
</div>
<div class="area-container" id="areaContainer"></div>
<div id="result" style="text-align: center; margin: 10px 0; font-size: 20px; font-weight: bold;">Total Scalp Alopecia Areata: 0%</div><div id="scalp-progress"><div></div></div>
<div id="scalp-scale" aria-hidden="true">
  <div class="ticks"></div>
  <div class="labels">
    <span>0%</span>
    <span>10%</span>
    <span>20%</span>
    <span>30%</span>
    <span>40%</span>
    <span>50%</span>
    <span>60%</span>
    <span>70%</span>
    <span>80%</span>
    <span>90%</span>
    <span>100%</span>
  </div>
</div>
<script>

function getColorForPercentage(pct) {
  pct = Math.min(100, Math.max(0, pct));
  const r = pct < 50 ? Math.floor(255 * (pct / 50)) : 255;
  const g = pct < 50 ? 255 : Math.floor(255 * (1 - (pct - 50) / 50));
  const a = 0.8; // alpha = 100% opacity
  return `rgba(${r},${g},0,${a})`;
}

</script>
<script>
const topsideTooltips = ["0%", "1.25%", "2.5%", "10%", "17%", "25%", "32.5%", "40%", "47.5%", "55%", "62.5%", "70%", "77.5%", "85%", "92.5%", "97.5%"];
const topsideMinusTooltips = ["0.5%", "2%", "7.5%", "15%", "22.5%", "30%", "37.5%", "45%", "52.5%", "60%", "67.5%", "75", "82.5%", "90", "96%"];
const topsidePlusTooltips = ["1.7%", "5%", "12.5%", "20%", "27.5%", "35%", "42.5%", "50%", "57.5%", "65%", "72.5%", "80%", "87.5%","95%", "100%"];

const leftsideTooltips = ["0%", "3%", "5%", "10%", "25%", "45%", "60%", "75%", "100%"];
const leftsideMinusTooltips = ["1%", "4.5%", "9%", "20%", "40%", "55%", "70%", "90%"];
const leftsidePlusTooltips = ["4%", "7.5%", "15%", "30%", "50%", "65%", "85%", "100%"];

const rightsideTooltips = [...leftsideTooltips];
const rightsideMinusTooltips = [...leftsideMinusTooltips];
const rightsidePlusTooltips = [...leftsidePlusTooltips];


const scalpSections = {
  backside: {
    id: "backside",
    areas: [
      { label: "", value: 0 },
      { label: "", value: 0.5, minus: 0.25, plus: 0.67 },
      { label: "", value: 1, minus: 0.83, plus: 2 },
      { label: "", value: 4, minus: 3, plus: 5 },
      { label: "", value: 7, minus: 6, plus: 8 },
      { label: "", value: 10, minus: 9, plus: 11 },
      { label: "", value: 13, minus: 12, plus: 14 },
      { label: "", value: 16, minus: 15, plus: 17 },
      { label: "", value: 19, minus: 18, plus: 20 },
      { label: "", value: 22, minus: 21, plus: 23 },
      { label: "", value: 24 }
    ]
  },
  leftside: {
    id: "leftside",
    areas: [
      { label: "", value: 0 },
      { label: "", value: 0.5, minus: 0.25, plus: 0.67 },
      { label: "", value: 1, minus: 0.83, plus: 1.33 },
      { label: "", value: 2, minus: 1.67, plus: 3 },
      { label: "", value: 5, minus: 4, plus: 6 },
      { label: "", value: 8, minus: 7, plus: 9 },
      { label: "", value: 11, minus: 10, plus: 12 },
      { label: "", value: 14, minus: 13, plus: 15 },
      { label: "", value: 18, minus: 16, plus: 18 }
    ]
  },
  rightside: {
    id: "rightside",
    areas: [
      { label: "", value: 0 },
      { label: "", value: 0.5, minus: 0.25, plus: 0.67 },
      { label: "", value: 1, minus: 0.83, plus: 1.33 },
      { label: "", value: 2, minus: 1.67, plus: 3 },
      { label: "", value: 5, minus: 4, plus: 6 },
      { label: "", value: 8, minus: 7, plus: 9 },
      { label: "", value: 11, minus: 10, plus: 12 },
      { label: "", value: 14, minus: 13, plus: 15 },
      { label: "", value: 18, minus: 16, plus: 18 }
    ]
  },
  topside: {
    id: "topside",
    areas: [
      { label: "", value: 0 },
      { label: "", value: 0.5, minus: 0.25, plus: 0.7 },
      { label: "", value: 1, minus: 0.8, plus: 2 },
      { label: "", value: 4, minus: 3, plus: 5 },
      { label: "", value: 7, minus: 6, plus: 8 },
      { label: "", value: 10, minus: 9, plus: 11 },
      { label: "", value: 13, minus: 12, plus: 14 },
      { label: "", value: 16, minus: 15, plus: 17 },
      { label: "", value: 19, minus: 18, plus: 20 },
      { label: "", value: 22, minus: 21, plus: 23 },
      { label: "", value: 25, minus: 24, plus: 26 },
      { label: "", value: 28, minus: 27, plus: 29 },
      { label: "", value: 31, minus: 30, plus: 32 },
      { label: "", value: 34, minus: 33, plus: 35 },
      { label: "", value: 37, minus: 36, plus: 37.3 },
      { label: "", value: 40, minus: 38.3, plus: 40 }
    ]
  }
};

const totalResultDiv = document.getElementById("result");
let globalSelections = {};

function renderScalpSection(section) {
  const container = document.createElement('div');
  container.innerHTML = `
    <h3>${
  section.id === "backside" ? "Back of the scalp" :
  section.id === "leftside" ? "Left side of the scalp" :
  section.id === "rightside" ? "Right side of the scalp" :
  section.id === "topside" ? "Top of the scalp" :
  section.id
}</h3>
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div></div>
      <div class="density-container" id="${section.id}-density">
        <label>Hair Density:<span class="help-icon" onmouseenter="showTooltip(this, 'Mark the density of hairs in the alopecia areata patches')" onmouseleave="hideTooltip(this)">?</span></label>
        <button data-density="0" class="selected"></button>
        <button data-density="10"></button>
        <button data-density="25"></button>
        <button data-density="50"></button>
        <button data-density="75"></button>
        <button data-density="90"></button>
      </div>
    </div>
    <div class="area-container" id="${section.id}-areas"></div>
  `;
  
  if (section.id === "backside") {
    const previewDiv = document.getElementById("selected-preview");
    document.body.insertBefore(previewDiv, totalResultDiv);
  }
  document.body.insertBefore(container, totalResultDiv);


  const areaBox = container.querySelector(`#${section.id}-areas`);
  globalSelections[section.id] = { selected: new Set(), density: 0 };

  section.areas.forEach(area => {
    const box = document.createElement("div");
    box.className = "area-box";
    box.innerText = area.label;
    box.dataset.value = area.value;

    if (area.minus !== undefined) {
      const minus = document.createElement("div");
      minus.className = "minus";
      minus.innerText = "−";
      minus.title = `${area.minus}%`;
      minus.onclick = (e) => {
        e.stopPropagation();
        toggleScalpSelection(section.id, area.minus);
      };
      box.appendChild(minus);
    }

    if (area.plus !== undefined) {
      const plus = document.createElement("div");
      plus.className = "plus";
      plus.innerText = "+";
      plus.title = `${area.plus}%`;
      plus.onclick = (e) => {
        e.stopPropagation();
        toggleScalpSelection(section.id, area.plus);
      };
      box.appendChild(plus);
    }

    box.onclick = () => {
      toggleScalpSelection(section.id, area.value);
    };

    areaBox.appendChild(box);
  });

  container.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", () => {
      globalSelections[section.id].density = parseInt(btn.dataset.density);
      container.querySelectorAll("button").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      updateScalpUI();
    });
  });
}


function toggleScalpSelection(sectionId, value) {
  const selection = globalSelections[sectionId];
  const valueStr = value.toString();
  const alreadySelected = Array.from(selection.selected).some(v => v.toString() === valueStr);
  if (alreadySelected) {
    selection.selected.forEach(v => {
      if (v.toString() === valueStr) selection.selected.delete(v);
    });
  } else {
    selection.selected.clear();
    selection.selected.add(value);
  }
  updateScalpUI();
}
function updateScalpUI() {
  setTimeout(updateSelectedPreview, 0);
  let total = 0;
  for (const [sectionId, data] of Object.entries(globalSelections)) {
    const boxEls = document.querySelectorAll(`#${sectionId}-areas .area-box`);
    boxEls.forEach(box => {
      const val = parseFloat(box.dataset.value);
      const isSelected = data.selected.has(val);
      
      const plusEl = box.querySelector(".plus");
      const minusEl = box.querySelector(".minus");
      const plusVal = plusEl ? parseFloat(plusEl.title) : null;
      const minusVal = minusEl ? parseFloat(minusEl.title) : null;
      const isPlusSelected = plusVal !== null && data.selected.has(plusVal);
      const isMinusSelected = minusVal !== null && data.selected.has(minusVal);
      box.classList.toggle("selected", isSelected || isPlusSelected || isMinusSelected);

      if (box.querySelector(".plus")) {
        const plusVal = parseFloat(box.querySelector(".plus").title);
        const isPlusSelected = data.selected.has(plusVal);
        box.querySelector(".plus").style.backgroundColor = isPlusSelected ? "#ccffcc" : "white";
        box.querySelector(".plus").style.transform = isPlusSelected ? "scale(1.3)" : "scale(1)";
        box.querySelector(".plus").classList.toggle("glow", isPlusSelected);
      }
      if (box.querySelector(".minus")) {
        const minusVal = parseFloat(box.querySelector(".minus").title);
        const isMinusSelected = data.selected.has(minusVal);
        box.querySelector(".minus").style.backgroundColor = isMinusSelected ? "#ffcccc" : "white";
        box.querySelector(".minus").style.transform = isMinusSelected ? "scale(1.3)" : "scale(1)";
        box.querySelector(".minus").classList.toggle("glow", isMinusSelected);
      }
    });
    const subtotal = Array.from(data.selected).reduce((sum, val) => sum + val, 0);
    total += subtotal * (1 - data.density / 100);
  }
  totalResultDiv.innerText = `Total Scalp Alopecia Areata: ${total.toFixed(2)}%`;
  const titleElement = document.getElementById("main-title");
  if (titleElement) {
    titleElement.textContent = `Alopecia areata calculator: Scalp (=${total.toFixed(2)}%)`;
  }
}

Object.values(scalpSections).forEach(renderScalpSection);

// Add tooltips to backside section elements
const backsideValues = [0, 0.5, 1, 4, 7, 10, 13, 16, 19, 22, 24];
const backsideTooltips = ["0%", "2%", "5%", "15%", "30%", "40%", "55%", "65%", "80%", "90%", "100%"];
const minusTooltips = ["1%", "3.5%", "12.5%", "25%", "37.5%", "50%", "62.5%", "75%", "87.5%"];
const plusTooltips = ["2.5%", "10%", "20%", "35%", "45%", "60%", "70%", "85%", "95%"];


function createTooltip(text) {
  const tip = document.createElement("div");
  tip.className = "tooltip";
  tip.innerText = text;
  const match = text.match(/(\d+(\.\d+)?)/);
  if (match) {
    const value = parseFloat(match[1]);
    tip.style.backgroundColor = getColorForPercentage(value);
  }
  return tip;
}

function applyTooltips() {
  const boxes = document.querySelectorAll("#backside-areas .area-box");
  boxes.forEach((box, i) => {
    const percent = backsideTooltips[i];
    const tip = createTooltip(percent);
    box.appendChild(tip);
    tip.style.display = "none";

    function showTip() {
      tip.style.display = "block";
    }

    function hideTip() {
      if (!box.classList.contains("selected")) {
        tip.style.display = "none";
      }
    }

    box.addEventListener("mouseenter", showTip);
    box.addEventListener("mouseleave", hideTip);
    box.addEventListener("click", () => {
      document.querySelectorAll("#backside-areas .tooltip").forEach(t => t.style.display = "none");
      tip.style.display = "block";
    });

    const minus = box.querySelector(".minus");
    if (minus && minusTooltips[i - 1]) {
      const minusTip = createTooltip(minusTooltips[i - 1]);
      box.appendChild(minusTip);
      minusTip.style.display = "none";

      minus.addEventListener("mouseenter", () => {
        if (!globalSelections['backside'].selected.has(parseFloat(minus.title))) {
          minusTip.style.display = "block";
        }
      });
      minus.addEventListener("mouseleave", () => {
        if (!globalSelections['backside'].selected.has(parseFloat(minus.title))) {
          minusTip.style.display = "none";
        }
      });
      minus.addEventListener("click", () => {
        document.querySelectorAll("#backside-areas .tooltip").forEach(t => t.style.display = "none");
        minusTip.style.display = "block";
      });
    }

    const plus = box.querySelector(".plus");
    if (plus && plusTooltips[i - 1]) {
      const plusTip = createTooltip(plusTooltips[i - 1]);
      box.appendChild(plusTip);
      plusTip.style.display = "none";

      plus.addEventListener("mouseenter", () => {
        if (!globalSelections['backside'].selected.has(parseFloat(plus.title))) {
          plusTip.style.display = "block";
        }
      });
      plus.addEventListener("mouseleave", () => {
        if (!globalSelections['backside'].selected.has(parseFloat(plus.title))) {
          plusTip.style.display = "none";
        }
      });
      plus.addEventListener("click", () => {
        document.querySelectorAll("#backside-areas .tooltip").forEach(t => t.style.display = "none");
        plusTip.style.display = "block";
      });
    }
  });
}


function applyTooltipsToSection(sectionId, areaTooltips, minusTooltips, plusTooltips) {
  const boxes = document.querySelectorAll(`#${sectionId}-areas .area-box`);
  boxes.forEach((box, i) => {
    const percent = areaTooltips[i];
    const tip = createTooltip(percent);
    box.appendChild(tip);
    tip.style.display = "none";

    function showTip() {
      tip.style.display = "block";
    }

    function hideTip() {
      if (!box.classList.contains("selected")) {
        tip.style.display = "none";
      }
    }

    box.addEventListener("mouseenter", showTip);
    box.addEventListener("mouseleave", hideTip);
    box.addEventListener("click", () => {
      document.querySelectorAll(`#${sectionId}-areas .tooltip`).forEach(t => t.style.display = "none");
      tip.style.display = "block";
    });

    const minus = box.querySelector(".minus");
    if (minus && minusTooltips[i - 1]) {
      const minusTip = createTooltip(minusTooltips[i - 1]);
      box.appendChild(minusTip);
      minusTip.style.display = "none";

      minus.addEventListener("mouseenter", () => {
        if (!globalSelections[sectionId].selected.has(parseFloat(minus.title))) {
          minusTip.style.display = "block";
        }
      });
      minus.addEventListener("mouseleave", () => {
        if (!globalSelections[sectionId].selected.has(parseFloat(minus.title))) {
          minusTip.style.display = "none";
        }
      });
      minus.addEventListener("click", () => {
        document.querySelectorAll(`#${sectionId}-areas .tooltip`).forEach(t => t.style.display = "none");
        minusTip.style.display = "block";
      });
    }

    const plus = box.querySelector(".plus");
    if (plus && plusTooltips[i - 1]) {
      const plusTip = createTooltip(plusTooltips[i - 1]);
      box.appendChild(plusTip);
      plusTip.style.display = "none";

      plus.addEventListener("mouseenter", () => {
        if (!globalSelections[sectionId].selected.has(parseFloat(plus.title))) {
          plusTip.style.display = "block";
        }
      });
      plus.addEventListener("mouseleave", () => {
        if (!globalSelections[sectionId].selected.has(parseFloat(plus.title))) {
          plusTip.style.display = "none";
        }
      });
      plus.addEventListener("click", () => {
        document.querySelectorAll(`#${sectionId}-areas .tooltip`).forEach(t => t.style.display = "none");
        plusTip.style.display = "block";
      });
    }
  });
}

window.addEventListener("DOMContentLoaded", function() {
  applyTooltips();
  applyTooltipsToSection("topside", topsideTooltips, topsideMinusTooltips, topsidePlusTooltips);
  applyTooltipsToSection("leftside", leftsideTooltips, leftsideMinusTooltips, leftsidePlusTooltips);
  applyTooltipsToSection("rightside", rightsideTooltips, rightsideMinusTooltips, rightsidePlusTooltips);
});
</script>
<!-- Eyebrow Section -->
<h3 id="eyebrow-title" style="margin-bottom: 5px;">Eyebrows (0.00%)</h3>
<div style="display: flex; flex-direction: column; align-items: center; gap: 0px;">
<div>
<h4 style="text-align: center; margin-bottom: 0px;">Right Eyebrow</h4>
<div class="area-container" id="right-eyebrow-areas"></div>
</div>
<div>
<h4 style="text-align: center; margin-bottom: 0px;">Left Eyebrow</h4>
<div class="area-container" id="left-eyebrow-areas"></div>
</div>
</div>
<script>
const eyebrowAreas = [
  { label: "", value: 0 },
  { label: "", value: 2.5, minus: 1.25, plus: 3.8 },
  { label: "", value: 5, plus: 10 },
  { label: "", value: 15, plus: 20 },
  { label: "", value: 25, plus: 30 },
  { label: "", value: 35, plus: 40 },
  { label: "", value: 50, plus: 50 }
];

let eyebrowSelections = {
  left: new Set(),
  right: new Set()
};

function renderEyebrow(side) {
  const container = document.getElementById(`${side}-eyebrow-areas`);
  eyebrowAreas.forEach(area => {
    const box = document.createElement("div");
    box.className = "area-box";
    box.innerText = area.label;
    box.dataset.value = area.value;

    if (area.minus !== undefined) {
      const minus = document.createElement("div");
      minus.className = "minus";
      minus.innerText = "−";
      minus.title = `${area.minus}%`;
      minus.onclick = (e) => {
        e.stopPropagation();
        toggleEyebrowSelection(side, area.minus);
      };
      box.appendChild(minus);
    }

    if (area.plus !== undefined) {
      const plus = document.createElement("div");
      plus.className = "plus";
      plus.innerText = "+";
      plus.title = `${area.plus}%`;
      plus.onclick = (e) => {
        e.stopPropagation();
        toggleEyebrowSelection(side, area.plus);
      };
      box.appendChild(plus);
    }

    box.onclick = () => {
      toggleEyebrowSelection(side, area.value);
    };

    container.appendChild(box);
  });
}

function toggleEyebrowSelection(side, value) {
  const val = parseFloat(value);
  const alreadySelected = Array.from(eyebrowSelections[side]).some(v => v === val);
  if (alreadySelected) {
    eyebrowSelections[side].delete(val);
  } else {
    eyebrowSelections[side].clear();
    eyebrowSelections[side].add(val);
  }
  updateEyebrowUI();
}

function updateEyebrowUI() {
  setTimeout(updateSelectedPreview, 0);
  ["left", "right"].forEach(side => {
    const boxEls = document.querySelectorAll(`#${side}-eyebrow-areas .area-box`);
    boxEls.forEach(box => {
      const val = parseFloat(box.dataset.value);
      const isSelected = eyebrowSelections[side].has(val);
      
      const plusEl = box.querySelector(".plus");
      const minusEl = box.querySelector(".minus");
      const plusVal = plusEl ? parseFloat(plusEl.title) : null;
      const minusVal = minusEl ? parseFloat(minusEl.title) : null;
      const isPlusSelected = plusVal !== null && eyebrowSelections[side].has(plusVal);
      const isMinusSelected = minusVal !== null && eyebrowSelections[side].has(minusVal);
      box.classList.toggle("selected", isSelected || isPlusSelected || isMinusSelected);

      if (box.querySelector(".plus")) {
        const plusVal = parseFloat(box.querySelector(".plus").title);
        const isPlusSelected = eyebrowSelections[side].has(plusVal);
        box.querySelector(".plus").style.backgroundColor = isPlusSelected ? "#ccffcc" : "white";
        box.querySelector(".plus").style.transform = isPlusSelected ? "scale(1.3)" : "scale(1)";
        box.querySelector(".plus").classList.toggle("glow", isPlusSelected);
      }
      if (box.querySelector(".minus")) {
        const minusVal = parseFloat(box.querySelector(".minus").title);
        const isMinusSelected = eyebrowSelections[side].has(minusVal);
        box.querySelector(".minus").style.backgroundColor = isMinusSelected ? "#ffcccc" : "white";
        box.querySelector(".minus").style.transform = isMinusSelected ? "scale(1.3)" : "scale(1)";
        box.querySelector(".minus").classList.toggle("glow", isMinusSelected);
      }
    });
  });

  const total = [...eyebrowSelections.left, ...eyebrowSelections.right].reduce((sum, val) => sum + val, 0);
  document.getElementById("eyebrow-title").innerText = `Eyebrows (${total.toFixed(2)}%)`;
}



function updateSelectedPreview() {
  const container = document.getElementById("selected-preview");
  if (!container) return;
  container.innerHTML = "";

  const previews = [];

  document.querySelectorAll(".area-box").forEach(box => {
    const value = parseFloat(box.dataset.value);
    const style = window.getComputedStyle(box);
    const bgImage = style.backgroundImage;
    const match = bgImage.match(/url\(["']?(.*?)["']?\)/);
    if (!match) return;

    const section = box.closest(".area-container");
    if (!section) return;

    const width = box.offsetWidth;
    const height = box.offsetHeight;

    let isMain = box.classList.contains("selected");
    let isPlus = false;
    let isMinus = false;

    const plus = box.querySelector(".plus");
    const minus = box.querySelector(".minus");

    if (plus) {
      if (!isMain && plus.classList.contains("glow")) {
        isPlus = true;
      }
    }

    if (minus) {
      if (!isMain && minus.classList.contains("glow")) {
        isMinus = true;
      }
    }

    if (!(isMain || isPlus || isMinus)) return;

    const previewBox = document.createElement("div");
    previewBox.style.width = width + "px";
    previewBox.style.height = height + "px";
    previewBox.style.backgroundImage = `url('${match[1]}')`;
    previewBox.style.backgroundSize = "cover";
    previewBox.style.backgroundPosition = "center";
    previewBox.style.border = "2px solid #0077cc";
    previewBox.style.borderRadius = "6px";
    previewBox.style.position = "relative";
    previewBox.style.transform = "scale(1)";
    previewBox.style.transformOrigin = "top left";
    previewBox.style.flex = "0 0 auto";

    if (plus && plus.classList.contains("glow")) {
      const plusEl = document.createElement("div");
      plusEl.className = "plus glow";
      plusEl.innerText = "+";
      plusEl.style.position = "absolute";
      plusEl.style.top = "-10px";
      plusEl.style.right = "5px";
      previewBox.appendChild(plusEl);
    }

    if (minus && minus.classList.contains("glow")) {
      const minusEl = document.createElement("div");
      minusEl.className = "minus glow";
      minusEl.innerText = "−";
      minusEl.style.position = "absolute";
      minusEl.style.top = "-10px";
      minusEl.style.left = "5px";
      previewBox.appendChild(minusEl);
    }

    let selectedValue = null;
    if (plus && plus.classList.contains("glow")) {
        selectedValue = parseFloat(plus.title);
    } else if (minus && minus.classList.contains("glow")) {
        selectedValue = parseFloat(minus.title);
    } else if (box.classList.contains("selected")) {
        selectedValue = value;
    }

    if (selectedValue !== null) {
        let density = 0;
        const sectionDiv = box.closest("[id$='-areas']");
        let sectionId = "";
        if (sectionDiv && sectionDiv.id) {
            sectionId = sectionDiv.id.replace("-areas", "");

            if (globalSelections[sectionId]) {
                density = globalSelections[sectionId].density;
            } else if (beardSelections[sectionId]) {
                density = beardSelections[sectionId].density;
            }

            const adjusted = Math.round(selectedValue * (1 - density / 100));

            const infoLabel = document.createElement("div");
            infoLabel.style.position = "absolute";
            infoLabel.style.bottom = "2px";
            infoLabel.style.right = "4px";
            infoLabel.style.fontSize = "13px";
            infoLabel.style.background = "rgba(255,255,255,0.8)";
            infoLabel.style.padding = "2px 4px";
            infoLabel.style.borderRadius = "4px";
            infoLabel.style.boxShadow = "0 0 2px rgba(0,0,0,0.2)";
            infoLabel.innerText = `${adjusted}%; (Dens:${density}%)`;
            previewBox.appendChild(infoLabel);
        }

        previews.push({ sectionId, element: previewBox });
    }
  });

  const desiredOrder = [
    "leftside", "backside", "rightside", "topside",
    "right-eyebrow", "left-eyebrow",
    "right-eyelash", "left-eyelash",
    "right-beard", "central-beard", "left-beard"
  ];

  previews.sort((a, b) => {
    return desiredOrder.indexOf(a.sectionId) - desiredOrder.indexOf(b.sectionId);
  });

  previews.forEach(item => container.appendChild(item.element));
}



function updateAllPreviews() {
  setTimeout(updateSelectedPreview, 0);

  const floatingPreview = document.getElementById("floating-preview");
  if (floatingPreview) {
    if (container.children.length > 0) {
      floatingPreview.style.opacity = "1";
      floatingPreview.style.pointerEvents = "auto";
    } else {
      floatingPreview.style.opacity = "0";
      floatingPreview.style.pointerEvents = "none";
    }
  }
}

// Initialize eyebrow UI after DOM loads
window.addEventListener("DOMContentLoaded", function() {
  renderEyebrow("left");
  renderEyebrow("right");
  updateEyebrowUI();
});
</script>
<!-- Eyelash Section -->
<h3 id="eyelash-title" style="margin-bottom: 5px;">Eyelashes (0.00%)</h3>
<div style="display: flex; flex-direction: column; align-items: center; gap: 0px;">
<div>
<h4 style="text-align: center; margin-bottom: 0px;">Right Eyelash</h4>
<div class="area-container" id="right-eyelash-areas"></div>
</div>
<div>
<h4 style="text-align: center; margin-bottom: 0px;">Left Eyelash</h4>
<div class="area-container" id="left-eyelash-areas"></div>
</div>
</div>
<script>
let eyelashSelections = {
  left: new Set(),
  right: new Set()
};

function renderEyelash(side) {
  const container = document.getElementById(`${side}-eyelash-areas`);
  eyebrowAreas.forEach(area => {
    const box = document.createElement("div");
    box.className = "area-box";
    box.innerText = area.label;
    box.dataset.value = area.value;

    if (area.minus !== undefined) {
      const minus = document.createElement("div");
      minus.className = "minus";
      minus.innerText = "−";
      minus.title = `${area.minus}%`;
      minus.onclick = (e) => {
        e.stopPropagation();
        toggleEyelashSelection(side, area.minus);
      };
      box.appendChild(minus);
    }

    if (area.plus !== undefined) {
      const plus = document.createElement("div");
      plus.className = "plus";
      plus.innerText = "+";
      plus.title = `${area.plus}%`;
      plus.onclick = (e) => {
        e.stopPropagation();
        toggleEyelashSelection(side, area.plus);
      };
      box.appendChild(plus);
    }

    box.onclick = () => {
      toggleEyelashSelection(side, area.value);
    };

    container.appendChild(box);
  });
}

function toggleEyelashSelection(side, value) {
  const val = parseFloat(value);
  const alreadySelected = Array.from(eyelashSelections[side]).some(v => v === val);
  if (alreadySelected) {
    eyelashSelections[side].delete(val);
  } else {
    eyelashSelections[side].clear();
    eyelashSelections[side].add(val);
  }
  updateEyelashUI();
}

function updateEyelashUI() {
  setTimeout(updateSelectedPreview, 0);
  ["left", "right"].forEach(side => {
    const boxEls = document.querySelectorAll(`#${side}-eyelash-areas .area-box`);
    boxEls.forEach(box => {
      const val = parseFloat(box.dataset.value);
      const isSelected = eyelashSelections[side].has(val);
      
      const plusEl = box.querySelector(".plus");
      const minusEl = box.querySelector(".minus");
      const plusVal = plusEl ? parseFloat(plusEl.title) : null;
      const minusVal = minusEl ? parseFloat(minusEl.title) : null;
      const isPlusSelected = plusVal !== null && eyelashSelections[side].has(plusVal);
      const isMinusSelected = minusVal !== null && eyelashSelections[side].has(minusVal);
      box.classList.toggle("selected", isSelected || isPlusSelected || isMinusSelected);

      if (box.querySelector(".plus")) {
        const plusVal = parseFloat(box.querySelector(".plus").title);
        const isPlusSelected = eyelashSelections[side].has(plusVal);
        box.querySelector(".plus").style.backgroundColor = isPlusSelected ? "#ccffcc" : "white";
        box.querySelector(".plus").style.transform = isPlusSelected ? "scale(1.3)" : "scale(1)";
        box.querySelector(".plus").classList.toggle("glow", isPlusSelected);
      }
      if (box.querySelector(".minus")) {
        const minusVal = parseFloat(box.querySelector(".minus").title);
        const isMinusSelected = eyelashSelections[side].has(minusVal);
        box.querySelector(".minus").style.backgroundColor = isMinusSelected ? "#ffcccc" : "white";
        box.querySelector(".minus").style.transform = isMinusSelected ? "scale(1.3)" : "scale(1)";
        box.querySelector(".minus").classList.toggle("glow", isMinusSelected);
      }
    });
  });

  const total = [...eyelashSelections.left, ...eyelashSelections.right].reduce((sum, val) => sum + val, 0);
  document.getElementById("eyelash-title").innerText = `Eyelashes (${total.toFixed(2)}%)`;
}

window.addEventListener("DOMContentLoaded", function() {
  renderEyelash("left");
  renderEyelash("right");
  updateEyelashUI();
});
</script>
<!-- Beard Area Section -->
<h3 id="beard-title" style="margin-bottom: 0px;">Beard Area (0.00%)</h3>
<div style="display: flex; flex-direction: column; gap: 0px;">
<!-- Right Beard -->
<div>
<h4 style="text-align: center; margin-bottom: 0px;">Right Beard Area</h4>
<div style="display: flex; justify-content: space-between; align-items: center;">
<div></div>
<div class="density-container" id="right-beard-density">
<label>Hair Density:<span class="help-icon" onmouseenter="showTooltip(this, 'Help window 22')" onmouseleave="hideTooltip(this)">?</span></label>
<button class="selected" data-density="0"></button>
<button data-density="10"></button>
<button data-density="25"></button>
<button data-density="50"></button>
<button data-density="75"></button>
<button data-density="90"></button>
</div>
</div>
<div class="area-container" id="right-beard-areas"></div>
</div>
<!-- Left Beard -->
<div>
<h4 style="text-align: center; margin-bottom: 0px;">Left Beard Area</h4>
<div style="display: flex; justify-content: space-between; align-items: center;">
<div></div>
<div class="density-container" id="left-beard-density">
<label>Hair Density:<span class="help-icon" onmouseenter="showTooltip(this, 'Help window 2')" onmouseleave="hideTooltip(this)">?</span></label>
<button class="selected" data-density="0"></button>
<button data-density="10"></button>
<button data-density="25"></button>
<button data-density="50"></button>
<button data-density="75"></button>
<button data-density="90"></button>
</div>
</div>
<div class="area-container" id="left-beard-areas"></div>
</div>
<!-- Central Beard -->
<div>
<h4 style="text-align: center; margin-bottom: 0px;">Central Beard Area</h4>
<div style="display: flex; justify-content: space-between; align-items: center;">
<div></div>
<div class="density-container" id="central-beard-density">
<label>Hair Density:<span class="help-icon" onmouseenter="showTooltip(this, 'Help window 2')" onmouseleave="hideTooltip(this)">?</span></label>
<button class="selected" data-density="0"></button>
<button data-density="10"></button>
<button data-density="25"></button>
<button data-density="50"></button>
<button data-density="75"></button>
<button data-density="90"></button>
</div>
</div>
<div class="area-container" id="central-beard-areas"></div>
</div>
</div>
<script>
const beardSections = {
  "right-beard": {
    id: "right-beard",
    areas: [
      { label: "", value: 0 },
      { label: "", value: 1, minus: 0.5, plus: 2 },
      { label: "", value: 4, minus: 3, plus: 6 },
      { label: "", value: 10, minus: 8, plus: 12 },
      { label: "", value: 16, minus: 14.4, plus: 18 },
      { label: "", value: 22.4, minus: 20, plus: 24 },
      { label: "", value: 28, minus: 26.4, plus: 30.4 },
      { label: "", value: 34.4, minus: 32, plus: 37 },
      { label: "", value: 40 }
    ]
  },
  "left-beard": {
    id: "left-beard",
    areas: [
      { label: "", value: 0 },
      { label: "", value: 1, minus: 0.5, plus: 2 },
      { label: "", value: 4, minus: 3, plus: 6 },
      { label: "", value: 10, minus: 8, plus: 12 },
      { label: "", value: 16, minus: 14.4, plus: 18 },
      { label: "", value: 22.4, minus: 20, plus: 24 },
      { label: "", value: 28, minus: 26.4, plus: 30.4 },
      { label: "", value: 34.4, minus: 32, plus: 37 },
      { label: "", value: 40 }
    ]
  },
  "central-beard": {
    id: "central-beard",
    areas: [
      { label: "", value: 0 },
      { label: "", value: 0.5, minus: 0.25, plus: 1 },
      { label: "", value: 2, minus: 1.5, plus: 3 },
      { label: "", value: 5, minus: 4, plus: 6 },
      { label: "", value: 8, minus: 7.3, plus: 9 },
      { label: "", value: 11.2, minus: 10, plus: 12 },
      { label: "", value: 14, minus: 13.2, plus: 15.2 },
      { label: "", value: 17.2, minus: 16, plus: 18.5 },
      { label: "", value: 20 }
    ]
  }
};

let beardSelections = {};

function renderBeardSection(section) {
  const container = document.getElementById(`${section.id}-areas`);
  beardSelections[section.id] = { selected: new Set(), density: 0 };

  section.areas.forEach(area => {
    const box = document.createElement("div");
    box.className = "area-box";
    box.innerText = area.label;
    box.dataset.value = area.value;

    if (area.minus !== undefined) {
      const minus = document.createElement("div");
      minus.className = "minus";
      minus.innerText = "−";
      minus.title = `${area.minus}%`;
      minus.onclick = (e) => {
        e.stopPropagation();
        toggleBeardSelection(section.id, area.minus);
      };
      box.appendChild(minus);
    }

    if (area.plus !== undefined) {
      const plus = document.createElement("div");
      plus.className = "plus";
      plus.innerText = "+";
      plus.title = `${area.plus}%`;
      plus.onclick = (e) => {
        e.stopPropagation();
        toggleBeardSelection(section.id, area.plus);
      };
      box.appendChild(plus);
    }

    box.onclick = () => {
      toggleBeardSelection(section.id, area.value);
    };

    container.appendChild(box);
  });

  document.querySelectorAll(`#${section.id}-density button`).forEach(btn => {
    btn.addEventListener("click", () => {
      beardSelections[section.id].density = parseInt(btn.dataset.density);
      document.querySelectorAll(`#${section.id}-density button`).forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      updateBeardUI();
    });
  });
}

function toggleBeardSelection(sectionId, value) {
  const selection = beardSelections[sectionId];
  const val = parseFloat(value);
  const alreadySelected = Array.from(selection.selected).some(v => v === val);
  if (alreadySelected) {
    selection.selected.delete(val);
  } else {
    selection.selected.clear();
    selection.selected.add(val);
  }
  updateBeardUI();
}

function updateBeardUI() {
  setTimeout(updateSelectedPreview, 0);
  let total = 0;
  for (const [sectionId, data] of Object.entries(beardSelections)) {
    const boxEls = document.querySelectorAll(`#${sectionId}-areas .area-box`);
    boxEls.forEach(box => {
      const val = parseFloat(box.dataset.value);
      const isSelected = data.selected.has(val);
      
      const plusEl = box.querySelector(".plus");
      const minusEl = box.querySelector(".minus");
      const plusVal = plusEl ? parseFloat(plusEl.title) : null;
      const minusVal = minusEl ? parseFloat(minusEl.title) : null;
      const isPlusSelected = plusVal !== null && data.selected.has(plusVal);
      const isMinusSelected = minusVal !== null && data.selected.has(minusVal);
      box.classList.toggle("selected", isSelected || isPlusSelected || isMinusSelected);

      if (box.querySelector(".plus")) {
        const plusVal = parseFloat(box.querySelector(".plus").title);
        const isPlusSelected = data.selected.has(plusVal);
        box.querySelector(".plus").style.backgroundColor = isPlusSelected ? "#ccffcc" : "white";
        box.querySelector(".plus").style.transform = isPlusSelected ? "scale(1.3)" : "scale(1)";
        box.querySelector(".plus").classList.toggle("glow", isPlusSelected);
      }
      if (box.querySelector(".minus")) {
        const minusVal = parseFloat(box.querySelector(".minus").title);
        const isMinusSelected = data.selected.has(minusVal);
        box.querySelector(".minus").style.backgroundColor = isMinusSelected ? "#ffcccc" : "white";
        box.querySelector(".minus").style.transform = isMinusSelected ? "scale(1.3)" : "scale(1)";
        box.querySelector(".minus").classList.toggle("glow", isMinusSelected);
      }
    });

    const subtotal = Array.from(data.selected).reduce((sum, val) => sum + val, 0);
    total += subtotal * (1 - data.density / 100);
  }

  document.getElementById("beard-title").innerText = `Beard Area (${total.toFixed(2)}%)`;
}

window.addEventListener("DOMContentLoaded", function() {
  Object.values(beardSections).forEach(renderBeardSection);
});
</script>
<script>
// Utility to create a tooltip
function createTooltip(text) {
  const tip = document.createElement("div");
  tip.className = "tooltip";
  tip.innerText = text;
  const match = text.match(/(\d+(\.\d+)?)/);
  if (match) {
    const value = parseFloat(match[1]);
    tip.style.backgroundColor = getColorForPercentage(value);
  }
  return tip;
}

// Apply tooltips to a custom section
function applyTooltipToBoxes(sectionPrefix, tooltips, minusTooltips = [], plusTooltips = [], selections) {
  const boxes = document.querySelectorAll(`#${sectionPrefix}-areas .area-box`);
  boxes.forEach((box, i) => {
    const tip = createTooltip(tooltips[i]);
    box.appendChild(tip);
    tip.style.display = "none";

    function showTip() { tip.style.display = "block"; }
    function hideTip() {
      if (!box.classList.contains("selected")) tip.style.display = "none";
    }

    box.addEventListener("mouseenter", showTip);
    box.addEventListener("mouseleave", hideTip);
    box.addEventListener("click", () => {
      document.querySelectorAll(`#${sectionPrefix}-areas .tooltip`).forEach(t => t.style.display = "none");
      tip.style.display = "block";
    });

    const minus = box.querySelector(".minus");
    if (minus && minusTooltips[i - 1]) {
      const minusTip = createTooltip(minusTooltips[i - 1]);
      box.appendChild(minusTip);
      minusTip.style.display = "none";

      minus.addEventListener("mouseenter", () => {
        if (!selections.has(parseFloat(minus.title))) minusTip.style.display = "block";
      });
      minus.addEventListener("mouseleave", () => {
        if (!selections.has(parseFloat(minus.title))) minusTip.style.display = "none";
      });
      minus.addEventListener("click", () => {
        document.querySelectorAll(`#${sectionPrefix}-areas .tooltip`).forEach(t => t.style.display = "none");
        minusTip.style.display = "block";
      });
    }

    const plus = box.querySelector(".plus");
    if (plus && plusTooltips[i - 1]) {
      const plusTip = createTooltip(plusTooltips[i - 1]);
      box.appendChild(plusTip);
      plusTip.style.display = "none";

      plus.addEventListener("mouseenter", () => {
        if (!selections.has(parseFloat(plus.title))) plusTip.style.display = "block";
      });
      plus.addEventListener("mouseleave", () => {
        if (!selections.has(parseFloat(plus.title))) plusTip.style.display = "none";
      });
      plus.addEventListener("click", () => {
        document.querySelectorAll(`#${sectionPrefix}-areas .tooltip`).forEach(t => t.style.display = "none");
        plusTip.style.display = "block";
      });
    }
  });
}

window.addEventListener("DOMContentLoaded", function () {
  const eyebrowTooltips = ["0%", "5%", "10%", "30%", "50%", "70%", "100%"];
  const eyebrowPlus = ["7.5%", "20%", "40%", "60%", "80%", "100%"];
  const eyebrowMinus = ["2.5%"];
  applyTooltipToBoxes("left-eyebrow", eyebrowTooltips, eyebrowMinus, eyebrowPlus, eyebrowSelections.left);
  applyTooltipToBoxes("right-eyebrow", eyebrowTooltips, eyebrowMinus, eyebrowPlus, eyebrowSelections.right);

  const eyelashTooltips = ["0%", "5%", "10%", "30%", "50%", "70%", "100%"];
  applyTooltipToBoxes("left-eyelash", eyelashTooltips, eyebrowMinus, eyebrowPlus, eyelashSelections.left);
  applyTooltipToBoxes("right-eyelash", eyelashTooltips, eyebrowMinus, eyebrowPlus, eyelashSelections.right);

  const beardTooltips = ["0%", "2.5%", "10%", "25%", "40%", "56%", "70%", "86%", "100%"];
  const beardMinus = ["1.25%", "7.5%", "20%", "36%", "50%", "66%", "80%"];
  const beardPlus = ["5%", "15%", "30%", "45%", "60%", "75%", "92.5%"];
  
  const rightBeardTooltips = ["0%", "2.5%", "10%", "25%", "40%", "56%", "70%", "86%", "100%"];
  const rightBeardMinus = ["1.25%", "7.5%", "20%", "36%", "50%", "66%", "80%"];
  const rightBeardPlus = ["5%", "15%", "30%", "45%", "60%", "75%", "92.5%"];

  const leftBeardTooltips = ["0%", "2.5%", "10%", "25%", "40%", "56%", "70%", "86%", "100%"];
  const leftBeardMinus = ["1.25%", "7.5%", "20%", "36%", "50%", "66%", "80%"];
  const leftBeardPlus = ["5%", "15%", "30%", "45%", "60%", "75%", "92.5%"];

  const centralBeardTooltips = ["0%", "2.5%", "10%", "25%", "40%", "55%", "70%", "85", "100%"];
  const centralBeardMinus = ["1.25%", "7.5%", "20%", "35%", "50%", "65%", "80"];
  const centralBeardPlus = ["5%", "15%", "30%", "45%", "60%", "75%", "92.5"];

  applyTooltipToBoxes("right-beard", rightBeardTooltips, rightBeardMinus, rightBeardPlus, beardSelections["right-beard"].selected);
  applyTooltipToBoxes("left-beard", leftBeardTooltips, leftBeardMinus, leftBeardPlus, beardSelections["left-beard"].selected);
  applyTooltipToBoxes("central-beard", centralBeardTooltips, centralBeardMinus, centralBeardPlus, beardSelections["central-beard"].selected);

});
</script>
<script>
function showTooltip(el, text) {
  let tip = document.createElement('div');
  tip.className = 'help-box';
  tip.innerText = text;

  if (text.includes("window 1")) {
    tip.style.backgroundImage = "url('Images/help1.jpg')";
  } else if (text.includes("window 2")) {
    tip.style.backgroundImage = "url('Images/help2.jpg')";
  } else {
    tip.style.background = "#fff";
  }

  el.appendChild(tip);
  tip.style.display = 'block';
}

function hideTooltip(el) {
  const tip = el.querySelector('.help-box');
  if (tip) tip.remove();
}
</script>
<script>document.getElementById("reset-button").onclick = () => location.reload();</script>
<script>
function calculateSectionTotals() {
    const sectionData = {
        Scalp: 0,
        Eyebrows: 0,
        Eyelashes: 0,
        Beard: 0
    };

    for (const [id, data] of Object.entries(globalSelections)) {
        const subtotal = Array.from(data.selected).reduce((sum, val) => sum + val, 0);
        sectionData.Scalp += subtotal * (1 - data.density / 100);
    }

    sectionData.Eyebrows = [...eyebrowSelections.left, ...eyebrowSelections.right]
        .reduce((sum, val) => sum + val, 0);

    sectionData.Eyelashes = [...eyelashSelections.left, ...eyelashSelections.right]
        .reduce((sum, val) => sum + val, 0);

    for (const [id, data] of Object.entries(beardSelections)) {
        const subtotal = Array.from(data.selected).reduce((sum, val) => sum + val, 0);
        sectionData.Beard += subtotal * (1 - data.density / 100);
    }

    
    // Clamp each section to [0,100]
    for (const k of Object.keys(sectionData)) {
        sectionData[k] = Math.max(0, Math.min(100, Number(sectionData[k]) || 0));
    }

    return sectionData;
}

function getColorForSection(pct, alpha = 0.2) {
  pct = Math.min(100, Math.max(0, pct));

  let r, g, b;

  if (pct <= 50) {
    // Grey to Yellow
    const ratio = pct / 50;
    r = Math.floor(128 + (255 - 128) * ratio); // 128 → 255
    g = Math.floor(128 + (255 - 128) * ratio); // 128 → 255
    b = Math.floor(128 - 128 * ratio);         // 128 → 0
  } else {
    // Yellow to Red
    const ratio = (pct - 50) / 50;
    r = 255;
    g = Math.floor(255 * (1 - ratio));         // 255 → 0
    b = 0;
  }

  return `rgba(${r},${g},${b},${alpha})`;
}

function updateResultsSummary() {
    const totals = calculateSectionTotals();
    const resultsDiv = document.getElementById("results-summary");
    resultsDiv.innerHTML = Object.entries(totals).map(([key, val]) => {
        return `<div class="result-box" style="background-color:${getColorForSection(val)}">
            ${key}: ${val.toFixed(1)}%
        </div>`;
    }).join("");
}

setInterval(updateResultsSummary, 1000);
</script>
<div style="margin-top: 30px; text-align: center;">
<button onclick="copyCode()" style="margin: 5px;">📋 Copy Score Code</button>
<input id="codeInput" placeholder="Paste score code here" style="width: 300px; margin: 5px;"/>
<button onclick="loadCode()">📥 Load Score Code</button>
</div>
<script>
function getCurrentState() {
  const scalp = {};
  for (const [sectionId, data] of Object.entries(globalSelections)) {
    scalp[sectionId] = {
      selected: Array.from(data.selected),
      density: data.density
    };
  }

  const beard = {};
  for (const [sectionId, data] of Object.entries(beardSelections)) {
    beard[sectionId] = {
      selected: Array.from(data.selected),
      density: data.density
    };
  }

  return {
    scalp,
    eyebrows: {
      left: Array.from(eyebrowSelections.left),
      right: Array.from(eyebrowSelections.right)
    },
    eyelashes: {
      left: Array.from(eyelashSelections.left),
      right: Array.from(eyelashSelections.right)
    },
    beard
  };
}

function applyState(state) {
  if (state.scalp) {
    for (const [sectionId, data] of Object.entries(state.scalp)) {
      globalSelections[sectionId].selected = new Set(data.selected);
      globalSelections[sectionId].density = data.density;
    }
    updateScalpUI();
  }

  if (state.eyebrows) {
    eyebrowSelections.left = new Set(state.eyebrows.left);
    eyebrowSelections.right = new Set(state.eyebrows.right);
    updateEyebrowUI();
  }

  if (state.eyelashes) {
    eyelashSelections.left = new Set(state.eyelashes.left);
    eyelashSelections.right = new Set(state.eyelashes.right);
    updateEyelashUI();
  }

  if (state.beard) {
    for (const [sectionId, data] of Object.entries(state.beard)) {
      beardSelections[sectionId].selected = new Set(data.selected);
      beardSelections[sectionId].density = data.density;
    }
    updateBeardUI();
  }
}

function copyCode() {
  const state = getCurrentState();
  const json = JSON.stringify(state);
  const encoded = btoa(json);
  navigator.clipboard.writeText(encoded).then(() => {
    alert("Score code copied to clipboard!");
  });
}

function loadCode() {
  try {
    const input = document.getElementById("codeInput").value.trim();
    if (!input) return alert("Please enter a code.");
    const json = atob(input);
    const state = JSON.parse(json);
    applyState(state);
  } catch (e) {
    alert("Invalid code.");
  }
}
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const pdfButton = document.getElementById("generate-pdf");
    const iconContainer = document.getElementById("pdf-icon-container");
    const previewArea = document.getElementById("selected-preview");

    function updatePdfIconVisibility() {
        iconContainer.style.display = previewArea.children.length > 0 ? "block" : "none";
    }

    const originalUpdateSelectedPreview = updateSelectedPreview;
    updateSelectedPreview = function() {
        originalUpdateSelectedPreview();
        updatePdfIconVisibility();
    }

    if (pdfButton) {
        pdfButton.addEventListener("click", () => {
            const opt = {
                margin:       0.3,
                filename:     'alopecia_preview.pdf',
                Image:        { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, allowTaint: false, imageTimeout: 15000 },
                jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(previewArea).save();
        });
    }

    updatePdfIconVisibility();
});
</script>
<script>
/* removed previous generate-pdf listener */
});
</script>
<script>
/* removed previous generate-pdf listener */
});
</script>
<div id="floating-preview" style="position: fixed; top: 20px; right: 20px; width: 250px; height: 250px; padding: 0; margin: 0; overflow: hidden; z-index: 9999; display: none; background: none !important; border: none !important; pointer-events: none;">
<div id="floating-close-btn" style="
        position: absolute;
        top: 2px;
        right: 6px;
        font-size: 18px;
        color: #333;
        font-weight: bold;
        cursor: pointer;
        z-index: 10000;
        pointer-events: auto;
    ">×</div>
</div>


<script>
let previewVisible = true;
let floatingPreviewTimeout;

document.addEventListener("click", function (e) {
  if (e.target && e.target.id === "floating-close-btn") {
    previewVisible = false;
    document.getElementById("floating-preview").style.display = "none";
  }
});

window.addEventListener("scroll", function () {
  clearTimeout(floatingPreviewTimeout);
  const floating = document.getElementById("floating-preview");
  const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;

  if (!previewVisible) return;

  if (scrollTop > 150) {
    floatingPreviewTimeout = setTimeout(updateFloatingPreview, 10);
    if (floating) { floating.style.display = "block"; floating.style.opacity = "1"; }
  } else {
    if (floating) { floating.style.opacity = "0"; floating.style.display = "none"; }
  }
});






function updateFloatingPreview() {
  const floating = document.getElementById("floating-preview");
  if (!floating) return;

  // Preserve/restore close button
  const closeBtn = document.getElementById("floating-close-btn");
  floating.innerHTML = "";
  if (closeBtn) floating.appendChild(closeBtn.cloneNode(true));

  // Build rows from the authoritative selected-preview tiles
  const source = document.getElementById("selected-preview");
  if (!source || source.children.length === 0) return;

  // Buckets based on image URL
  const buckets = {
    scalp:   { left: [], back: [], right: [], top: [] },
    brows:   [],
    lashes:  [],
    beardR:  [], beardC: [], beardL: []
  };

  // Helper to get w/h numbers from a node
  const getWH = (el) => {
    const cs = getComputedStyle(el);
    const w = parseFloat(cs.width)  || parseFloat(el.style.width)  || 60;
    const h = parseFloat(cs.height) || parseFloat(el.style.height) || 60;
    return { w, h };
  };

  Array.from(source.children).forEach(child => {
    const style = child.style;
    const bg = style.backgroundImage || getComputedStyle(child).backgroundImage || "";
    const s  = String(bg).toLowerCase();
    if (!s || s === "none") return;

    const clone = child.cloneNode(true);
    clone.style.transform = "none";
    clone.style.transformOrigin = "top left";
    clone.style.flex = "0 0 auto";
    clone.style.borderRadius = "6px";

    if (s.includes("leftside-"))       buckets.scalp.left.push(clone);
    else if (s.includes("backside-"))  buckets.scalp.back.push(clone);
    else if (s.includes("rightside-")) buckets.scalp.right.push(clone);
    else if (s.includes("topside-"))   buckets.scalp.top.push(clone);
    else if (s.includes("eyebrow"))    buckets.brows.push(clone);
    else if (s.includes("eyelash"))    buckets.lashes.push(clone);
    else if (s.includes("right-beard"))   buckets.beardR.push(clone);
    else if (s.includes("central-beard")) buckets.beardC.push(clone);
    else if (s.includes("left-beard"))    buckets.beardL.push(clone);
  });

  // Compose rows in fixed order
  const rows = [];

  function makeRow(label, tiles) {
    if (!tiles || tiles.length === 0) return null;

    const lab = document.createElement("div");
    lab.textContent = label;
    lab.style.fontSize = "12px";
    lab.style.fontWeight = "600";
    lab.style.marginBottom = "2px";

    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.flexWrap = "nowrap";        // prevent wrapping; we'll scale to fit
    row.style.gap = "6px";
    row.style.alignItems = "flex-start";

    tiles.forEach(t => row.appendChild(t));

    const block = document.createElement("div");
    block.style.display = "flex";
    block.style.flexDirection = "column";
    block.style.alignItems = "flex-start";
    block.appendChild(lab);
    block.appendChild(row);

    // Precompute width/height for instant scale (avoid late reflow)
    const GAP = 6;
    let w = 0, h = 0;
    tiles.forEach((t, i) => {
      const { w: tw, h: th } = getWH(t);
      w += tw + (i > 0 ? GAP : 0);
      if (th > h) h = th;
    });
    block.__w = Math.max(w, lab.offsetWidth || 60);
    block.__h = h + (parseFloat(getComputedStyle(lab).lineHeight) || 14) + 2;

    return block;
  }

  // Scalp: Left, Back, Right, Top in one row
  const scalpTiles = [].concat(buckets.scalp.left, buckets.scalp.back, buckets.scalp.right, buckets.scalp.top);
  const scalpBlock = makeRow("Scalp", scalpTiles);
  if (scalpBlock) rows.push(scalpBlock);

  // Eyebrows / Eyelashes
  const browBlock = makeRow("Eyebrows", buckets.brows);
  if (browBlock) rows.push(browBlock);
  const lashBlock = makeRow("Eyelashes", buckets.lashes);
  if (lashBlock) rows.push(lashBlock);

  // Beard: Right, Central, Left
  const beardTiles = [].concat(buckets.beardR, buckets.beardC, buckets.beardL);
  const beardBlock = makeRow("Beard", beardTiles);
  if (beardBlock) rows.push(beardBlock);

  if (rows.length === 0) return;

  // Build container and compute scale BEFORE showing
  const previewInner = document.createElement("div");
  previewInner.style.display = "flex";
  previewInner.style.flexDirection = "column";
  previewInner.style.gap = "6px";
  previewInner.style.alignItems = "flex-start";
  previewInner.style.width = "max-content";
  previewInner.style.pointerEvents = "none";
  previewInner.style.visibility = "hidden";  // prevent flash

  rows.forEach(r => previewInner.appendChild(r));

  floating.appendChild(previewInner);

  // Compute required dimensions from precomputed numbers
  let totalH = 0, maxW = 0;
  rows.forEach(r => { totalH += (r.__h || 0) + 6; maxW = Math.max(maxW, r.__w || 0); });
  totalH -= 6; // remove last gap

  const pad = 16;
  const fw = floating.clientWidth || 230;
  const fh = floating.clientHeight || 300;
  const scale = Math.min((fw - pad) / maxW, (fh - pad) / totalH, 1);

  previewInner.style.transformOrigin = "top left";
  previewInner.style.transform = `scale(${scale})`;
  previewInner.style.visibility = "visible"; // reveal scaled content immediately
}
</script>





<script>
const allPreviewImages = [
  // Beard
  "Images/left-beard-0.jpg", "Images/left-beard-4.jpg", "Images/left-beard-10.jpg", "Images/left-beard-16.jpg",
  "Images/right-beard-0.jpg", "Images/right-beard-4.jpg", "Images/right-beard-10.jpg", "Images/right-beard-16.jpg",
  "Images/central-beard-0.jpg", "Images/central-beard-5.jpg", "Images/central-beard-8.jpg",

  // Eyebrow
  "Images/left-eyebrow-0.jpg", "Images/left-eyebrow-15.jpg", "Images/right-eyebrow-0.jpg", "Images/right-eyebrow-15.jpg",

  // Eyelash
  "Images/left-eyelash-0.jpg", "Images/right-eyelash-0.jpg"
];
allPreviewImages.forEach(src => {
  const img = new Image();
  img.src = src;
});
</script>


<div id="beard-floating-preview" style="
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 200px;
  max-height: 300px;
  overflow-y: auto;
  background-color: rgba(255, 255, 255, 0.95);
  border: 2px solid #0077cc;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  padding: 8px;
  display: none;
  z-index: 9999;
">
  <strong>Beard Preview</strong>
  <div id="beard-preview-content" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
</div>


<script>
function updateBeardPreview() {
  const container = document.getElementById("beard-preview-content");
  if (!container) return;
  container.innerHTML = "";

  const beardSectionsToCheck = ["left-beard", "right-beard", "central-beard"];

  beardSectionsToCheck.forEach(sectionId => {
    const areaBoxes = document.querySelectorAll(`#${sectionId}-areas .area-box`);
    areaBoxes.forEach(box => {
      const value = parseFloat(box.dataset.value);
      const style = window.getComputedStyle(box);
      const bgImage = style.backgroundImage;
      const match = bgImage.match(/url\(["']?(.*?)["']?\)/);
      if (!match) return;

      const ImageUrl = match[1];
      const isMain = box.classList.contains("selected");
      const isPlus = box.querySelector(".plus")?.classList.contains("glow") || false;
      const isMinus = box.querySelector(".minus")?.classList.contains("glow") || false;

      if (!(isMain || isPlus || isMinus)) return;

      const imgEl = document.createElement("img");
      imgEl.src = ImageUrl;
      imgEl.style.width = box.offsetWidth + "px";
      imgEl.style.height = box.offsetHeight + "px";
      imgEl.style.objectFit = "cover";
      imgEl.style.border = "2px solid #0077cc";
      imgEl.style.borderRadius = "6px";
      imgEl.style.flex = "0 0 auto";
      imgEl.loading = "eager";

      container.appendChild(imgEl);
    });
  });

  const previewBox = document.getElementById("beard-floating-preview");
  if (container.children.length > 0) {
    previewBox.style.display = "block";
  } else {
    previewBox.style.display = "none";
  }
}
</script>


<script>
// --- Added: ring meters + progress bar updater ---
function setRingPct(el, pct) {
  pct = Math.max(0, Math.min(100, Number(pct) || 0));
  el.style.background = `conic-gradient(#22c55e 0% ${pct}%, #e5e7eb ${pct}% 100%)`;
}
function updateScoreRings() {
  if (typeof calculateSectionTotals !== 'function') return;
  const totals = calculateSectionTotals();
  const entries = [
    ['Scalp', 'ring-scalp', 'ring-val-scalp'],
    ['Eyebrows','ring-eyebrows','ring-val-eyebrows'],
    ['Eyelashes','ring-eyelashes','ring-val-eyelashes'],
    ['Beard','ring-beard','ring-val-beard'],
  ];
  entries.forEach(([key, ringId, valId]) => {
    const pct = (totals && totals[key] != null) ? Number(totals[key]) : 0;
    const ring = document.getElementById(ringId);
    const val = document.getElementById(valId);
    if (ring && val) {
      setRingPct(ring, pct.toFixed(1));
      val.textContent = `${pct.toFixed(1)}%`;
    }
  });
  // also update the total scalp progress bar
  const progressBar = document.querySelector('#scalp-progress > div');
  const scalpPct = (totals && totals['Scalp'] != null) ? Number(totals['Scalp']) : 0;
  if (progressBar) progressBar.style.width = `${Math.max(0, Math.min(100, scalpPct))}%`;
}
setInterval(updateScoreRings, 700);

// --- Enhance banner title text to include scalp % dynamically (keeps existing behavior) ---
(function() {
  const origUpdate = (typeof updateScalpUI === 'function') ? updateScalpUI : null;
  if (origUpdate) {
    window.updateScalpUI = function() {
      origUpdate();
      updateScoreRings();
    };
  }
})();

// --- Replace PDF click handler to include Percentage of the areas ---
(function() {
  const oldBtn = document.getElementById("generate-pdf");
  if (!oldBtn) return;
  const newBtn = oldBtn.cloneNode(true);
  oldBtn.parentNode.replaceChild(newBtn, oldBtn);

  newBtn.addEventListener("click", function () {
    const now = new Date();
    const datetime = now.toLocaleString();
    const title = "Alopecia Areata Calculator";

    const scalp = document.getElementById("result").innerText.replace("Total Scalp Alopecia Areata: ", "");
    const eyebrows = document.getElementById("eyebrow-title").innerText.match(/\((.*?)\)/)[1];
    const eyelashes = document.getElementById("eyelash-title").innerText.match(/\((.*?)\)/)[1];
    const beard = document.getElementById("beard-title").innerText.match(/\((.*?)\)/)[1];

    function getSubtotal(selections, density = 0) {
      let total = 0;
      for (const val of selections) total += val;
      total = total * (1 - (density||0) / 100);
      return Number(total.toFixed(2));
    }

    // Subtotals (density-adjusted where applicable)
    const leftScalp = getSubtotal(globalSelections["leftside"].selected, globalSelections["leftside"].density);
    const rightScalp = getSubtotal(globalSelections["rightside"].selected, globalSelections["rightside"].density);
    const topScalp = getSubtotal(globalSelections["topside"].selected, globalSelections["topside"].density);
    const backScalp = getSubtotal(globalSelections["backside"].selected, globalSelections["backside"].density);

    const leftEyebrow = getSubtotal(eyebrowSelections.left, 0);
    const rightEyebrow = getSubtotal(eyebrowSelections.right, 0);

    const leftEyelash = getSubtotal(eyelashSelections.left, 0);
    const rightEyelash = getSubtotal(eyelashSelections.right, 0);

    const leftBeard = getSubtotal(beardSelections["left-beard"].selected, beardSelections["left-beard"].density);
    const rightBeard = getSubtotal(beardSelections["right-beard"].selected, beardSelections["right-beard"].density);
    const centralBeard = getSubtotal(beardSelections["central-beard"].selected, beardSelections["central-beard"].density);

    // Max possible per area (100% loss in that area)
    const MAX = {
      leftScalp: 17, rightScalp: 17, topScalp: 40, backScalp: 24,
      leftEyebrow: 50, rightEyebrow: 50,
      leftEyelash: 50, rightEyelash: 50,
      leftBeard: 40, rightBeard: 40, centralBeard: 20
    };

    function rel(val, max) {
      if (!max) return "0.00";
      const pct = Math.max(0, Math.min(100, (val / max) * 100));
      return pct.toFixed(2);
    }

    const summarySection = document.createElement("div");
    summarySection.id = "pdf-summary";
    summarySection.style.margin = "20px";
    summarySection.style.fontFamily = "'Segoe UI', sans-serif";
    summarySection.innerHTML = `
      <h2 style='text-align:center;'>${title}</h2>
      <p style='text-align:center;'><em>${datetime}</em></p>
      <hr/>
      <h3>Summary of Alopecia Areata Involvement</h3>
      <ul>
        <li><strong>Total Scalp:</strong> ${scalp}</li>
        <li><strong>Total Eyebrows:</strong> ${eyebrows}</li>
        <li><strong>Total Eyelashes:</strong> ${eyelashes}</li>
        <li><strong>Total Beard:</strong> ${beard}</li>
      </ul>
      <h3>Detailed Area Breakdown</h3>
      <ul>
        <li><strong>Left Scalp:</strong> ${leftScalp}% (=Percentage of the area=${rel(leftScalp, MAX.leftScalp)}%)</li>
        <li><strong>Right Scalp:</strong> ${rightScalp}% (=Percentage of the area=${rel(rightScalp, MAX.rightScalp)}%)</li>
        <li><strong>Top of the Head:</strong> ${topScalp}% (=Percentage of the area=${rel(topScalp, MAX.topScalp)}%)</li>
        <li><strong>Back of the Head:</strong> ${backScalp}% (=Percentage of the area=${rel(backScalp, MAX.backScalp)}%)</li>
        <li><strong>Left Eyebrow:</strong> ${leftEyebrow}% (=Percentage of the area=${rel(leftEyebrow, MAX.leftEyebrow)}%)</li>
        <li><strong>Right Eyebrow:</strong> ${rightEyebrow}% (=Percentage of the area=${rel(rightEyebrow, MAX.rightEyebrow)}%)</li>
        <li><strong>Left Eyelash:</strong> ${leftEyelash}% (=Percentage of the area=${rel(leftEyelash, MAX.leftEyelash)}%)</li>
        <li><strong>Right Eyelash:</strong> ${rightEyelash}% (=Percentage of the area=${rel(rightEyelash, MAX.rightEyelash)}%)</li>
        <li><strong>Left Beard Area:</strong> ${leftBeard}% (=Percentage of the area=${rel(leftBeard, MAX.leftBeard)}%)</li>
        <li><strong>Right Beard Area:</strong> ${rightBeard}% (=Percentage of the area=${rel(rightBeard, MAX.rightBeard)}%)</li>
        <li><strong>Central Beard Area:</strong> ${centralBeard}% (=Percentage of the area=${rel(centralBeard, MAX.centralBeard)}%)</li>
      </ul>
    `;

    document.body.appendChild(summarySection);
      // Ensure images can be rendered by html2canvas when loaded from another origin
      try {
        summarySection.querySelectorAll('img').forEach(img => {
          if (!img.getAttribute('crossorigin')) img.setAttribute('crossorigin', 'anonymous');
          // If images are data: URLs this has no effect, but it is safe.
        });
      } catch(e) {}
    

    html2pdf().set({
      margin: 10,
      filename: 'alopecia_areata_detailed_summary.pdf',
      html2canvas: { scale: 2, useCORS: true, allowTaint: false, imageTimeout: 15000 },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    }).from(summarySection).save().then(() => {
      document.body.removeChild(summarySection);
    });
  });
})();
</script>


<script>
// Override ring color: 0% = green (h~120), 100% = red (h~0)
(function(){
  window.setRingPct = function(el, pct) {
    pct = Math.max(0, Math.min(100, Number(pct) || 0));
    const hue = 120 - (pct * 1.2); // 120->0
    const color = `hsl(${hue}, 85%, 45%)`;
    el.style.background = `conic-gradient(${color} 0% ${pct}%, #e5e7eb ${pct}% 100%)`;
  };
})();
</script>


<script>
(function(){
  const pdfBtn = document.getElementById("generate-pdf");
  if (!pdfBtn) return;
  // Create the button
  const copyBtn = document.createElement("button");
  copyBtn.id = "copy-summary";
  copyBtn.type = "button";
  copyBtn.textContent = "Copy summary";
  copyBtn.style.marginLeft = "8px";
  copyBtn.style.padding = "8px 12px";
  copyBtn.style.border = "1px solid #cbd5e1";
  copyBtn.style.borderRadius = "8px";
  copyBtn.style.cursor = "pointer";
  copyBtn.style.background = "white";
  copyBtn.style.boxShadow = "0 1px 2px rgba(0,0,0,.05)";
  pdfBtn.insertAdjacentElement("afterend", copyBtn);

  function getTotalsAndDetails(){
    const scalp = document.getElementById("result").innerText.replace("Total Scalp Alopecia Areata: ", "");
    const eyebrows = document.getElementById("eyebrow-title").innerText.match(/\((.*?)\)/)[1];
    const eyelashes = document.getElementById("eyelash-title").innerText.match(/\((.*?)\)/)[1];
    const beard = document.getElementById("beard-title").innerText.match(/\((.*?)\)/)[1];

    function getSubtotal(selections, density = 0) {
      let total = 0;
      for (const val of selections) total += val;
      total = total * (1 - (density||0) / 100);
      return Number(total.toFixed(2));
    }

    const leftScalp = getSubtotal(globalSelections["leftside"].selected, globalSelections["leftside"].density);
    const rightScalp = getSubtotal(globalSelections["rightside"].selected, globalSelections["rightside"].density);
    const topScalp = getSubtotal(globalSelections["topside"].selected, globalSelections["topside"].density);
    const backScalp = getSubtotal(globalSelections["backside"].selected, globalSelections["backside"].density);

    const leftEyebrow = getSubtotal(eyebrowSelections.left, 0);
    const rightEyebrow = getSubtotal(eyebrowSelections.right, 0);

    const leftEyelash = getSubtotal(eyelashSelections.left, 0);
    const rightEyelash = getSubtotal(eyelashSelections.right, 0);

    const leftBeard = getSubtotal(beardSelections["left-beard"].selected, beardSelections["left-beard"].density);
    const rightBeard = getSubtotal(beardSelections["right-beard"].selected, beardSelections["right-beard"].density);
    const centralBeard = getSubtotal(beardSelections["central-beard"].selected, beardSelections["central-beard"].density);

    const MAX = {
      leftScalp: 17, rightScalp: 17, topScalp: 40, backScalp: 24,
      leftEyebrow: 50, rightEyebrow: 50,
      leftEyelash: 50, rightEyelash: 50,
      leftBeard: 40, rightBeard: 40, centralBeard: 20
    };

    function rel(val, max) {
      if (!max) return "0.00";
      const pct = Math.max(0, Math.min(100, (val / max) * 100));
      return pct.toFixed(2);
    }

    return {
      totals: { scalp, eyebrows, eyelashes, beard },
      details: {
        leftScalp, rightScalp, topScalp, backScalp,
        leftEyebrow, rightEyebrow, leftEyelash, rightEyelash,
        leftBeard, rightBeard, centralBeard
      },
      MAX, rel
    };
  }

  copyBtn.addEventListener("click", async function () {
    const now = new Date();
    const dt = now.toLocaleString();
    const { totals, details, MAX, rel } = getTotalsAndDetails();
    const lines = [];
    lines.push("Alopecia Areata Calculator");
    lines.push(dt);
    lines.push("");
    lines.push("Summary of Alopecia Areata Involvement");
    lines.push(`- Total Scalp: ${totals.scalp}`);
    lines.push(`- Total Eyebrows: ${totals.eyebrows}`);
    lines.push(`- Total Eyelashes: ${totals.eyelashes}`);
    lines.push(`- Total Beard: ${totals.beard}`);
    lines.push("");
    lines.push("Detailed Area Breakdown");
    lines.push(`- Left Scalp: ${details.leftScalp}% (=Percentage of the area=${rel(details.leftScalp, MAX.leftScalp)}%)`);
    lines.push(`- Right Scalp: ${details.rightScalp}% (=Percentage of the area=${rel(details.rightScalp, MAX.rightScalp)}%)`);
    lines.push(`- Top of the Head: ${details.topScalp}% (=Percentage of the area=${rel(details.topScalp, MAX.topScalp)}%)`);
    lines.push(`- Back of the Head: ${details.backScalp}% (=Percentage of the area=${rel(details.backScalp, MAX.backScalp)}%)`);
    lines.push(`- Left Eyebrow: ${details.leftEyebrow}% (=Percentage of the area=${rel(details.leftEyebrow, MAX.leftEyebrow)}%)`);
    lines.push(`- Right Eyebrow: ${details.rightEyebrow}% (=Percentage of the area=${rel(details.rightEyebrow, MAX.rightEyebrow)}%)`);
    lines.push(`- Left Eyelash: ${details.leftEyelash}% (=Percentage of the area=${rel(details.leftEyelash, MAX.leftEyelash)}%)`);
    lines.push(`- Right Eyelash: ${details.rightEyelash}% (=Percentage of the area=${rel(details.rightEyelash, MAX.rightEyelash)}%)`);
    lines.push(`- Left Beard Area: ${details.leftBeard}% (=Percentage of the area=${rel(details.leftBeard, MAX.leftBeard)}%)`);
    lines.push(`- Right Beard Area: ${details.rightBeard}% (=Percentage of the area=${rel(details.rightBeard, MAX.rightBeard)}%)`);
    lines.push(`- Central Beard Area: ${details.centralBeard}% (=Percentage of the area=${rel(details.centralBeard, MAX.centralBeard)}%)`);

    const text = lines.join("
");

    async function writeClipboard(t){
      try {
        await navigator.clipboard.writeText(t);
        return true;
      } catch (e) {
        // Fallback
        try {
          const ta = document.createElement("textarea");
          ta.value = t;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
          return true;
        } catch (err) {
          return false;
        }
      }
    }
    const ok = await writeClipboard(text);
    if (ok) {
      copyBtn.textContent = "Copied!";
      setTimeout(()=>copyBtn.textContent="Copy summary", 1200);
    } else {
      alert("Sorry, copying to clipboard failed.");
    }
  });
})();
</script>


<script>
document.addEventListener("DOMContentLoaded", function(){
  var pdfWrap = document.getElementById("pdf-icon-container");
  if (pdfWrap) pdfWrap.style.display = "block";
});
</script>


<script>
(function(){
  function anySelections(){
    const sel = document.querySelector('.area-box.selected');
    return !!sel;
  }
  function showFloating(force){
    const floating = document.getElementById("floating-preview");
    if (!floating) return;
    if (force || anySelections()){
      floating.style.display = "block";
      try { updateFloatingPreview && updateFloatingPreview(); } catch(e){}
    }
  }
  document.addEventListener("DOMContentLoaded", function(){
    // On load, if any selections already present, show it
    showFloating(false);

    // Observe selection changes
    const observer = new MutationObserver(()=>showFloating(false));
    observer.observe(document.body, { attributes: true, subtree: true, attributeFilter: ["class"] });

    // Also when totals update after clicks, show it
    document.body.addEventListener("click", function(e){
      if (e.target && e.target.classList && e.target.classList.contains("area-box")){
        setTimeout(()=>showFloating(false), 30);
      }
    });

    // Fallback: ensure it appears a bit after load
    setTimeout(()=>showFloating(false), 1000);
  });
})();
</script>


<script>
(function(){
  function injectCopy(){
    const pdfBtn = document.getElementById("generate-pdf");
    if (!pdfBtn) return false;
    if (document.getElementById("copy-summary")) return true;
    const copyBtn = document.createElement("button");
    copyBtn.id = "copy-summary";
    copyBtn.type = "button";
    copyBtn.textContent = "Copy summary";
    copyBtn.style.marginLeft = "8px";
    copyBtn.style.padding = "8px 12px";
    copyBtn.style.border = "1px solid #cbd5e1";
    copyBtn.style.borderRadius = "8px";
    copyBtn.style.cursor = "pointer";
    copyBtn.style.background = "white";
    copyBtn.style.boxShadow = "0 1px 2px rgba(0,0,0,.05)";
    pdfBtn.parentNode.insertBefore(copyBtn, pdfBtn.nextSibling);

    // Wire up action (re-use earlier function if present)
    function getTotalsAndDetails(){
      const scalp = document.getElementById("result").innerText.replace("Total Scalp Alopecia Areata: ", "");
      const eyebrows = document.getElementById("eyebrow-title").innerText.match(/\((.*?)\)/)[1];
      const eyelashes = document.getElementById("eyelash-title").innerText.match(/\((.*?)\)/)[1];
      const beard = document.getElementById("beard-title").innerText.match(/\((.*?)\)/)[1];

      function getSubtotal(selections, density = 0) {
        let total = 0;
        for (const val of selections) total += val;
        total = total * (1 - (density||0) / 100);
        return Number(total.toFixed(2));
      }

      const leftScalp = getSubtotal(globalSelections["leftside"].selected, globalSelections["leftside"].density);
      const rightScalp = getSubtotal(globalSelections["rightside"].selected, globalSelections["rightside"].density);
      const topScalp = getSubtotal(globalSelections["topside"].selected, globalSelections["topside"].density);
      const backScalp = getSubtotal(globalSelections["backside"].selected, globalSelections["backside"].density);

      const leftEyebrow = getSubtotal(eyebrowSelections.left, 0);
      const rightEyebrow = getSubtotal(eyebrowSelections.right, 0);

      const leftEyelash = getSubtotal(eyelashSelections.left, 0);
      const rightEyelash = getSubtotal(eyelashSelections.right, 0);

      const leftBeard = getSubtotal(beardSelections["left-beard"].selected, beardSelections["left-beard"].density);
      const rightBeard = getSubtotal(beardSelections["right-beard"].selected, beardSelections["right-beard"].density);
      const centralBeard = getSubtotal(beardSelections["central-beard"].selected, beardSelections["central-beard"].density);

      const MAX = {
        leftScalp: 17, rightScalp: 17, topScalp: 40, backScalp: 24,
        leftEyebrow: 50, rightEyebrow: 50,
        leftEyelash: 50, rightEyelash: 50,
        leftBeard: 40, rightBeard: 40, centralBeard: 20
      };

      function rel(val, max) {
        if (!max) return "0.00";
        const pct = Math.max(0, Math.min(100, (val / max) * 100));
        return pct.toFixed(2);
      }

      return {
        totals: { scalp, eyebrows, eyelashes, beard },
        details: {
          leftScalp, rightScalp, topScalp, backScalp,
          leftEyebrow, rightEyebrow, leftEyelash, rightEyelash,
          leftBeard, rightBeard, centralBeard
        },
        MAX, rel
      };
    }

    copyBtn.addEventListener("click", async function () {
      const now = new Date();
      const dt = now.toLocaleString();
      const { totals, details, MAX, rel } = getTotalsAndDetails();
      const lines = [];
      lines.push("Alopecia Areata Calculator");
      lines.push(dt);
      lines.push("");
      lines.push("Summary of Alopecia Areata Involvement");
      lines.push(`- Total Scalp: ${totals.scalp}`);
      lines.push(`- Total Eyebrows: ${totals.eyebrows}`);
      lines.push(`- Total Eyelashes: ${totals.eyelashes}`);
      lines.push(`- Total Beard: ${totals.beard}`);
      lines.push("");
      lines.push("Detailed Area Breakdown");
      lines.push(`- Left Scalp: ${details.leftScalp}% (=Percentage of the area=${rel(details.leftScalp, MAX.leftScalp)}%)`);
      lines.push(`- Right Scalp: ${details.rightScalp}% (=Percentage of the area=${rel(details.rightScalp, MAX.rightScalp)}%)`);
      lines.push(`- Top of the Head: ${details.topScalp}% (=Percentage of the area=${rel(details.topScalp, MAX.topScalp)}%)`);
      lines.push(`- Back of the Head: ${details.backScalp}% (=Percentage of the area=${rel(details.backScalp, MAX.backScalp)}%)`);
      lines.push(`- Left Eyebrow: ${details.leftEyebrow}% (=Percentage of the area=${rel(details.leftEyebrow, MAX.leftEyebrow)}%)`);
      lines.push(`- Right Eyebrow: ${details.rightEyebrow}% (=Percentage of the area=${rel(details.rightEyebrow, MAX.rightEyebrow)}%)`);
      lines.push(`- Left Eyelash: ${details.leftEyelash}% (=Percentage of the area=${rel(details.leftEyelash, MAX.leftEyelash)}%)`);
      lines.push(`- Right Eyelash: ${details.rightEyelash}% (=Percentage of the area=${rel(details.rightEyelash, MAX.rightEyelash)}%)`);
      lines.push(`- Left Beard Area: ${details.leftBeard}% (=Percentage of the area=${rel(details.leftBeard, MAX.leftBeard)}%)`);
      lines.push(`- Right Beard Area: ${details.rightBeard}% (=Percentage of the area=${rel(details.rightBeard, MAX.rightBeard)}%)`);
      lines.push(`- Central Beard Area: ${details.centralBeard}% (=Percentage of the area=${rel(details.centralBeard, MAX.centralBeard)}%)`);

      const text = lines.join("\n");

      async function writeClipboard(t){
        try {
          await navigator.clipboard.writeText(t);
          return true;
        } catch (e) {
          try {
            const ta = document.createElement("textarea");
            ta.value = t;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            document.body.removeChild(ta);
            return true;
          } catch (err) {
            return false;
          }
        }
      }
      const ok = await writeClipboard(text);
      if (ok) {
        copyBtn.textContent = "Copied!";
        setTimeout(()=>copyBtn.textContent="Copy summary", 1200);
      } else {
        alert("Sorry, copying to clipboard failed.");
      }
    });
    return true;
  }
  function tryInject(){
    if (!injectCopy()) {
      setTimeout(tryInject, 300);
    }
  }
  document.addEventListener("DOMContentLoaded", tryInject);
})();
</script>








<script>
(function(){
  function applyTransparentClickThrough(){
    const fp = document.getElementById('floating-preview');
    if (!fp) return;
    // Make the outer container fully click-through and transparent
    fp.style.background = 'transparent';
    fp.style.boxShadow = 'none';
    fp.style.border = 'none';
    fp.style.pointerEvents = 'none'; // allow clicks to pass through
    // Ensure inner wrapper doesn't capture events either
    const inner = fp.querySelector('.fp-inner');
    if (inner) {
      inner.style.pointerEvents = 'none';
      // If inner added any background in previous steps, clear it
      inner.style.background = 'transparent';
    }
  }
  document.addEventListener('DOMContentLoaded', function(){
    applyTransparentClickThrough();
    // Re-apply after autoscale/setup might tweak styles
    setTimeout(applyTransparentClickThrough, 50);
    setTimeout(applyTransparentClickThrough, 500);
  });
  // Also on window resize or DOM changes
  window.addEventListener('resize', applyTransparentClickThrough);
  new MutationObserver(applyTransparentClickThrough).observe(document.documentElement, {subtree:true, childList:true, attributes:true});
})();
</script>


<!-- MICRO-SCROLL-GLOBAL -->
<script>
(function() {
  function microScroll1px() {
    var y = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
    window.scrollTo(0, y + 1);
    window.scrollTo(0, y);
  }
  document.addEventListener('change', function(e) {
    if (e.target && e.target.closest('select, input[type="radio"], input[type="checkbox"]')) {
      microScroll1px();
    }
  }, true);
  document.addEventListener('click', function(e) {
    if (!e.target) return;
    if (e.target.closest('.area-box, .plus, .minus, button, [role="button"]')) {
      microScroll1px();
    }
  }, true);
})();
</script>


<!-- HIDE FLOATING PREVIEW ON SMALL SCREENS -->
<script>
(function() {
  function checkFloatingPreviewVisibility() {
    const floating = document.getElementById("floating-preview");
    if (!floating) return;
    if (window.innerWidth < 1500) {
      floating.style.display = "none";
    }
  }
  window.addEventListener('resize', checkFloatingPreviewVisibility);
  document.addEventListener('DOMContentLoaded', checkFloatingPreviewVisibility);
})();
</script>




<script>
/* Smooth sweep + pulse + particle burst on value change for score rings + pinned peek; improved triggers */
(function () {
  // Ensure a peek container exists
  function ensurePeekRoot() {
    let root = document.getElementById('ring-peek');
    if (!root) {
      root = document.createElement('div');
      root.id = 'ring-peek';
      document.body.appendChild(root);
    }
    return root;
  }

  // Make/update a mini ring item
  const peekItems = new Map(); // key: ring id -> {el, hideTimer}

  // Map region name to its ring id and track the active region for peeks
  const REGION_TO_RING = {
    'Scalp': 'ring-scalp',
    'Eyebrows': 'ring-eyebrows',
    'Eyelashes': 'ring-eyelashes',
    'Beard': 'ring-beard'
  };
  let currentPeekRegion = null;

  function clearNonActivePeeks() {
    const root = ensurePeekRoot();
    const keepRingId = currentPeekRegion ? REGION_TO_RING[currentPeekRegion] : null;
    for (const [rid, item] of Array.from(peekItems.entries())) {
      if (!keepRingId || rid !== keepRingId) {
        if (item.hideTimer) clearTimeout(item.hideTimer);
        item.el.remove();
        peekItems.delete(rid);
      }
    }
  }
  function setMiniRingPct(el, pct) {
    const clamped = Math.max(0, Math.min(100, pct || 0));
    const hue = 120 - (clamped * 1.2);
    el.style.background = `conic-gradient(hsl(${hue}, 85%, 50%) 0% ${clamped}%, #e5e7eb ${clamped}% 100%)`;
  }
  function showPeek(ringId, label, pct) {
    // Only show peek for the current active region, if set
    if (currentPeekRegion) {
      const keepRingId = REGION_TO_RING[currentPeekRegion] || null;
      if (keepRingId && ringId !== keepRingId) return;
    }
    const root = ensurePeekRoot();
    clearNonActivePeeks();
    let item = peekItems.get(ringId);
    if (!item) {
      const container = document.createElement('div');
      container.className = 'peek-item';
      const circle = document.createElement('div');
      circle.className = 'peek-ring';
      const textWrap = document.createElement('div');
      const title = document.createElement('div');
      title.className = 'peek-title';
      title.textContent = label;
      const value = document.createElement('div');
      value.className = 'peek-value';
      value.textContent = (pct ?? 0).toFixed ? (pct).toFixed(1) + '%' : pct + '%';
      textWrap.appendChild(title);
      textWrap.appendChild(value);
      container.appendChild(circle);
      container.appendChild(textWrap);
      root.appendChild(container);
      item = { el: container, circle, title, value, hideTimer: null };
      peekItems.set(ringId, item);
      // Click to scroll to the ring or section
      container.addEventListener('click', () => {
        let target = document.getElementById(ringId);
        if (!target) {
          // try matching section by label
          const sec = Array.from(document.querySelectorAll('section, .section, .area, fieldset')).find(el =>
            el.textContent && el.textContent.toLowerCase().includes(label.toLowerCase())
          );
          if (sec) target = sec;
        }
        if (target) target.scrollIntoView({ behavior: 'smooth', block: 'center' });
      });
    }
    item.title.textContent = label;
    item.value.textContent = (Number(pct)||0).toFixed(1) + '%';
    setMiniRingPct(item.circle, pct);

    // reset hide timer (2s)
    if (item.hideTimer) clearTimeout(item.hideTimer);
    item.el.classList.remove('hide');
    item.hideTimer = setTimeout(() => {
      item.el.classList.add('hide');
      setTimeout(() => {
        if (peekItems.get(ringId) === item) {
          item.el.remove();
          peekItems.delete(ringId);
          if (peekItems.size === 0) { currentPeekRegion = null; }
        }
      }, 260);
    }, 2000);
  }

  const previous = new Map();
  const easeOutCubic = t => 1 - Math.pow(1 - t, 3);
  function numberTween(from, to, t) { return from + (to - from) * t; }
  function burst(ringEl, colorHue) {
    const n = 12;
    for (let i = 0; i < n; i++) {
      const s = document.createElement('span');
      s.className = 'particle';
      const theta = (i * (360 / n)) + (Math.random() * 10 - 5);
      s.style.setProperty('--theta', theta + 'deg');
      s.style.setProperty('--time', (320 + Math.random() * 240) + 'ms');
      s.style.background = `hsl(${colorHue}, 85%, 50%)`;
      ringEl.appendChild(s);
      setTimeout(() => s.remove(), 700);
    }
  }
  function hueForPct(pct) { return 120 - (pct * 1.2); }

  // Animate a single ring to target percentage; 'label' used for peek
  function animateRingTo(ringEl, valueEl, targetPct, label) {
    const to = Math.max(0, Math.min(100, Number(targetPct) || 0));
    const from = previous.has(ringEl) ? previous.get(ringEl) : 0;

    // If difference is extremely small, still update text & peek so user sees feedback
    if (Math.abs(to - from) < 0.001) {
      if (typeof setRingPct === 'function') setRingPct(ringEl, to);
      if (valueEl) valueEl.textContent = to.toFixed(1) + '%';
      showPeek(ringEl.id || label, label, to);
      previous.set(ringEl, to);
      return;
    }

    const increasing = to > from;
    const overshoot = increasing ? Math.min(100, to + Math.min(8, (to - from) * 0.25)) : to;

    ringEl.classList.remove('flash'); void ringEl.offsetWidth; ringEl.classList.add('flash');

    const start = performance.now();
    const duration = 850;

    function frame(now) {
      const t = Math.min(1, (now - start) / duration);
      const k = easeOutCubic(t);
      const current = numberTween(from, overshoot, k);
      if (typeof setRingPct === 'function') setRingPct(ringEl, current);
      const shown = numberTween(from, to, k);
      if (valueEl) valueEl.textContent = shown.toFixed(1) + '%';

      // Always mirror progress into the peek widget
      showPeek(ringEl.id || label, label, shown);

      if (t < 1) requestAnimationFrame(frame);
      else {
        if (typeof setRingPct === 'function') setRingPct(ringEl, to);
        previous.set(ringEl, to);
        burst(ringEl, hueForPct(to));
        showPeek(ringEl.id || label, label, to);
      }
    }
    requestAnimationFrame(frame);
  }

  const originalUpdate = window.updateScoreRings;
  window.updateScoreRings = function () {
    if (typeof calculateSectionTotals !== 'function') { if (typeof originalUpdate === 'function') try{originalUpdate()}catch{}; return; }
    const totals = calculateSectionTotals();
    const entries = [
      ['Scalp',     'ring-scalp',     'ring-val-scalp'],
      ['Eyebrows',  'ring-eyebrows',  'ring-val-eyebrows'],
      ['Eyelashes', 'ring-eyelashes', 'ring-val-eyelashes'],
      ['Beard',     'ring-beard',     'ring-val-beard'],
    ];
    entries.forEach(([key, ringId, valId]) => {
      const ring = document.getElementById(ringId);
      const val  = document.getElementById(valId);
      if (!ring || !val) return;
      const pct = (totals && totals[key] != null) ? Number(totals[key]) : 0;
      animateRingTo(ring, val, pct, key);
    });

    const progressBar = document.querySelector('#scalp-progress > div');
    if (progressBar) {
      const scalpPct = (totals && totals['Scalp'] != null) ? Number(totals['Scalp']) : 0;
      progressBar.style.width = `${Math.max(0, Math.min(100, scalpPct))}%`;
    }

    if (typeof originalUpdate === 'function') { try { originalUpdate(); } catch {} }
  };

  // Heuristic: detect which region the user is interacting with from the event target
  
  
function detectRegionFromEventTarget(t) {
  // Compose a broad string from the element and a nearby container
  const s = (
    (t.id||'') + ' ' + (t.name||'') + ' ' + (t.className||'') + ' ' +
    (t.getAttribute && (t.getAttribute('aria-label')||'')) + ' ' +
    (t.closest && (t.closest('section, fieldset, .section, .area, .card')?.textContent||''))
  ).toLowerCase();

  // Quick text checks
  if (s.includes('eyebrow') || s.includes('brow')) return 'Eyebrows';
  if (s.includes('eyelash') || s.includes('eyelid')) return 'Eyelashes';
  if (s.includes('beard')) return 'Beard';
  if (s.includes('scalp')) return 'Scalp';

  // Ancestor id/class checks
  if (t.closest('[id*="eyebrow" i], [class*="eyebrow" i], [aria-label*="eyebrow" i]')) return 'Eyebrows';
  if (t.closest('[id*="eyelash" i], [class*="eyelash" i], [aria-label*="eyelash" i], [id*="eyelid" i], [class*="eyelid" i]')) return 'Eyelashes';
  if (t.closest('[id*="beard" i], [class*="beard" i], [aria-label*="beard" i]')) return 'Beard';

  // Scalp sections use ids without the word "scalp" (backside/leftside/rightside/topside).
  // Detect those.
  if (t.closest('[id*="backside" i], [id*="leftside" i], [id*="rightside" i], [id*="topside" i]')) return 'Scalp';
  if (t.closest('[id$="-density" i]')) {
    const id = (t.closest('[id$="-density" i]')?.id||'').toLowerCase();
    if (/(backside|leftside|rightside|topside)-density/.test(id)) return 'Scalp';
  }

  return null;
}



  



function showImmediatePeekFor(region) {
  const map = {
    'Scalp':     ['ring-scalp',     'ring-val-scalp'],
    'Eyebrows':  ['ring-eyebrows',  'ring-val-eyebrows'],
    'Eyelashes': ['ring-eyelashes', 'ring-val-eyelashes'],
    'Beard':     ['ring-beard',     'ring-val-beard'],
  };
  const pair = map[region];
  if (!pair) return;
  const [ringId, valId] = pair;
  const ring = document.getElementById(ringId);
  const val  = document.getElementById(valId);
  if (!ring || !val) return;

  // Authoritative target from calculation
  let target = 0;
  try {
    if (typeof calculateSectionTotals === 'function') {
      const totals = calculateSectionTotals();
      if (totals && totals[region] != null) target = Number(totals[region]) || 0;
      else target = 0;
    } else {
      target = parseFloat((val.textContent||'0').replace('%','')) || 0;
    }
  } catch(_) {
    target = parseFloat((val.textContent||'0').replace('%','')) || 0;
  }

  // Show peek immediately and then animate ring/text
  try { showPeek(ringId, region, target); } catch(_){}
  if (typeof animateRingTo === 'function') {
    try { animateRingTo(ring, val, target, region); } catch(_){}
  }
}

['input','change','click'].forEach(evt => {
  document.addEventListener(evt, (e) => {
    const region = detectRegionFromEventTarget(e.target);
    if (!region) return;
    currentPeekRegion = region;
    clearNonActivePeeks();
    // Defer until after native handlers (toggle* functions) complete
    const run = () => {
      if (typeof window.updateScoreRings === 'function') {
        try { window.updateScoreRings(); } catch {}
      }
      showImmediatePeekFor(region);
    };
    if ('requestAnimationFrame' in window) {
      requestAnimationFrame(() => setTimeout(run, 0));
    } else {
      setTimeout(run, 0);
    }
  }, false); // listen in bubbling phase
});


  window.addEventListener('DOMContentLoaded', () => {
    [['ring-scalp','ring-val-scalp','Scalp'],['ring-eyebrows','ring-val-eyebrows','Eyebrows'],
     ['ring-eyelashes','ring-val-eyelashes','Eyelashes'],['ring-beard','ring-val-beard','Beard']]
      .forEach(([rid, vid]) => {
        const r = document.getElementById(rid);
        const v = document.getElementById(vid);
        if (r && v) {
          const n = parseFloat((v.textContent || '0').replace('%','')) || 0;
          previous.set(r, n);
        }
      });
  });
})();
</script>




<script>
(function(){
  ));
    }
    
    catch (err) {
            // Tainted canvas; hide the image to avoid blocking export
            img.style.display = 'none';
          }
        } catch (e) {
          img.style.display = 'none';
        }
      }
    }

    async function buildAndSavePdf(e){
    try{
      if (e) { e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation(); }
      if (window.__pdfRunning) return;
      window.__pdfRunning = true;

      const now = new Date();
      const datetime = now.toLocaleString();
      const title = "Alopecia Areata Calculator";

      const scalp = (document.getElementById("result")?.innerText || "").replace("Total Scalp Alopecia Areata: ", "");
      const eyebrows = (document.getElementById("eyebrow-title")?.innerText.match(/\((.*?)\)/)||[, "0.00%"])[1];
      const eyelashes = (document.getElementById("eyelash-title")?.innerText.match(/\((.*?)\)/)||[, "0.00%"])[1];
      const beard = (document.getElementById("beard-title")?.innerText.match(/\((.*?)\)/)||[, "0.00%"])[1];

      function getSubtotal(selections, density){
        let total = 0;
        if (selections && typeof selections.forEach === "function") {
          selections.forEach(v => total += Number(v) * (1 - Number(density||0)/100));
        } else if (Array.isArray(selections)) {
          selections.forEach(v => total += Number(v) * (1 - Number(density||0)/100));
        }
        return total.toFixed(2);
      }

      
      const MAX = {
        leftScalp: 17, rightScalp: 17, topScalp: 40, backScalp: 24,
        leftEyebrow: 50, rightEyebrow: 50,
        leftEyelash: 50, rightEyelash: 50,
        leftBeard: 40, rightBeard: 40, centralBeard: 20
      };
      function rel(val, max){ try { return ( (Number(val)||0) / (Number(max)||1) * 100 ).toFixed(2); } catch(e){ return "0.00"; } }
    const leftScalp  = getSubtotal((globalSelections?.leftside||{}).selected,  globalSelections?.leftside?.density);
      const rightScalp = getSubtotal((globalSelections?.rightside||{}).selected, globalSelections?.rightside?.density);
      const topScalp   = getSubtotal((globalSelections?.topside||{}).selected,   globalSelections?.topside?.density);
      const backScalp  = getSubtotal((globalSelections?.backside||{}).selected,  globalSelections?.backside?.density);

      const leftEyebrow  = getSubtotal(eyebrowSelections?.left, 0);
      const rightEyebrow = getSubtotal(eyebrowSelections?.right, 0);

      const leftEyelash  = getSubtotal(eyelashSelections?.left, 0);
      const rightEyelash = getSubtotal(eyelashSelections?.right, 0);

      const leftBeard    = getSubtotal(beardSelections?.["left-beard"]?.selected,    beardSelections?.["left-beard"]?.density);
      const rightBeard   = getSubtotal(beardSelections?.["right-beard"]?.selected,   beardSelections?.["right-beard"]?.density);
      const centralBeard = getSubtotal(beardSelections?.["central-beard"]?.selected, beardSelections?.["central-beard"]?.density);

      const summarySection = document.createElement("div");
      summarySection.id = "pdf-summary";
      summarySection.style.margin = "20px";
      summarySection.style.fontFamily = "'Segoe UI', sans-serif";
      summarySection.innerHTML = `
        <h2 style='text-align:center;'>${title}</h2>
        <p style='text-align:center;'><em>${datetime}</em></p>
        <hr/>
        <h3>Summary of Alopecia Areata Involvement</h3>
        <ul>
          <li><strong>Total Scalp:</strong> ${scalp}</li>
          <li><strong>Total Eyebrows:</strong> ${eyebrows}</li>
          <li><strong>Total Eyelashes:</strong> ${eyelashes}</li>
          <li><strong>Total Beard:</strong> ${beard}</li>
        </ul>
        <h3>Detailed Area Breakdown</h3>
        <table id="detail-table" style="width:100%;border-collapse:collapse;">
          <tr><td style="border:1px solid #ccc;padding:6px;">Left Scalp</td><td style="border:1px solid #ccc;padding:6px;">${leftScalp}% (Percentage of the area: ${rel(leftScalp, MAX.leftScalp)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Right Scalp</td><td style="border:1px solid #ccc;padding:6px;">${rightScalp}% (Percentage of the area: ${rel(rightScalp, MAX.rightScalp)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Top of the Head</td><td style="border:1px solid #ccc;padding:6px;">${topScalp}% (Percentage of the area: ${rel(topScalp, MAX.topScalp)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Back of the Head</td><td style="border:1px solid #ccc;padding:6px;">${backScalp}% (Percentage of the area: ${rel(backScalp, MAX.backScalp)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Left Eyebrow</td><td style="border:1px solid #ccc;padding:6px;">${leftEyebrow}% (Percentage of the area: ${rel(leftEyebrow, MAX.leftEyebrow)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Right Eyebrow</td><td style="border:1px solid #ccc;padding:6px;">${rightEyebrow}% (Percentage of the area: ${rel(rightEyebrow, MAX.rightEyebrow)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Left Eyelash</td><td style="border:1px solid #ccc;padding:6px;">${leftEyelash}% (Percentage of the area: ${rel(leftEyelash, MAX.leftEyelash)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Right Eyelash</td><td style="border:1px solid #ccc;padding:6px;">${rightEyelash}% (Percentage of the area: ${rel(rightEyelash, MAX.rightEyelash)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Left Beard Area</td><td style="border:1px solid #ccc;padding:6px;">${leftBeard}% (Percentage of the area: ${rel(leftBeard, MAX.leftBeard)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Right Beard Area</td><td style="border:1px solid #ccc;padding:6px;">${rightBeard}% (Percentage of the area: ${rel(rightBeard, MAX.rightBeard)}%)</td></tr>
          <tr><td style="border:1px solid #ccc;padding:6px;">Central Beard Area</td><td style="border:1px solid #ccc;padding:6px;">${centralBeard}% (Percentage of the area: ${rel(centralBeard, MAX.centralBeard)}%)</td></tr>
        </table>
        `;

      const preview = document.getElementById("selected-preview")?.cloneNode(true);
      document.body.appendChild(summarySection);
      // Ensure images can be rendered by html2canvas when loaded from another origin
      try {
        summarySection.querySelectorAll('img').forEach(img => {
          if (!img.getAttribute('crossorigin')) img.setAttribute('crossorigin', 'anonymous');
          // If images are data: URLs this has no effect, but it is safe.
        });
      } catch(e) {}
    
      html2pdf().set({
        margin: 10,
        filename: 'alopecia_areata_summary_with_details.pdf',
        html2canvas: { scale: 2, useCORS: true, allowTaint: false, imageTimeout: 15000 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      }).from(summarySection).save()
      .then(() => { /* success */ })
      .catch((err) => { console && console.warn && console.warn('PDF export failed:', err); })
      .finally(() => { try { document.body.removeChild(summarySection); } catch(e) {} window.__pdfRunning = false; });
    }catch(err){ window.__pdfRunning = false; }
    return false;
  }

  function install(){
    const btn = document.getElementById("generate-pdf");
    if (!btn) return;
    const clone = btn.cloneNode(true); // strips all listeners
    btn.parentNode.replaceChild(clone, btn);
    clone.addEventListener("click", (ev)=>{ buildAndSavePdf(ev); }, true); // capture
  }

  if (document.readyState === "complete" || document.readyState === "interactive") {
    setTimeout(install, 0);
  } else {
    document.addEventListener("DOMContentLoaded", install);
  }
})();
</script>

</body></html>
